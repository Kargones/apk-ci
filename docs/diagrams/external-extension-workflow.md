# Процесс разработки внешнего расширения для баз 1С

## Обзор процесса

Данный документ описывает жизненный цикл разработки и распространения внешних расширений для информационных баз 1С:Предприятие. Процесс охватывает:
- Разработку расширения в среде EDT
- Управление версиями через Git
- Автоматическую публикацию через релизы
- Распространение в проекты-подписчики
- Выбор варианта для использования в gitops

---

## Диаграмма активности

Диаграмма активности показывает основные этапы и точки принятия решений в процессе разработки и публикации расширения.

```mermaid
flowchart TD
    subgraph Разработка["Фаза разработки"]
        A[Начало разработки расширения] --> B[Создание ветки tXXXXXX]
        B --> C[Разработка в EDT]
        C --> D{Функционал готов?}
        D -->|Нет| C
        D -->|Да| E[Создание запроса на слияние в main]
    end

    subgraph Ревью["Фаза ревью"]
        E --> F{Code Review пройден?}
        F -->|Нет| G[Исправление замечаний]
        G --> C
        F -->|Да| H[Слияние в ветку main]
    end

    subgraph Релиз["Фаза релиза"]
        H --> I[Создание релиза с версией-датой]
        I --> J[/Автоматический запуск CI/]
        J --> K[Конвертация EDT → XML]
        J --> L[Публикация в проекты-подписчики]
    end

    subgraph Хранилище["Работа с хранилищем"]
        K --> M[Помещение в хранилище расширения]
        M --> N[Использование через КИП]
    end

    subgraph Подписчики["Распространение_подписчикам"]
        L --> O[Поиск веток-подписок в репозиториях]
        O --> P{Найдены подписчики?}
        P -->|Нет| Q[Завершение]
        P -->|Да| R[Обновление ВеткиРасширения]
        R --> S[Создание PR в main проекта]
        S --> T{Релиз-менеджер принял PR?}
        T -->|Нет| U[Ожидание решения]
        U --> T
        T -->|Да| V[Слияние в main проекта]
    end

    subgraph Использование["Использование расширения"]
        V --> W{Способ использования?}
        W -->|Стандартный| X[Сборка с расширением]
        W -->|Альтернативный| Y[Исключение из сборки]
        Y --> Z[Подключение из единого хранилища]
        X --> AA[Разработчики обновляют свои ветки]
        Z --> AA
        AA --> AB[Конец]
    end

    N --> AB
    Q --> AB
```

### Описание этапов диаграммы активности

| Этап | Описание |
|------|----------|
| **Создание ветки tXXXXXX** | Ветка разработки именуется по номеру заявки на изменение (ЗнИ) в системе Интрасервис |
| **Разработка в EDT** | Работа ведётся в 1C:EDT с минимально необходимым набором объектов метаданных |
| **Code Review** | Проверка кода перед слиянием в основную ветку |
| **Создание релиза** | Версия релиза соответствует планируемой дате выпуска |
| **Конвертация EDT → XML** | Автоматическое преобразование формата для совместимости с хранилищем |
| **Поиск веток-подписок** | Поиск веток формата `<Org>_<Repo>_<Dir>` в репозиториях проектов |
| **Альтернативный способ** | Расширение исключается из сборки проекта, но добавляется из единого хранилища при обновлении баз |

---

## Диаграмма последовательности

Диаграмма последовательности показывает взаимодействие между участниками и системами в процессе публикации расширения.

```mermaid
sequenceDiagram
    autonumber

    participant Dev as Разработчик<br/>расширения
    participant EDT as 1C:EDT
    participant Git as Git репозиторий<br/>расширения
    participant CI as CI/CD система
    participant Store as Хранилище 1С
    participant ProjRepo as Репозиторий<br/>проекта
    participant RM as Релиз-менеджер
    participant ProjDev as Разработчик<br/>проекта

    Note over Dev,ProjDev: Фаза разработки расширения

    Dev->>Git: Создание ветки tXXXXXX
    Dev->>EDT: Разработка расширения

    loop Цикл разработки
        Dev->>EDT: Написание кода
        EDT->>Git: Коммит изменений
    end

    Dev->>Git: Создание Pull Request в main
    Git-->>Dev: Уведомление о ревью
    Dev->>Git: Исправление замечаний (при необходимости)
    Git->>Git: Слияние в main

    Note over Dev,ProjDev: Фаза создания релиза

    Dev->>Git: Создание релиза (версия = дата)
    Git->>CI: Триггер: новый релиз создан

    par Параллельные процессы
        CI->>Git: Конвертация EDT → XML
        Git->>Store: Помещение в хранилище расширения
        Store-->>CI: Подтверждение
    and
        CI->>ProjRepo: Поиск веток-подписок
        ProjRepo-->>CI: Список веток <Org>_<Repo>_<Dir>
    end

    Note over Dev,ProjDev: Фаза распространения подписчикам

    loop Для каждого проекта-подписчика
        CI->>ProjRepo: Обновление ВеткиРасширения
        CI->>ProjRepo: Создание Pull Request в main
        ProjRepo-->>RM: Уведомление о новом PR
        RM->>ProjRepo: Проверка и принятие PR
        ProjRepo->>ProjRepo: Слияние в main
        ProjRepo-->>ProjDev: Уведомление об обновлении
    end

    Note over Dev,ProjDev: Фаза использования расширения

    alt Стандартный способ
        ProjDev->>Git: Обновление рабочей ветки из main
        ProjDev->>CI: Запуск сборки с расширением
    else Альтернативный способ
        ProjDev->>ProjRepo: Добавление в исключаемые файлы
        ProjDev->>ProjRepo: Добавление во внешние расширения
        CI->>Store: Получение расширения при обновлении БД
    end
```

### Описание взаимодействий

#### Участники процесса

| Участник | Роль |
|----------|------|
| **Разработчик расширения** | Создаёт и поддерживает код расширения |
| **1C:EDT** | Среда разработки для расширений 1С |
| **Git репозиторий расширения** | Хранение исходного кода расширения |
| **CI/CD система** | Автоматизация сборки и публикации |
| **Хранилище 1С** | Хранилище конфигурации для баз без DevOps |
| **Репозиторий проекта** | Git репозиторий проекта-подписчика |
| **Релиз-менеджер** | Принимает решения о включении расширений в проекты |
| **Разработчик проекта** | Использует расширение в своём проекте |

#### Ключевые взаимодействия

1. **Шаги 1-6**: Стандартный цикл разработки с использованием Git Flow
2. **Шаги 7-9**: Создание релиза запускает автоматические процессы
3. **Шаги 10-12**: Параллельное выполнение конвертации и поиска подписчиков
4. **Шаги 13-18**: Цикл публикации для каждого проекта-подписчика
5. **Шаги 19-23**: Два варианта использования расширения в проекте

---

## Формат ветки-подписки

Ветка-подписка в репозитории проекта имеет следующий формат:

```
<Имя_организации>_<Имя_репозитория>_<Имя_каталога>
```

### Пример

Если расширение находится в:
- Организация: `lib`
- Репозиторий: `apk_ssl`
- Каталог: `АПК_БСП`

То ветка-подписка будет называться: `lib_apk_ssl_АПК_БСП`

---

## Варианты использования расширения

### Стандартный вариант

Расширение включается в сборку проекта и обрабатывается вместе с остальными компонентами:
1. Расширение находится в каталоге расширений проекта
2. При сборке конфигурации расширение компилируется
3. Для расширения создаётся отдельное хранилище

Приемущества стандартного варианта:
- Упрощение управления версиями расширения
- Проверка применимости расширения при сборке проекта
- Удобство включения расширения в проект
- Возможность внесения экстренных изменений в расширение без влияния на остальные проекты

### Альтернативный вариант

Расширение исключается из сборки проекта, но используется из единого хранилища:

1. **Исключение из сборки**: Расширение добавляется в список исключаемых файлов проекта
2. **Подключение внешних расширений**: Расширение добавляется в список внешних расширений
3. **Результат**: При обновлении тестовой и продуктивной базы расширение подключается из единого хранилища

Преимущества альтернативного варианта:
- Не требуется дополнительное хранилище для каждого проекта
- Единая точка управления версией расширения
- Упрощение процесса обновления

Недостатки альтернативного варианта:
- Усложнение управления версиями расширения
- Риск нарушения согласованности конфигурации при обновлении базы
- Усложнение отладки расширения, так как оно находится в отдельном хранилище
- Необходимость доработки CI/CD системы для поддержки альтернативного варианта

## Вывод

Рекомендуется использовать стандартный вариант как унифицированное решение для всех типов расширений.
Желательно не использовать в названиях общих расширений кириллицу, чтобы избежать возможных проблем с кодировкой.