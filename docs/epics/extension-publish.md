# EPIC: Extension Publish — Автоматическая публикация расширений

## Описание

Реализовать команду `extension-publish`, которая при создании релиза в репозитории расширения автоматически распространяет обновлённую версию во все "подписанные" репозитории через механизм веток-подписок.

## Бизнес-ценность

- Автоматизация рутинной операции распространения расширений
- Единый источник истины для версии расширения
- Прозрачный процесс обновления через Pull Requests
- Снижение человеческих ошибок при ручном копировании

## Триггер запуска

- **Event:** `on: release` (Gitea Actions)
- **Режим:** Только автоматический (при создании релиза)

## Механизм подписки

Репозиторий-потребитель создаёт ветку с именем: `{ОргРасширения}_{РепоРасширения}_{КаталогРасширения}`

**Пример:** Репозиторий расширения `myorg/myproject.MyExtension` → ветка подписки `myorg_myproject.MyExtension_MyExtension`

## Входные данные

| Параметр | Источник |
|----------|----------|
| `GITEA_TOKEN` | Переменная окружения |
| `org/repo` | Переменная окружения (текущий репозиторий) |
| `ProjectName` | Результат `AnalyzeProject()` — каталог ДО точки |
| `ExtensionName` (AddArray) | Результат `AnalyzeProject()` — каталог ПОСЛЕ точки |
| Release tag + notes | Gitea API (`GetLatestRelease()`) |

## Ключевые решения

| Требование | Решение |
|------------|---------|
| Область сканирования | Все доступные репозитории через токен |
| Обработка конфликтов | Источник истины — репозиторий расширения, полная синхронизация |
| Версионирование | Номер релиза = версия расширения |
| Триггер запуска | Только при создании release (автоматически) |

---

## User Stories

### Story 1: Расширение Gitea API для работы с релизами

**Как** система,
**я хочу** получать информацию о релизах через Gitea API,
**чтобы** использовать данные релиза для формирования PR.

**Acceptance Criteria:**

- [ ] Создана структура `Release` в `internal/entity/gitea/types.go`
- [ ] Реализован метод `GetLatestRelease() (*Release, error)`
- [ ] Реализован метод `GetReleaseByTag(tag string) (*Release, error)`
- [ ] Методы добавлены в интерфейс `APIInterface`
- [ ] Unit-тесты с mock-сервером

**Технические детали:**

```go
type Release struct {
    ID        int64     `json:"id"`
    TagName   string    `json:"tag_name"`
    Name      string    `json:"name"`
    Body      string    `json:"body"`      // Release notes
    HTMLURL   string    `json:"html_url"`  // Ссылка на релиз
    CreatedAt time.Time `json:"created_at"`
}
```

---

### Story 2: Расширение Gitea API для поиска репозиториев

**Как** система,
**я хочу** получить список всех доступных репозиториев,
**чтобы** найти подписанные на расширение репозитории.

**Acceptance Criteria:**

- [ ] Реализован метод `SearchAllRepos() ([]Repository, error)`
- [ ] Поддержка пагинации (все репозитории, не только первая страница)
- [ ] Метод добавлен в интерфейс `APIInterface`
- [ ] Unit-тесты

**API Endpoint:** `GET /api/v1/repos/search?limit=50&page=N`

---

### Story 3: Поиск подписанных репозиториев

**Как** система,
**я хочу** найти все репозитории с веткой-подпиской,
**чтобы** определить куда публиковать расширение.

**Acceptance Criteria:**

- [ ] Формируется паттерн поиска: `{org}_{repo}_{extensionDir}`
- [ ] Для каждого репозитория проверяется наличие ветки по паттерну
- [ ] Возвращается список репозиториев с совпадающими ветками
- [ ] Логирование найденных подписок

**Алгоритм:**

1. Вызвать `AnalyzeProject()` → получить `ProjectName` и `AddArray[0]` (имя расширения)
2. Сформировать паттерн: `{Owner}_{Repo}_{ExtensionName}`
3. Вызвать `SearchAllRepos()` → список всех репозиториев
4. Для каждого репозитория вызвать `GetBranches(repo)` → проверить наличие ветки по паттерну

---

### Story 4: Синхронизация каталога расширения

**Как** система,
**я хочу** обновить содержимое каталога расширения в целевом репозитории,
**чтобы** привести его в соответствие с текущей версией.

**Acceptance Criteria:**

- [ ] Checkout ветки-подписки в целевом репозитории
- [ ] Полная очистка каталога расширения (источник истины — текущий репо)
- [ ] Копирование всех файлов из каталога расширения текущего репо
- [ ] Commit с сообщением: `"Обновление расширения {ExtName} до версии {Tag}"`
- [ ] Push изменений в ветку-подписку

**Важно:** Использовать существующий метод `SetRepositoryState()` для batch-операций с файлами.

---

### Story 5: Создание Pull Request с полной информацией

**Как** релиз-менеджер,
**я хочу** получить PR с полной информацией о релизе,
**чтобы** принять обоснованное решение о слиянии.

**Acceptance Criteria:**

- [ ] PR создаётся из ветки-подписки в `main`
- [ ] Заголовок PR: `"Обновление расширения {ExtName} до версии {Tag}"`
- [ ] Тело PR содержит:
  - Версия расширения (tag)
  - Release notes (body из релиза)
  - Ссылка на релиз в репозитории расширения
  - Changelog (если есть)
- [ ] Использовать существующий метод `CreatePR()` с расширением параметров

**Формат тела PR:**

```markdown
## Обновление расширения {ExtensionName}

**Версия:** {Tag}
**Источник:** [{Org}/{Repo}]({ReleaseURL})

### Release Notes
{ReleaseBody}

---
*Автоматически создано командой extension-publish*
```

---

### Story 6: Интеграция команды extension-publish

**Как** CI/CD система,
**я хочу** вызывать команду `extension-publish`,
**чтобы** автоматизировать процесс публикации при релизе.

**Acceptance Criteria:**

- [ ] Добавлена константа `CmdExtensionPublish = "extension-publish"` в `internal/constants/constants.go`
- [ ] Реализована функция `ExtensionPublish()` в `internal/app/`
- [ ] Добавлен case в switch `cmd/apk-ci/main.go`
- [ ] Команда корректно обрабатывает отсутствие подписок (не ошибка)
- [ ] Логирование всех операций

**Переменные окружения:**

- `BR_COMMAND=extension-publish`
- `GITEA_TOKEN` — токен доступа
- `GITHUB_REPOSITORY` или `BR_REPO` — текущий репозиторий

---

### Story 7: Обработка ошибок и отчётность

**Как** DevOps инженер,
**я хочу** получать детальный отчёт о публикации,
**чтобы** понимать результат операции.

**Acceptance Criteria:**

- [ ] Continue on error — ошибка в одном репо не блокирует остальные
- [ ] Итоговый отчёт в логе:
  - Количество найденных подписок
  - Успешно обновлено: N репозиториев
  - Ошибки: список с причинами
  - Созданные PR: список со ссылками
- [ ] Exit code 0 если хотя бы один PR создан успешно
- [ ] Exit code 1 если все операции завершились ошибкой

---

### Story 8: Unit и Integration тесты

**Как** разработчик,
**я хочу** иметь надёжное тестовое покрытие,
**чтобы** безопасно вносить изменения.

**Acceptance Criteria:**

- [ ] Unit-тесты для новых методов Gitea API (mock HTTP)
- [ ] Unit-тесты для логики поиска подписок
- [ ] Integration test с httptest сервером
- [ ] Покрытие новых функций >80%
- [ ] Тесты добавлены в CI pipeline

---

## Архитектурные решения

### Расположение кода

| Файл | Содержимое |
|------|------------|
| `internal/constants/constants.go` | Константа команды `CmdExtensionPublish` |
| `internal/entity/gitea/gitea.go` | Новые методы API |
| `internal/entity/gitea/types.go` | Структура `Release`, `Repository` |
| `internal/app/extension_publish.go` | Основная логика команды |
| `cmd/apk-ci/main.go` | Точка входа (case в switch) |

### Зависимости от существующего кода

- `Config.AnalyzeProject()` — получение имени проекта и расширения
- `GetBranches()` — проверка веток в репозиториях
- `SetRepositoryState()` — batch-операции с файлами
- `CreatePR()` — создание Pull Request (требует расширения параметров)

---

## Диаграмма потока

```
[Релиз в репо расширения]
         ↓
[Gitea Action: extension-publish]
         ↓
[AnalyzeProject() → имя расширения]
         ↓
[GetLatestRelease() → данные релиза]
         ↓
[SearchAllRepos() → все репозитории]
         ↓
[Для каждого репо: GetBranches() → поиск подписки]
         ↓
[Найдены подписки?] ──NO──→ [Завершение, нет подписчиков]
         ↓ YES
[Для каждой подписки:]
    ├→ [Синхронизация каталога]
    ├→ [Commit + Push]
    └→ [CreatePR с release notes]
         ↓
[Итоговый отчёт]
```

---

## Risk Assessment

| Риск | Вероятность | Импакт | Митигация |
|------|-------------|--------|-----------|
| Массовое изменение репозиториев | Средняя | Высокий | Dry-run режим, детальное логирование |
| API rate limits Gitea | Низкая | Средний | Пагинация, задержки между запросами |
| Ошибка в одном репо блокирует остальные | Средняя | Высокий | Continue on error, отчёт в конце |
| Неверный паттерн ветки | Низкая | Средний | Валидация формата, логирование |

---

## Критерии готовности (Definition of Done)

- [ ] Все Acceptance Criteria выполнены
- [ ] Code review пройден
- [ ] Unit-тесты написаны и проходят
- [ ] Документация обновлена
- [ ] Команда работает в Gitea Actions workflow
- [ ] Протестировано на тестовом окружении

---

## Пример использования

### Gitea Actions Workflow

```yaml
name: Publish Extension

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Publish extension to subscribers
        uses: docker://your-registry/apk-ci:latest
        env:
          BR_COMMAND: extension-publish
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
```

### Создание подписки в целевом репозитории

```bash
# В репозитории-потребителе создать ветку подписки
git checkout -b myorg_myproject.MyExtension_MyExtension
git push origin myorg_myproject.MyExtension_MyExtension
```

После этого при каждом релизе в `myorg/myproject.MyExtension` будет автоматически создаваться PR в целевом репозитории.
