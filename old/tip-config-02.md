# План выполнения рефакторинга конфигурации (refact-config-05)

## Обзор задачи
Рефакторинг структуры конфигурационных файлов для системы восстановления баз данных с переносом полей между файлами и реализацией алгоритма автоматического определения серверов источника и назначения.

## Этапы выполнения

### 1. Анализ текущей структуры конфигурации
- [x] Изучить текущую структуру `secret.yaml`
- [x] Изучить текущую структуру `app.yaml`
- [x] Проанализировать структуры данных в `internal/config/config.go`
- [x] Изучить функции загрузки конфигурации
- [x] Проанализировать существующие тесты

### 2. Модификация структуры secret.yaml
- [x] **Полностью удалить секцию `dbrestore`** из `secret.yaml`
- [x] **Переместить пароль в `passwords.mssql`** вместо `dbrestore.password`
- [x] Обновить соответствующие структуры данных в Go коде

### 3. Модификация структуры app.yaml
- [x] **Добавить новую секцию `dbrestore`** в `app.yaml`
- [x] Перенести поля из `secret.yaml`:
  - `database`
  - `timeout` (значение по умолчанию: `50s`)
  - `autotimeout` (значение по умолчанию: `true`)
- [x] Обновить структуры данных для загрузки из `app.yaml`

### 4. Реализация алгоритма определения srcServer и dstServer

#### 4.1 Создание новых функций
- [x] **Функция поиска продуктивной базы по тестовой базе**:
  - Входной параметр: имя тестовой базы (например, `V8_DEV_DSBEKETOV_APK_TOIR3`)
  - Поиск в `project.yaml` в секциях `prod.*.related`
  - Возврат имени продуктивной базы или ошибки

- [x] **Функция получения информации о сервере базы**:
  - Входной параметр: имя базы
  - Поиск в `dbconfig.yaml`
  - Возврат `dbserver` или ошибки

- [x] **Основная функция определения srcServer и dstServer**:
  - Входной параметр: имя тестовой базы для восстановления
  - Алгоритм:
    1. Найти продуктивную базу через `project.yaml`
    2. Получить `srcServer` из `dbconfig.yaml` для продуктивной базы
    3. Получить `dstServer` из `dbconfig.yaml` для тестовой базы
    4. Вернуть результат или ошибку

#### 4.2 Обработка ошибок
- [x] **База не найдена в `project.yaml`**: вернуть ошибку
- [x] **База не найдена в `dbconfig.yaml`**: вернуть ошибку
- [x] **Отсутствует поле `dbserver`**: вернуть ошибку

### 5. Модификация функций загрузки конфигурации

#### 5.1 Обновление существующих функций
- [x] **`LoadDBRestoreConfig`**:
  - Удалить загрузку полей из `secret.yaml`
  - Добавить загрузку полей из `app.yaml`
  - Добавить загрузку пароля из `passwords.mssql`
  - Интегрировать алгоритм определения серверов

- [x] **Проверить все остальные функции загрузки**:
  - `LoadConfig`
  - `LoadSecretConfig`
  - `LoadAppConfig`
  - `LoadServiceModeConfig`
  - Другие функции, использующие конфигурацию

#### 5.2 Обновление структур данных
- [x] **Структура `SecretConfig`**:
  - Удалить поле `Dbrestore`
  - Убедиться, что `Passwords.Mssql` существует

- [x] **Структура `AppConfig`**:
  - Добавить секцию `Dbrestore` с полями:
    - `Database string`
    - `Timeout string`
    - `Autotimeout bool`

- [x] **Структура конфигурации восстановления БД**:
  - Обновить для использования новых источников данных
  - Добавить поля `SrcServer` и `DstServer`

### 6. Обновление конфигурационных файлов

#### 6.1 Модификация secret.yaml
- [x] Удалить секцию `dbrestore`
- [x] Убедиться, что `passwords.mssql` содержит необходимый пароль

#### 6.2 Модификация app.yaml
- [x] Добавить секцию:
```yaml
dbrestore:
  database: ""
  timeout: "50s"
  autotimeout: true
```

### 7. Создание и обновление тестов

#### 7.1 Тесты для алгоритма поиска баз
- [x] **Тест: база не найдена в `project.yaml`**
  - Передать имя базы, которой нет в `project.yaml`
  - Ожидать ошибку

- [x] **Тест: база не найдена в `dbconfig.yaml`**
  - База есть в `project.yaml`, но нет в `dbconfig.yaml`
  - Ожидать ошибку

- [x] **Тест: база найдена в `project.yaml`, но нет в `dbconfig.yaml`**
  - Тестовая база есть в `related`, но нет записи в `dbconfig.yaml`
  - Ожидать ошибку

- [x] **Тест: база найдена в `dbconfig.yaml`, но нет в `project.yaml`**
  - База есть в `dbconfig.yaml`, но не указана в `related`
  - Ожидать ошибку

- [x] **Тест: успешное определение серверов**
  - База найдена в обоих файлах
  - Проверить корректность `srcServer` и `dstServer`

#### 7.2 Обновление существующих тестов
- [x] **Тесты загрузки конфигурации**:
  - Обновить тестовые данные для новой структуры
  - Проверить загрузку из `app.yaml` вместо `secret.yaml`
  - Проверить загрузку пароля из `passwords.mssql`

- [x] **Интеграционные тесты**:
  - Обновить тесты, использующие конфигурацию восстановления БД

### 8. Валидация и тестирование

#### 8.1 Модульные тесты
- [x] Запустить все новые тесты
- [x] Убедиться, что все существующие тесты проходят
- [x] Проверить покрытие кода тестами

#### 8.2 Интеграционное тестирование
- [x] Протестировать загрузку конфигурации с реальными файлами
- [x] Проверить работу алгоритма на примерах из задания
- [x] Убедиться в корректной обработке ошибок

#### 8.3 Проверка обратной совместимости
- [x] Убедиться, что старые конфигурационные файлы вызывают ошибки (как требуется)
- [x] Проверить, что значения по умолчанию работают корректно

#### 8.4 Проверка компиляции
- [x] **Выполнить `go build ./...`**:
  - Убедиться, что проект компилируется без ошибок
  - Проверить отсутствие синтаксических ошибок

### 9. Документация
- [x] Обновить комментарии в коде
- [x] Создать примеры новых конфигурационных файлов
- [x] Обновить документацию по конфигурации (если есть)

### 10. Финальная проверка
- [x] Запустить `go vet ./...`
- [x] Запустить `go test ./...`
- [x] Проверить сборку проекта
- [x] Протестировать основные сценарии использования

## ✅ СТАТУС ВЫПОЛНЕНИЯ

**Рефакторинг завершен успешно!**

Все пункты плана выполнены:
- ✅ Анализ структуры конфигурации
- ✅ Модификация файлов конфигурации (secret.yaml, app.yaml)
- ✅ Реализация алгоритма поиска серверов
- ✅ Создание новых функций определения srcServer/dstServer
- ✅ Модификация функций загрузки конфигурации
- ✅ Обновление всех вызовов функций
- ✅ Обновление тестов
- ✅ Проверка линтером и компиляцией

**Результат:** Функция `LoadDBRestoreConfig` теперь принимает `dbName` вместо `configPath` и автоматически определяет серверы источника и назначения на основе конфигурации проекта и базы данных.

## Ключевые принципы реализации

1. **Без обратной совместимости**: старые форматы конфигурации не поддерживаются
2. **Строгая обработка ошибок**: при отсутствии данных возвращать ошибки, а не значения по умолчанию
3. **Использование только файлов конфигурации**: не использовать переменные окружения
4. **Значения по умолчанию только для app.yaml**: `timeout: 50s`, `autotimeout: true`

## Пример алгоритма определения серверов

```
Вход: V8_DEV_DSBEKETOV_APK_TOIR3

1. Поиск в project.yaml:
   - Найти в prod.*.related базу V8_DEV_DSBEKETOV_APK_TOIR3
   - Получить имя продуктивной базы: V8_OPER_APK_TOIR3

2. Поиск в dbconfig.yaml:
   - srcServer = dbconfig[V8_OPER_APK_TOIR3].dbserver = MSK-SQL-02
   - dstServer = dbconfig[V8_DEV_DSBEKETOV_APK_TOIR3].dbserver = MSK-DV-SQL-01

Результат: srcServer=MSK-SQL-02, dstServer=MSK-DV-SQL-01
```

## Критерии завершения
- Все тесты проходят успешно
- Конфигурация загружается из новых источников
- Алгоритм определения серверов работает корректно
- Обработка ошибок реализована согласно требованиям
- Код проходит статический анализ (`go vet`)