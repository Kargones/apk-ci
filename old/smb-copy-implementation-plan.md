# План реализации архитектуры SMB копирования

## 1. Обзор архитектуры

### 1.1. Назначение системы
Система предназначена для копирования директорий через протокол SMB/CIFS с использованием Kerberos аутентификации. Основная функция `CopyDirectories` интегрируется в существующее приложение как новое действие `ActSmbCopy`.

### 1.2. Ключевые компоненты архитектуры

#### 1.2.1. Уровень приложения (Application Layer)
- **Точка входа**: Функция `CopyDirectories` в `main.go`
- **Конфигурация**: Загрузка параметров из `app.yaml` и `secret.yaml`
- **Интеграция**: Новое действие `ActSmbCopy` в существующей системе команд

#### 1.2.2. SMB модуль (SMB Module)
- **Расположение**: `internal/smb/smb.go`
- **Архитектурные принципы**: Модульность, безопасность, надежность, производительность
- **Структура**: Четырехуровневая архитектура с четким разделением ответственности

#### 1.2.3. Детальная архитектура компонентов

##### 1.2.3.1. Сервисный уровень (Service Layer)
- **Интерфейс**: `SMBService`
- **Ответственность**: Координация операций копирования, управление жизненным циклом
- **Ключевые методы**: `CopyDirectories()`, `ValidateConfig()`, `Cleanup()`

##### 1.2.3.2. Уровень аутентификации (Authentication Layer)
- **Интерфейс**: `AuthenticationManager`
- **Ответственность**: Управление Kerberos аутентификацией
- **Ключевые методы**: `Authenticate()`, `RefreshCredentials()`, `Cleanup()`

##### 1.2.3.3. Транспортный уровень (Transport Layer)
- **Интерфейс**: `SMBTransport`
- **Ответственность**: Управление SMB соединениями
- **Ключевые методы**: `Connect()`, `Disconnect()`, `IsConnected()`

##### 1.2.3.4. Уровень файловых операций (File Operations Layer)
- **Интерфейс**: `FileOperations`
- **Ответственность**: Выполнение операций с файлами и директориями
- **Ключевые методы**: `CopyFile()`, `CreateDirectory()`, `ListDirectory()`

### 1.3. Взаимосвязи компонентов

#### 1.3.1. Поток данных
1. **Инициализация**: `main.go` → `SMBService` → загрузка конфигурации
2. **Аутентификация**: `SMBService` → `AuthenticationManager` → Kerberos
3. **Соединение**: `SMBService` → `SMBTransport` → установка SMB соединения
4. **Копирование**: `SMBService` → `FileOperations` → выполнение операций
5. **Завершение**: Очистка ресурсов во всех слоях

#### 1.3.2. Управление ошибками
- **Стратегия повторов**: Автоматические повторы для восстанавливаемых ошибок
- **Категории ошибок**: Критические, восстанавливаемые, предупреждения
- **Логирование**: Детальное логирование всех операций и ошибок

### 1.4. Конфигурация системы

#### 1.4.1. Структуры конфигурации
- **SMBConfig**: Основные параметры SMB подключения
- **SMBSecrets**: Конфиденциальные данные (пароли, ключи)
- **Источники**: `app.yaml` и `secret.yaml`

#### 1.4.2. Параметры производительности
- **BufferSize**: Размер буфера для операций ввода-вывода
- **LargeFileThreshold**: Порог для определения больших файлов
- **ParallelThreshold**: Порог для включения параллельной обработки
- **MaxParallelWorkers**: Максимальное количество параллельных потоков
- **OperationTimeout**: Таймаут для операций

### 1.5. Безопасность

#### 1.5.1. Управление временными файлами
- **Создание**: Безопасное создание во временных директориях
- **Очистка**: Условная очистка при завершении операций (если текущий уровень логгирование не равен Debug)
- **Права доступа**: Ограниченные права доступа к временным файлам

#### 1.5.2. Обработка учетных данных
- **Передача**: Защищенная передача через Kerberos

### 1.6. Мониторинг и метрики

#### 1.6.1. Операционные метрики
- **События логирования**: Сетевые события, файловые операции

#### 1.6.2. Конфигурация логирования
- **Level**: Уровень детализации логов
- **ProgressLogging**: Логирование прогресса операций
- **FileOperations**: Логирование файловых операций
- **NetworkEvents**: Логирование сетевых событий

## 2. Этапы реализации

### 2.1. Этап 1: Подготовка инфраструктуры и базовой архитектуры

#### 2.1.1. Цель
Создание базовой структуры проекта, настройка инфраструктуры разработки и определение основных интерфейсов компонентов.

#### 2.1.2. Задачи
- 2.1.2.1. Создание структуры директорий для SMB модуля
- 2.1.2.2. Определение основных интерфейсов (`SMBService`, `AuthenticationManager`, `SMBTransport`, `FileOperations`)
- 2.1.2.3. Настройка системы сборки и зависимостей
- 2.1.2.4. Создание базовых структур конфигурации (`SMBConfig`, `SMBSecrets`)
- 2.1.2.5. Настройка системы логирования
- 2.1.2.6. Создание базовых тестов для проверки структуры

#### 2.1.3. Зависимости
- Доступ к существующему коду проекта
- Настроенная среда разработки Go
- Доступ к системам контроля версий

#### 2.1.4. Ожидаемые результаты
- Структура директорий `internal/smb/`
- Файлы интерфейсов с документацией
- Обновленные файлы зависимостей (`go.mod`, `go.sum`)
- Базовые структуры конфигурации
- Настроенная система логирования
- Начальные unit-тесты

### 2.2. Этап 2: Реализация уровня конфигурации

#### 2.2.1. Цель
Реализация полной системы управления конфигурацией, включая загрузку из файлов, валидацию и безопасное хранение.

#### 2.2.2. Задачи
- 2.2.2.1. Реализация загрузки конфигурации из `app.yaml` и `secret.yaml`

#### 2.2.3. Зависимости
- Завершенный этап 2.1
- Определенные форматы конфигурационных файлов
- Библиотеки для работы с YAML

#### 2.2.4. Ожидаемые результаты
- Полнофункциональная система конфигурации
- Валидация всех параметров конфигурации

### 2.3. Этап 3: Реализация уровня аутентификации

#### 2.3.1. Цель
Создание надежной системы Kerberos аутентификации с поддержкой обновления учетных данных и обработки ошибок.

#### 2.3.2. Задачи
- 2.3.2.1. Реализация интерфейса `AuthenticationManager`
- 2.3.2.2. Интеграция с системными утилитами Kerberos (`kinit`, `ktutil`)
- 2.3.2.3. Реализация автоматического обновления билетов
- 2.3.2.4. Создание системы обработки ошибок аутентификации
- 2.3.2.5. Реализация безопасной очистки учетных данных
- 2.3.2.6. Создание mock-объектов для тестирования

#### 2.3.3. Зависимости
- Завершенный этап 2.2
- Установленные системные пакеты Kerberos
- Доступ к тестовому домену Kerberos

#### 2.3.4. Ожидаемые результаты
- Полнофункциональный модуль аутентификации
- Автоматическое управление билетами Kerberos
- Надежная обработка ошибок аутентификации
- Mock-объекты для изолированного тестирования
- Документация по использованию

### 2.4. Этап 4: Реализация транспортного уровня

#### 2.4.1. Цель
Создание надежного транспортного уровня для управления SMB соединениями с поддержкой переподключения и мониторинга состояния.

#### 2.4.2. Задачи
- 2.4.2.1. Реализация интерфейса `SMBTransport`
- 2.4.2.2. Интеграция с системными SMB утилитами (`smbclient`, `mount.cifs`)

#### 2.4.3. Зависимости
- Завершенный этап 2.3
- Установленные SMB клиентские утилиты
- Доступ к тестовому SMB серверу

#### 2.4.4. Ожидаемые результаты
- Стабильный транспортный уровень

### 2.5. Этап 5: Реализация уровня файловых операций

#### 2.5.1. Цель
Создание эффективного уровня файловых операций с поддержкой параллельной обработки и оптимизации для больших файлов.

#### 2.5.2. Задачи
- 2.5.2.1. Реализация интерфейса `FileOperations`

#### 2.5.3. Зависимости
- Завершенный этап 2.4
- Доступ к тестовым данным различных размеров

#### 2.5.4. Ожидаемые результаты
- Высокопроизводительный модуль файловых операций

### 2.6. Этап 6: Реализация сервисного уровня

#### 2.6.1. Цель
Создание координирующего сервисного уровня, объединяющего все компоненты в единую систему с полным управлением жизненным циклом.

#### 2.6.2. Задачи
- 2.6.2.1. Реализация интерфейса `SMBService`
- 2.6.2.2. Создание системы координации всех уровней
- 2.6.2.3. Реализация управления жизненным циклом операций

#### 2.6.3. Зависимости
- Завершенные этапы 2.1-2.5
- Определенные требования к метрикам
- Интеграционная тестовая среда

#### 2.6.4. Ожидаемые результаты
- Полнофункциональный сервисный уровень
- Координация всех компонентов системы
- Надежное управление ошибками

### 2.7. Этап 7: Интеграция с основным приложением

#### 2.7.1. Цель
Интеграция SMB модуля в существующее приложение через новое действие `ActSmbCopy` с полной совместимостью.

#### 2.7.2. Задачи
- 2.7.2.1. Создание действия `ActSmbCopy` в `main.go`
- 2.7.2.2. Интеграция с существующей системой конфигурации
- 2.7.2.3. Адаптация системы логирования
- 2.7.2.5. Реализация совместимости с существующими workflow

#### 2.7.3. Зависимости
- Завершенный этап 2.6
- Доступ к коду основного приложения
- Понимание существующей архитектуры приложения

#### 2.7.4. Ожидаемые результаты
- Полная интеграция SMB функциональности
- Новое действие `ActSmbCopy`
- Совместимость с существующими процессами

### 2.8. Этап 8: Комплексное тестирование и оптимизация

#### 2.8.1. Цель
Проведение комплексного тестирования всей системы, оптимизация производительности и подготовка к production развертыванию.

#### 2.8.2. Задачи
- 2.8.2.1. Проведение интеграционного тестирования
- 2.8.2.2. Выполнение нагрузочного тестирования
- 2.8.2.3. Тестирование безопасности
- 2.8.2.4. Оптимизация производительности
- 2.8.2.5. Проведение stress-тестирования
- 2.8.2.6. Подготовка production-ready конфигурации

#### 2.8.3. Зависимости
- Завершенный этап 2.7
- Настроенная тестовая среда
- Инструменты для нагрузочного тестирования

#### 2.8.4. Ожидаемые результаты
- Полностью протестированная система
- Оптимизированная производительность
- Подтвержденная безопасность
- Production-ready конфигурация
- Отчеты о тестировании

## 3. Технологический стек

### 3.1. Основные технологии

#### 3.1.1. Язык программирования
- **Go (Golang)**: Основной язык разработки
- **Версия**: Go 1.24 (совместимость с существующим проектом)
- **Обоснование**: Высокая производительность, статическая типизация

#### 3.1.2. Системные зависимости
- **samba-client**: Клиентские утилиты для работы с SMB/CIFS
- **krb5-user**: Утилиты для работы с Kerberos аутентификацией
- **cifs-utils**: Утилиты для монтирования CIFS файловых систем
- **Операционная система**: Linux (Ubuntu24.04)

### 3.2. Go библиотеки и пакеты

#### 3.2.1. Стандартные библиотеки Go
- **context**: Управление контекстом и отменой операций
- **fmt**: Форматирование строк и вывод
- **io**: Базовые операции ввода-вывода
- **net**: Сетевые операции
- **os**: Операции с операционной системой
- **os/exec**: Выполнение внешних команд
- **path/filepath**: Операции с путями файловой системы
- **sync**: Примитивы синхронизации
- **time**: Операции со временем и таймауты

#### 3.2.2. Внешние Go библиотеки
- **github.com/google/uuid**: Генерация уникальных идентификаторов
- **gopkg.in/yaml.v3**: Парсинг YAML конфигурационных файлов
- **github.com/stretchr/testify**: Фреймворк для unit-тестирования

### 3.3. Системные утилиты

#### 3.3.1. SMB/CIFS утилиты
- **smbclient**: Клиент для доступа к SMB ресурсам
- **mount.cifs**: Монтирование CIFS файловых систем
- **umount**: Размонтирование файловых систем

#### 3.3.2. Kerberos утилиты
- **kinit**: Получение Kerberos билетов
- **ktutil**: Управление keytab файлами
- **klist**: Просмотр Kerberos билетов
- **kdestroy**: Удаление Kerberos билетов

### 3.4. Инструменты разработки

#### 3.4.1. Система сборки
- **Go Modules**: Управление зависимостями
- **Makefile**: Автоматизация сборки и тестирования
- **go build**: Компиляция приложения
- **go test**: Выполнение тестов

#### 3.4.2. Инструменты качества кода
- **golint**: Статический анализ кода
- **go vet**: Проверка потенциальных ошибок
- **gofmt**: Форматирование кода
- **go mod tidy**: Очистка зависимостей

#### 3.4.3. Инструменты тестирования
- **go test**: Встроенный фреймворк тестирования
- **testify**: Расширенные возможности тестирования
- **go test -cover**: Анализ покрытия кода

### 3.5. Инфраструктура разработки

#### 3.5.1. Система контроля версий
- **Git**: Система контроля версий


### 3.6. Мониторинг и логирование

#### 3.6.1. Логирование
- **slog** (стандартная библиотека): Использование реализованной в проекте структурированного логирования

