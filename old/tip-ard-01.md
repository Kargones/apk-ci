# План приведения проекта в соответствие требованиям ARD-01

## Анализ текущего состояния проекта

Проект `apk-ci` представляет собой Go-приложение для работы с 1С:Предприятие. После анализа кодовой базы выявлены следующие несоответствия требованиям из `ard-01.md`:

### Выявленные проблемы:

1. **Структуры разбросаны по разным пакетам** - отсутствует централизованное место для общих структур
2. **Константы не организованы** - константы объявлены в разных файлах без группировки
3. **Отсутствуют директории** `internal/structures/` и `internal/constants/`
4. **Большие файлы** - некоторые файлы превышают лимит в 500 строк
5. **Отсутствуют методы валидации** для структур
6. **Неоптимальный memory alignment** в структурах
7. **Отсутствуют godoc комментарии** для многих экспортируемых элементов
8. **Отсутствуют unit тесты** для структур

---

## Детальный план рефакторинга

### 1. Подготовительные работы

#### 1.1. Создание базовой структуры директорий
- [ ] 1.1.1. Создать директорию `internal/structures/`
- [ ] 1.1.2. Создать директорию `internal/constants/`
- [ ] 1.1.3. Создать файл `internal/structures/types.go`
- [ ] 1.1.4. Создать файл `internal/structures/types_test.go`

#### 1.2. Создание файлов констант
- [ ] 1.2.1. Создать файл `internal/constants/errors.go`
- [ ] 1.2.2. Создать файл `internal/constants/defaults.go`
- [ ] 1.2.3. Создать файл `internal/constants/endpoints.go`
- [ ] 1.2.4. Создать файл `internal/constants/formats.go`
- [ ] 1.2.5. Создать файл `internal/constants/messages.go`

### 2. Анализ и инвентаризация существующих структур

#### 2.1. Инвентаризация структур в config пакете
- [ ] 2.1.1. Проанализировать структуры в `internal/config/config.go`:
  - `AppConfig`
  - `ProjectConfig`
  - `SecretConfig`
  - `DatabaseInfo`
  - `Config`
  - `ConvertConfig`
  - `DBRestoreConfig`
  - `ServiceModeConfig`
  - `EdtConfig`
  - `Repo`
  - `FileInfo`
  - `GiteaAPI`

#### 2.2. Инвентаризация структур в entity пакетах
- [ ] 2.2.1. Проанализировать структуры в `internal/entity/one/edt/edt.go`:
  - `Convert`
  - `Data`
  - `Mapping`
  - `EdtCli`
- [ ] 2.2.2. Проанализировать структуры в `internal/entity/one/convert/convert.go`:
  - `ConvertConfig`
  - `ConvertPair`
  - `Source`
- [ ] 2.2.3. Проанализировать структуры в `internal/entity/one/designer/designer.go`:
  - `OneDb`
- [ ] 2.2.4. Проанализировать структуры в `internal/rac/rac.go`:
  - `Client`

#### 2.3. Инвентаризация констант
- [ ] 2.3.1. Собрать константы из `internal/config/config.go`:
  - `Msg_AppExit`, `version`, `EdtBranch`
  - `Act_convert`, `Task_DbRestore`, `GroupName`
  - `ApiVersion`, `ПроверкаПеременных`
- [ ] 2.3.2. Собрать константы из `internal/entity/one/edt/edt.go`:
  - `Xml2edt`, `Edt2xml`, `formatXML`, `formatEDT`
- [ ] 2.3.3. Собрать константы из `internal/entity/one/convert/convert.go`:
  - `MergeSettingsString`, `defaultUser`, `defaultPass`

### 3. Рефакторинг констант

#### 3.1. Перенос констант форматов
- [ ] 3.1.1. Перенести константы форматов в `internal/constants/formats.go`:
  - `formatXML`, `formatEDT` из edt.go
  - `Xml2edt`, `Edt2xml` из edt.go

#### 3.2. Перенос констант по умолчанию
- [ ] 3.2.1. Перенести в `internal/constants/defaults.go`:
  - `defaultUser`, `defaultPass` из convert.go
  - `version`, `EdtBranch` из config.go

#### 3.3. Перенос констант сообщений
- [ ] 3.3.1. Перенести в `internal/constants/messages.go`:
  - `Msg_AppExit`, `ПроверкаПеременных` из config.go
  - `MergeSettingsString` из convert.go

#### 3.4. Перенос констант действий и задач
- [ ] 3.4.1. Создать файл `internal/constants/actions.go`
- [ ] 3.4.2. Перенести в `internal/constants/actions.go`:
  - `Act_convert`, `Task_DbRestore` из config.go

#### 3.5. Перенос констант API
- [ ] 3.5.1. Перенести в `internal/constants/endpoints.go`:
  - `ApiVersion`, `GroupName` из config.go

#### 3.6. Обновление импортов
- [ ] 3.6.1. Обновить импорты во всех файлах, использующих перенесенные константы
- [ ] 3.6.2. Заменить прямые обращения к константам на импорты из constants пакета

### 4. Рефакторинг структур

#### 4.1. Определение структур для переноса
- [ ] 4.1.1. Определить структуры, используемые в нескольких пакетах:
  - `Convert` (используется в edt и других местах)
  - `Data` (используется в edt)
  - `Mapping` (используется в edt)
  - `ConvertConfig` (используется в convert и config)
  - `ConvertPair` (используется в convert)
  - `Source` (используется в convert)
  - `OneDb` (используется в designer и convert)

#### 4.2. Создание общих структур
- [ ] 4.2.1. Создать структуры в `internal/structures/types.go`:
  - `ConvertData` (переименованная `Data`)
  - `PathMapping` (переименованная `Mapping`)
  - `ConvertOperation` (переименованная `Convert`)
  - `DatabaseConnection` (переименованная `OneDb`)
  - `ConvertConfiguration` (переименованная `ConvertConfig`)
  - `ConvertPairMapping` (переименованная `ConvertPair`)
  - `SourceConfiguration` (переименованная `Source`)

#### 4.3. Оптимизация memory alignment
- [ ] 4.3.1. Переупорядочить поля в структурах для оптимального выравнивания:
  - Сгруппировать поля по размеру (int64, int32, int16, int8, bool)
  - Разместить указатели в начале структуры
  - Минимизировать padding

#### 4.4. Добавление методов валидации
- [ ] 4.4.1. Добавить метод `Validate()` для каждой структуры:
  - Проверка обязательных полей
  - Валидация форматов данных
  - Проверка бизнес-логики

#### 4.5. Добавление методов клонирования
- [ ] 4.5.1. Добавить метод `Clone()` для структур, требующих глубокого копирования:
  - Структуры с указателями
  - Структуры со слайсами
  - Структуры с картами

#### 4.6. Разделение опциональных и обязательных полей
- [ ] 4.6.1. Использовать указатели для опциональных полей
- [ ] 4.6.2. Добавить значения по умолчанию для обязательных полей
- [ ] 4.6.3. Четко документировать какие поля обязательные, а какие опциональные

#### 4.7. Обновление существующих пакетов
- [ ] 4.7.1. Обновить `internal/entity/one/edt/edt.go`:
  - Заменить локальные структуры на импорты из structures
  - Обновить все использования структур
- [ ] 4.7.2. Обновить `internal/entity/one/convert/convert.go`:
  - Заменить локальные структуры на импорты из structures
  - Обновить все использования структур
- [ ] 4.7.3. Обновить `internal/entity/one/designer/designer.go`:
  - Заменить локальные структуры на импорты из structures
  - Обновить все использования структур
- [ ] 4.7.4. Обновить `internal/config/config.go`:
  - Заменить дублирующиеся структуры на импорты из structures
  - Обновить все использования структур

### 5. Улучшение организации кода

#### 5.1. Разделение больших файлов
- [ ] 5.1.1. Проанализировать файлы превышающие 500 строк:
  - `internal/config/config.go` (1677 строк)
  - `internal/entity/one/convert/convert.go` (514 строк)
  - `internal/entity/one/edt/edt.go` (500 строк)
- [ ] 5.1.2. Разделить `internal/config/config.go`:
  - Создать `internal/config/types.go` для структур
  - Создать `internal/config/loaders.go` для функций загрузки
  - Создать `internal/config/validators.go` для валидации
  - Оставить в `config.go` только основную логику
- [ ] 5.1.3. Разделить `internal/entity/one/convert/convert.go`:
  - Создать `internal/entity/one/convert/types.go` для структур
  - Создать `internal/entity/one/convert/operations.go` для операций
  - Оставить в `convert.go` только основную логику
- [ ] 5.1.4. Разделить `internal/entity/one/edt/edt.go`:
  - Создать `internal/entity/one/edt/types.go` для структур
  - Создать `internal/entity/one/edt/operations.go` для операций
  - Оставить в `edt.go` только основную логику

#### 5.2. Улучшение импортов
- [ ] 5.2.1. Группировать импорты во всех файлах:
  - Стандартная библиотека
  - Внешние пакеты
  - Внутренние пакеты
- [ ] 5.2.2. Удалить неиспользуемые импорты
- [ ] 5.2.3. Использовать короткие алиасы для длинных имен пакетов

#### 5.3. Добавление godoc комментариев
- [ ] 5.3.1. Добавить комментарии для всех экспортируемых структур
- [ ] 5.3.2. Добавить комментарии для всех экспортируемых функций
- [ ] 5.3.3. Добавить комментарии для всех экспортируемых констант
- [ ] 5.3.4. Добавить комментарии для всех экспортируемых переменных

### 6. Создание интерфейсов

#### 6.1. Анализ необходимости интерфейсов
- [ ] 6.1.1. Определить структуры с методами, требующие интерфейсы для тестирования:
  - `Client` из rac пакета
  - `EdtCli` из edt пакета
  - Структуры с внешними зависимостями

#### 6.2. Создание интерфейсов
- [ ] 6.2.1. Создать файл `internal/structures/interfaces.go`
- [ ] 6.2.2. Создать интерфейс `RacClient` для `Client`
- [ ] 6.2.3. Создать интерфейс `EdtClient` для `EdtCli`
- [ ] 6.2.4. Создать интерфейсы для других структур по необходимости

### 7. Создание тестов

#### 7.1. Создание unit тестов для структур
- [ ] 7.1.1. Создать тесты валидации в `internal/structures/types_test.go`:
  - Тесты для метода `Validate()` каждой структуры
  - Позитивные и негативные сценарии
  - Граничные случаи
- [ ] 7.1.2. Создать тесты клонирования:
  - Тесты для метода `Clone()` каждой структуры
  - Проверка глубокого копирования
  - Проверка независимости копий

#### 7.2. Property-based тестирование
- [ ] 7.2.1. Добавить зависимость `testify/quick`
- [ ] 7.2.2. Создать property-based тесты для структур:
  - Генерация случайных данных
  - Проверка инвариантов
  - Проверка идемпотентности операций

#### 7.3. Достижение покрытия 80%
- [ ] 7.3.1. Измерить текущее покрытие тестами
- [ ] 7.3.2. Добавить недостающие тесты для достижения 80% покрытия
- [ ] 7.3.3. Настроить автоматическую проверку покрытия

### 8. Обработка ошибок

#### 8.1. Создание кастомных типов ошибок
- [ ] 8.1.1. Создать файл `internal/constants/errors.go`
- [ ] 8.1.2. Определить кастомные типы ошибок:
  - `ValidationError` для ошибок валидации
  - `ConfigurationError` для ошибок конфигурации
  - `ConversionError` для ошибок конвертации
  - `DatabaseError` для ошибок базы данных

#### 8.2. Улучшение контекста ошибок
- [ ] 8.2.1. Добавить отладочную информацию в ошибки:
  - Стек вызовов
  - Контекстные данные
  - Временные метки
- [ ] 8.2.2. Использовать `fmt.Errorf` с `%w` для wrapping ошибок
- [ ] 8.2.3. Добавить структурированное логирование ошибок

### 9. Финальные проверки и оптимизации

#### 9.1. Проверка с golangci-lint
- [ ] 9.1.1. Настроить конфигурацию golangci-lint с полным набором правил
- [ ] 9.1.2. Исправить все найденные проблемы:
  - Неиспользуемые переменные
  - Неэффективные конструкции
  - Проблемы безопасности
  - Стилистические проблемы

#### 9.2. Проверка производительности
- [ ] 9.2.1. Провести бенчмарки для критических функций
- [ ] 9.2.2. Оптимизировать узкие места
- [ ] 9.2.3. Проверить memory alignment структур

#### 9.3. Обновление документации
- [ ] 9.3.1. Обновить README.md с описанием новой архитектуры
- [ ] 9.3.2. Создать документацию по использованию новых структур
- [ ] 9.3.3. Обновить godoc комментарии

### 10. Миграция и совместимость

#### 10.1. Создание миграционных скриптов
- [ ] 10.1.1. Создать скрипты для автоматической миграции конфигураций
- [ ] 10.1.2. Добавить валидацию мигрированных данных
- [ ] 10.1.3. Создать rollback механизм

#### 10.2. Обеспечение обратной совместимости
- [ ] 10.2.1. Добавить deprecated аннотации для старых структур
- [ ] 10.2.2. Создать адаптеры для старых интерфейсов
- [ ] 10.2.3. Добавить предупреждения о deprecated элементах

#### 10.3. Тестирование миграции
- [ ] 10.3.1. Создать тесты для миграционных скриптов
- [ ] 10.3.2. Протестировать на реальных данных
- [ ] 10.3.3. Проверить производительность после миграции

---

## Приоритеты выполнения

### Высокий приоритет (критично для архитектуры)
- Пункты 1.1-1.2: Создание базовой структуры
- Пункты 2.1-2.3: Инвентаризация существующих элементов
- Пункты 3.1-3.6: Рефакторинг констант
- Пункты 4.1-4.7: Рефакторинг структур

### Средний приоритет (важно для качества)
- Пункты 5.1-5.3: Улучшение организации кода
- Пункты 7.1-7.3: Создание тестов
- Пункты 8.1-8.2: Обработка ошибок

### Низкий приоритет (улучшения)
- Пункты 6.1-6.2: Создание интерфейсов
- Пункты 9.1-9.3: Финальные проверки
- Пункты 10.1-10.3: Миграция и совместимость

---

## Ожидаемые результаты

После выполнения всех пунктов плана проект будет соответствовать требованиям ARD-01:

1. ✅ **Централизованные структуры** в `internal/structures/types.go`
2. ✅ **Организованные константы** в `internal/constants/`
3. ✅ **Оптимизированный memory alignment** структур
4. ✅ **Методы валидации и клонирования** для всех структур
5. ✅ **Godoc комментарии** для всех экспортируемых элементов
6. ✅ **Unit тесты** с покрытием 80%+
7. ✅ **Файлы до 500 строк** максимум
8. ✅ **Улучшенная обработка ошибок** с контекстом
9. ✅ **Интерфейсы для тестирования** где необходимо
10. ✅ **Соответствие golangci-lint** правилам

---

## Метрики успеха

- [ ] Все файлы меньше 500 строк
- [ ] Покрытие тестами > 80%
- [ ] 0 ошибок golangci-lint
- [ ] Все структуры имеют методы Validate()
- [ ] Все экспортируемые элементы имеют godoc
- [ ] Все константы организованы по категориям
- [ ] Все общие структуры в internal/structures/
- [ ] Memory alignment оптимизирован
- [ ] Интерфейсы созданы только где необходимо
- [ ] Обработка ошибок с контекстом для LLM анализа