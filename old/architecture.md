# Архитектура проекта Benadis Runner

## Обзор проекта

Benadis Runner - это система автоматизации DevOps процессов для платформы 1С:Предприятие, которая обеспечивает интеграцию между системами управления версиями (Git/Gitea), хранилищами конфигураций 1С и базами данных MS SQL Server.

## Архитектура системы

### Общая архитектура

Система построена по модульной архитектуре с четким разделением ответственности:

```
┌─────────────────────────────────────────────────────────────┐
│                    Benadis Runner                           │
├─────────────────────────────────────────────────────────────┤
│  CLI Interface (cmd/github.com/Kargones/apk-ci/main.go)                │
├─────────────────────────────────────────────────────────────┤
│  Application Layer (internal/app)                          │
├─────────────────────────────────────────────────────────────┤
│  Business Logic Layer                                      │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │   Gitea     │     Git     │  DBRestore  │     EDT     │  │
│  │   Entity    │   Entity    │   Entity    │   Entity    │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  Utility Layer (internal/util)                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │    Filer    │   Runner    │    Timer    │     XML     │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  Configuration Layer (internal/config)                     │
└─────────────────────────────────────────────────────────────┘
```

### Архитектурные принципы

1. **Модульность** - каждый компонент имеет четко определенную ответственность
2. **Слабая связанность** - модули взаимодействуют через интерфейсы
3. **Конфигурируемость** - все настройки вынесены в конфигурационный слой
4. **Логирование** - структурированное логирование всех операций
5. **Обработка ошибок** - централизованная обработка ошибок с контекстом

## Компоненты проекта

### 1. CLI Interface (cmd/benadis-runner)

**Назначение**: Точка входа в приложение, обработка команд и параметров.

**Основные функции**:
- Инициализация конфигурации
- Маршрутизация команд к соответствующим обработчикам
- Обработка задач из Gitea Issues
- Управление жизненным циклом приложения

**Поддерживаемые команды**:
- `test-merge` - проверка конфликтов слияния PR
- `convertedt` - конвертация EDT в XML
- `git2store` - синхронизация Git → Хранилище 1С
- `store2git` - синхронизация Хранилище 1С → Git
- `dbrestore` - восстановление базы данных
- `issuetask` - обработка задач из Issues

### 2. Application Layer (internal/app)

**Назначение**: Координация бизнес-логики и оркестрация операций.

**Основные функции**:
- `InitGit()` - инициализация Git-клиента
- `Convert()` - конвертация конфигураций
- `Git2Store()` - процесс синхронизации Git → Store
- `Store2Db()` - загрузка из хранилища в БД
- `DbUpdate()` - обновление конфигурации БД
- `DbRestore()` - восстановление базы данных

### 3. Business Logic Entities

#### 3.1 Gitea Entity (internal/entity/gitea)

**Назначение**: Интеграция с Gitea API для управления репозиториями и задачами.

**Основные возможности**:
- Управление Pull Requests (создание, слияние, закрытие)
- Работа с Issues (получение, комментирование, закрытие)
- Проверка конфликтов слияния
- Управление ветками
- Получение содержимого файлов
- Проверка членства в командах

**API методы**:
- `GetIssue(issueNumber)` - получение задачи
- `AddIssueComment(issueNumber, text)` - добавление комментария
- `CloseIssue(issueNumber)` - закрытие задачи
- `TestMerge()` - тестирование слияния PR
- `ConflictPR(prNumber)` - проверка конфликтов
- `IsUserInTeam(username, org, team)` - проверка членства

#### 3.2 Git Entity (internal/git)

**Назначение**: Операции с Git-репозиториями.

**Основные возможности**:
- Клонирование репозиториев
- Управление ветками (создание, переключение)
- Коммиты и пуши
- Конфигурирование Git
- Работа с удаленными репозиториями

**Методы**:
- `Clone()` - клонирование репозитория
- `Switch()` - переключение веток
- `Add()` - добавление файлов в индекс
- `Commit()` - создание коммита
- `Push()` - отправка изменений
- `SetUser()` - настройка пользователя

#### 3.3 DBRestore Entity (internal/entity/dbrestore)

**Назначение**: Восстановление баз данных MS SQL Server из резервных копий.

**Основные возможности**:
- Подключение к MS SQL Server
- Восстановление БД из исторических бэкапов
- Получение статистики времени восстановления
- Автоматический расчет таймаутов
- Гибкая конфигурация через YAML

**Методы**:
- `Connect(ctx)` - установка соединения с БД
- `Restore(ctx)` - восстановление БД
- `GetRestoreStats(ctx)` - получение статистики
- `Close()` - закрытие соединения

#### 3.4 EDT Entity (internal/entity/one/edt)

**Назначение**: Конвертация между форматами EDT и XML для конфигураций 1С.

**Основные возможности**:
- Конвертация EDT → XML
- Конвертация XML → EDT
- Пакетная обработка проектов
- Интеграция с Git для версионирования

**Направления конвертации**:
- `Xml2edt` - импорт XML в EDT
- `Edt2xml` - экспорт EDT в XML

### 4. Utility Layer (internal/util)

#### 4.1 Runner Utility
**Назначение**: Выполнение внешних команд и процессов.

#### 4.2 Filer Utility
**Назначение**: Операции с файловой системой.

#### 4.3 Timer Utility
**Назначение**: Работа с временными метками и таймаутами.

#### 4.4 XML Utility
**Назначение**: Обработка XML-данных.

### 5. Configuration Layer (internal/config)

**Назначение**: Централизованное управление конфигурацией приложения.

**Источники конфигурации**:
- Переменные окружения
- Файлы конфигурации
- Параметры командной строки
- GitHub Actions параметры

**Основные настройки**:
- Пути к исполняемым файлам 1С
- Параметры подключения к Gitea
- Настройки Git
- Параметры логирования
- Рабочие директории

## Взаимодействие компонентов

### 1. Обработка команд

```
CLI → Config → App Layer → Business Entities → Utilities
```

1. **CLI** получает команду и параметры
2. **Config** загружает конфигурацию из различных источников
3. **App Layer** определяет последовательность операций
4. **Business Entities** выполняют специфичную бизнес-логику
5. **Utilities** предоставляют вспомогательные функции

### 2. Процесс Git2Store

```
Git Clone → EDT Convert → 1C Load → Store Commit → Git Push
```

1. Клонирование Git-репозитория
2. Конвертация EDT → XML (если необходимо)
3. Загрузка конфигурации в 1С
4. Коммит в хранилище 1С
5. Обновление Git-репозитория

### 3. Процесс TestMerge

```
Get PRs → Create Test Branch → Test Merge → Close Conflicts → Cleanup
```

1. Получение списка активных PR
2. Создание тестовой ветки
3. Тестирование слияния каждого PR
4. Закрытие PR с конфликтами
5. Очистка тестовых веток

## Взаимодействие с базой данных

### MS SQL Server Integration

**Компонент**: DBRestore Entity

**Тип подключения**: 
- Драйвер: `github.com/denisenkom/go-mssqldb`
- Протокол: SQL Server Native Protocol
- Аутентификация: SQL Server Authentication

**Операции с БД**:

1. **Подключение**:
   ```go
   connString := fmt.Sprintf("server=%s;user id=%s;password=%s;port=%d;database=%s;encrypt=disable",
       dbR.Server, dbR.User, dbR.Password, dbR.Port, dbR.Database)
   db, err := sql.Open("sqlserver", connString)
   ```

2. **Восстановление БД**:
   - Использует хранимую процедуру `sp_DBRestorePSFromHistoryD`
   - Восстанавливает БД на указанную дату/время
   - Поддерживает автоматический расчет таймаутов

3. **Получение статистики**:
   - Запросы к таблице `[DBA].[dbo].[BackupRequestJournal]`
   - Анализ времени выполнения предыдущих восстановлений
   - Расчет оптимальных таймаутов

**Конфигурация БД**:
```yaml
tempdbrestore:
  server: "sql-server-host"
  user: "username"
  password: "password"
  port: 1433
  database: "master"
  timeout: "30m"
  time2restore: "2024-01-15T10:00:00"
```

**Безопасность**:
- Пароли через переменные окружения
- Минимальные права доступа
- Таймауты для предотвращения зависания
- Логирование всех операций

### 1C Database Integration

**Компоненты**: Convert Entity, App Layer

**Операции**:
1. **Загрузка конфигурации**: `1cv8 DESIGNER /LoadConfigFromFiles`
2. **Обновление БД**: `1cv8 DESIGNER /UpdateDBCfg`
3. **Выгрузка конфигурации**: `1cv8 DESIGNER /DumpCfg`
4. **Работа с хранилищем**: Repository operations

## Взаимодействие с внешними API

### 1. Gitea API Integration

**Компонент**: Gitea Entity

**Базовый URL**: `{GiteaURL}/api/v1`

**Аутентификация**: 
- Тип: Bearer Token
- Заголовок: `Authorization: token {AccessToken}`

**Основные эндпоинты**:

1. **Issues API**:
   - `GET /repos/{owner}/{repo}/issues/{number}` - получение задачи
   - `POST /repos/{owner}/{repo}/issues/{number}/comments` - добавление комментария
   - `PATCH /repos/{owner}/{repo}/issues/{number}` - обновление задачи

2. **Pull Requests API**:
   - `GET /repos/{owner}/{repo}/pulls` - список PR
   - `POST /repos/{owner}/{repo}/pulls` - создание PR
   - `POST /repos/{owner}/{repo}/pulls/{number}/merge` - слияние PR
   - `GET /repos/{owner}/{repo}/pulls/{number}` - информация о PR

3. **Repository API**:
   - `POST /repos/{owner}/{repo}/branches` - создание ветки
   - `DELETE /repos/{owner}/{repo}/branches/{branch}` - удаление ветки
   - `GET /repos/{owner}/{repo}/contents/{path}` - содержимое файла

4. **Organizations API**:
   - `GET /orgs/{org}/teams/search` - поиск команд
   - `GET /teams/{team_id}/members/{username}` - проверка членства

**Обработка ошибок**:
- HTTP статус коды для определения типа ошибки
- Retry логика для временных сбоев
- Детальное логирование запросов и ответов

**Пример запроса**:
```go
req, err := http.NewRequest("GET", urlString, nil)
req.Header.Set("Authorization", fmt.Sprintf("token %s", g.AccessToken))
req.Header.Set("Content-Type", "application/json")
```

### 2. Proxy Support

**Конфигурация прокси**:
```go
proxy, err := url.Parse(g.ProxyURL)
client := &http.Client{
    Transport: &http.Transport{
        Proxy: http.ProxyURL(proxy),
    },
}
```

### 3. External Tools Integration

**1C Platform Tools**:
- `1cv8` - основная платформа 1С
- `ibcmd` - утилита информационных баз
- `1cedtcli` - EDT командная строка

**Git Tools**:
- Нативные Git команды через `exec.Command`
- Поддержка различных Git операций

## Конфигурация и развертывание

### Переменные окружения

**Основные переменные**:
- `BR_ENV` - окружение (dev/prod)
- `BR_COMMAND` - выполняемая команда
- `BR_ACCESS_TOKEN` - токен доступа к Gitea
- `BR_ISSUE_NUMBER` - номер обрабатываемой задачи
- `MSSQL_PASSWORD` - пароль для MS SQL

**Пути к исполняемым файлам**:
- `Bin1cv8` - путь к 1cv8
- `BinIbcmd` - путь к ibcmd
- `RingPath` - путь к 1cedtcli

### GitHub Actions Integration

**Файл**: `action.yaml`

**Входные параметры**:
- `giteaURL` - адрес Gitea сервера
- `repository` - имя репозитория
- `accessToken` - токен доступа
- `command` - выполняемая команда
- `logLevel` - уровень логирования
- `issueNumber` - номер задачи

**Пример использования**:
```yaml
- name: Проверка конфликтов слияния
  uses: https://git.example.com/actions/benadis-runner@latest
  with:
    giteaURL: ${{ github.server_url }}
    repository: ${{ github.repository }}
    accessToken: ${{ secrets.TOKEN_FULL }}
    command: test-merge
```

## Логирование и мониторинг

### Структурированное логирование

**Библиотека**: `log/slog`

**Уровни логирования**:
- `Debug` - детальная отладочная информация
- `Info` - информационные сообщения
- `Warn` - предупреждения
- `Error` - ошибки

**Структура логов**:
```go
l.Info("Операция выполнена",
    slog.String("BR_ACTION", "git2store"),
    slog.String("BR_REPO", repoName),
    slog.String("BR_BRANCH", branchName),
)
```

### Контекстные поля

**Стандартные поля**:
- `BR_ACTION` - тип выполняемой операции
- `BR_REPO` - репозиторий
- `BR_BRANCH` - ветка
- `BR_PR_NUMBER` - номер PR
- `BR_ISSUE_NUMBER` - номер задачи
- `Error` - текст ошибки

## Безопасность

### Управление секретами

1. **Токены доступа**:
   - Хранение в переменных окружения
   - Передача через GitHub Secrets
   - Ротация токенов

2. **Пароли БД**:
   - Переменная `MSSQL_PASSWORD`
   - Отсутствие в логах
   - Минимальные права доступа

3. **Git credentials**:
   - Встраивание токена в URL
   - Кэширование credentials
   - Автоматическая очистка

### Сетевая безопасность

1. **HTTPS соединения**:
   - Все API вызовы через HTTPS
   - Проверка сертификатов

2. **Proxy поддержка**:
   - Корпоративные прокси
   - Настройка через конфигурацию

## Обработка ошибок

### Стратегии обработки

1. **Graceful degradation**:
   - Продолжение работы при несущественных ошибках
   - Логирование предупреждений

2. **Fail-fast**:
   - Немедленная остановка при критических ошибках
   - Детальное логирование контекста

3. **Retry логика**:
   - Повторные попытки для сетевых операций
   - Экспоненциальная задержка

### Коды завершения

- `0` - успешное выполнение
- `5` - ошибка конфигурации
- `7` - ошибка конвертации
- `8` - ошибка копирования файлов

## Производительность

### Оптимизации

1. **Параллельная обработка**:
   - Использование goroutines для независимых операций
   - Context для управления таймаутами

2. **Кэширование**:
   - Git credentials cache
   - Повторное использование соединений

3. **Ресурсы**:
   - Автоматическая очистка временных файлов
   - Закрытие соединений с БД
   - Управление памятью

### Масштабируемость

1. **Stateless архитектура**:
   - Отсутствие состояния между запросами
   - Возможность горизонтального масштабирования

2. **Конфигурируемые таймауты**:
   - Адаптация под различные окружения
   - Автоматический расчет оптимальных значений

## Заключение

Benadis Runner представляет собой комплексную систему автоматизации DevOps процессов для платформы 1С:Предприятие. Архитектура системы обеспечивает:

- **Модульность** - легкость добавления новых функций
- **Надежность** - обработка ошибок и восстановление
- **Безопасность** - защита секретов и данных
- **Производительность** - оптимизация операций
- **Масштабируемость** - возможность роста системы

Система успешно интегрируется с существующей инфраструктурой разработки и обеспечивает автоматизацию ключевых процессов жизненного цикла разработки ПО на платформе 1С.