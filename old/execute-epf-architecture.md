# Архитектура команды ExecuteEpf

## Обзор

Данный документ описывает архитектуру решения для добавления новой команды `execute-epf` в проект Benadis Runner. Команда предназначена для скачивания и выполнения внешних обработок 1С (файлов .epf) из удаленных репозиториев.

## Требования

### Функциональные требования
1. Добавить новую команду `execute-epf` в main.go
2. Команда должна запускать 1cv8 с параметрами:
   - `ENTERPRISE`
   - Остальные параметры как у других команд для работы с базами 1С
   - `/Execute <путь к временному файлу>`
3. Получать параметр `StartEpf` через action.yaml
4. Скачивать файл по URL из параметра `StartEpf`
5. Сохранять файл во временную директорию
6. Запускать 1cv8 с путем к временному файлу

### Нефункциональные требования
1. Максимально использовать существующие функции проекта
2. Поддерживать единообразие с другими командами
3. Обеспечить легкость расширения и сопровождения
4. Следовать архитектурным принципам проекта

## Архитектурное решение

### Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                    GitHub Action                           │
│  action.yaml: startEpf parameter                          │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│                 main.go                                    │
│  case constants.ActExecuteEpf                             │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│              app.ExecuteEpf()                              │
│  1. Валидация параметров                                   │
│  2. Скачивание файла                                       │
│  3. Сохранение во временный файл                           │
│  4. Запуск 1cv8 с параметром /Execute                     │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│            Внешние компоненты                              │
│  • HTTP клиент для скачивания                              │
│  • Файловая система для временных файлов                   │
│  • 1cv8 для выполнения обработки                          │
└─────────────────────────────────────────────────────────────┘
```

## Детальное проектирование

### 1. Изменения в константах

**Файл**: `internal/constants/constants.go`

```go
// Добавить новую константу команды
ActExecuteEpf = "execute-epf"
```

### 2. Изменения в конфигурации

**Файл**: `internal/config/config.go`

#### 2.1 Добавление в InputParams
```go
type InputParams struct {
    // ... существующие поля ...
    GHAStartEpf string `env:"INPUT_STARTEPF" env-default:""`
}
```

#### 2.2 Добавление в Config
```go
type Config struct {
    // ... существующие поля ...
    StartEpf string `env:"BR_START_EPF" env-default:""`
}
```

#### 2.3 Обновление функции MustLoad()
Добавить обработку нового параметра в функцию загрузки конфигурации.

### 3. Изменения в action.yaml

```yaml
inputs:
  # ... существующие параметры ...
  startEpf:
    description: 'URL файла внешней обработки (.epf) для выполнения'
    required: false
    default: ''
```

### 4. Новая функция в app слое

**Файл**: `internal/app/app.go`

```go
// ExecuteEpf выполняет внешнюю обработку 1С из удаленного файла.
// Скачивает файл .epf по указанному URL, сохраняет во временную директорию
// и запускает 1cv8 с параметром /Execute для выполнения обработки.
//
// Параметры:
//   - ctx: контекст выполнения операции
//   - l: логгер для записи сообщений и ошибок
//   - cfg: конфигурация приложения
//
// Возвращает:
//   - error: ошибка выполнения или nil при успехе
func ExecuteEpf(ctx *context.Context, l *slog.Logger, cfg *config.Config) error {
    // 1. Валидация входных параметров
    // 2. Скачивание файла по URL
    // 3. Сохранение во временный файл
    // 4. Подготовка параметров для 1cv8
    // 5. Запуск 1cv8 с параметром /Execute
    // 6. Обработка результата выполнения
    // 7. Очистка временных файлов
}
```

### 5. Изменения в main.go

**Файл**: `cmd/github.com/Kargones/apk-ci/main.go`

```go
case constants.ActExecuteEpf:
    err = app.ExecuteEpf(&ctx, l, cfg)
    if err != nil {
        l.Error("Ошибка выполнения внешней обработки",
            slog.String("Сообщение об ошибке", err.Error()),
            slog.String(constants.MsgErrProcessing, constants.MsgAppExit),
        )
        os.Exit(9)
    }
    l.Info("Внешняя обработка успешно выполнена")
```

## Детальная реализация функции ExecuteEpf

### Алгоритм выполнения

1. **Валидация параметров**
   - Проверка наличия параметра StartEpf
   - Валидация URL
   - Проверка доступности временной директории

2. **Скачивание файла**
   - HTTP GET запрос по указанному URL
   - Проверка Content-Type (application/octet-stream)
   - Проверка размера файла

3. **Сохранение временного файла**
   - Создание уникального имени файла
   - Сохранение в cfg.TmpDir
   - Установка соответствующих прав доступа

4. **Подготовка параметров 1cv8**
   - Использование существующих настроек подключения к БД
   - Формирование строки подключения
   - Добавление параметра /Execute с путем к файлу

5. **Запуск 1cv8**
   - Использование существующего runner.Run()
   - Мониторинг выполнения
   - Обработка вывода и ошибок

6. **Очистка ресурсов**
   - Удаление временного файла
   - Логирование результатов

### Обработка ошибок

- **Сетевые ошибки**: таймауты, недоступность URL
- **Файловые ошибки**: недостаток места, права доступа
- **Ошибки 1cv8**: некорректный файл, ошибки выполнения
- **Конфигурационные ошибки**: отсутствие обязательных параметров

### Безопасность

1. **Валидация URL**
   - Проверка схемы (только https://)
   - Валидация доменного имени
   - Защита от SSRF атак

2. **Валидация файла**
   - Проверка расширения (.epf)
   - Ограничение размера файла
   - Проверка сигнатуры файла

3. **Изоляция выполнения**
   - Использование временных директорий
   - Ограничение времени выполнения
   - Очистка после выполнения

## Интеграция с существующей архитектурой

### Использование существующих компонентов

1. **Конфигурация**: использование существующей системы конфигурации
2. **Логирование**: использование структурированного логирования slog
3. **Runner**: использование существующего util/runner для запуска 1cv8
4. **Обработка ошибок**: следование существующим паттернам

### Расширяемость

1. **Поддержка различных типов файлов**: .epf, .erf
2. **Различные источники**: HTTP, FTP, локальные файлы
3. **Кэширование файлов**: для повторного использования
4. **Параметризация выполнения**: дополнительные параметры для 1cv8

## Тестирование

### Модульные тесты

1. **Валидация параметров**
2. **Скачивание файлов** (с мокированием HTTP)
3. **Формирование команд 1cv8**
4. **Обработка ошибок**

### Интеграционные тесты

1. **Полный цикл выполнения** с тестовым файлом
2. **Обработка сетевых ошибок**
3. **Тестирование с различными конфигурациями БД**

### Тестовые сценарии

1. **Успешное выполнение**: корректный URL и файл
2. **Недоступный URL**: сетевая ошибка
3. **Некорректный файл**: неверный формат
4. **Ошибка выполнения**: ошибка в обработке 1С
5. **Отсутствие параметров**: валидация входных данных

## Мониторинг и логирование

### Ключевые метрики

1. **Время скачивания файла**
2. **Размер скачанного файла**
3. **Время выполнения обработки**
4. **Количество успешных/неуспешных выполнений**

### Логирование событий

1. **Начало выполнения команды**
2. **Скачивание файла** (URL, размер, время)
3. **Запуск 1cv8** (параметры, время начала)
4. **Завершение выполнения** (результат, время)
5. **Ошибки** (детальное описание с контекстом)

## Заключение

Предложенная архитектура обеспечивает:

1. **Интеграцию** с существующей кодовой базой
2. **Расширяемость** для будущих улучшений
3. **Безопасность** выполнения внешних файлов
4. **Надежность** через правильную обработку ошибок
5. **Сопровождаемость** через структурированное логирование

Решение следует архитектурным принципам проекта и обеспечивает единообразие с существующими командами.