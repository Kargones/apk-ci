# Справочник команд CLI

Данный документ содержит полное описание всех доступных команд интерфейса командной строки apk-ci с примерами использования и параметрами.

## Общий синтаксис

```bash
apk-ci [КОМАНДА] [ОПЦИИ]
```

### Переменные окружения

Все команды используют следующие базовые переменные окружения:

| Переменная | Описание | Значение по умолчанию |
|------------|----------|----------------------|
| `BR_COMMAND` | Выполняемая команда | - |
| `BR_LOG_LEVEL` | Уровень логирования | `Info` |
| `BR_WORK_DIR` | Рабочая директория | `/tmp/benadis` |
| `BR_TMP_DIR` | Временная директория | `/tmp/benadis/temp` |

## Команды управления конфигурациями

### convert - Конвертация конфигураций

Преобразование конфигураций между различными форматами (EDT ↔ XML).

#### Синтаксис
```bash
export BR_COMMAND="convert"
apk-ci
```

#### Переменные окружения
| Переменная | Описание | Обязательная |
|------------|----------|--------------|
| `BR_OWNER` | Владелец репозитория | ✓ |
| `BR_REPO` | Имя репозитория | ✓ |
| `BR_PROJECT_NAME` | Имя проекта | ✓ |

#### Пример использования
```bash
export BR_COMMAND="convert"
export BR_OWNER="myorg"
export BR_REPO="myproject"
export BR_PROJECT_NAME="MyConfiguration"
apk-ci
```

#### Описание процесса
1. Загрузка конфигурации из app.yaml и project.yaml
2. Инициализация базы данных сборки
3. Загрузка конфигурации из исходных файлов
4. Привязка к хранилищу конфигураций
5. Обновление конфигурации базы данных

### git2store - Синхронизация Git → Хранилище

Синхронизация изменений из Git-репозитория в хранилище конфигураций 1С.

#### Синтаксис
```bash
export BR_COMMAND="git2store"
apk-ci
```

#### Переменные окружения
| Переменная | Описание | Обязательная |
|------------|----------|--------------|
| `BR_OWNER` | Владелец репозитория | ✓ |
| `BR_REPO` | Имя репозитория | ✓ |
| `BR_ACCESS_TOKEN` | Токен доступа к Gitea | ✓ |
| `BR_ISSUE_NUMBER` | Номер задачи | - |

#### Пример использования
```bash
export BR_COMMAND="git2store"
export BR_OWNER="development"
export BR_REPO="erp-config"
export BR_ACCESS_TOKEN="your_gitea_token"
export BR_ISSUE_NUMBER="123"
apk-ci
```

#### Описание процесса
1. Клонирование Git-репозитория
2. Создание информационной базы
3. Загрузка конфигурации из файлов
4. Привязка к хранилищу
5. Объединение изменений
6. Сохранение в хранилище

### store2db - Загрузка из хранилища в БД

Загрузка конфигурации из хранилища 1С в информационную базу.

#### Синтаксис
```bash
export BR_COMMAND="store2db"
apk-ci
```

#### Переменные окружения
| Переменная | Описание | Обязательная |
|------------|----------|--------------|
| `BR_INFOBASE_NAME` | Имя информационной базы | ✓ |

#### Пример использования
```bash
export BR_COMMAND="store2db"
export BR_INFOBASE_NAME="TestDB"
apk-ci
```

## Команды управления базами данных

### dbupdate - Обновление конфигурации БД

Применение изменений конфигурации к структуре базы данных.

#### Синтаксис
```bash
export BR_COMMAND="dbupdate"
apk-ci
```

#### Переменные окружения
| Переменная | Описание | Обязательная |
|------------|----------|--------------|
| `BR_INFOBASE_NAME` | Имя информационной базы | ✓ |

#### Пример использования
```bash
export BR_COMMAND="dbupdate"
export BR_INFOBASE_NAME="ProductionDB"
apk-ci
```

#### Описание процесса
1. Инициализация сетевого ключа защиты HASP
2. Загрузка конфигурации из переданных данных
3. Выполнение обновления БД (дважды для обновления расширений)

### dbrestore - Восстановление базы данных

Восстановление информационной базы из резервной копии.

#### Синтаксис
```bash
export BR_COMMAND="dbrestore"
apk-ci
```

#### Переменные окружения
| Переменная | Описание | Обязательная |
|------------|----------|--------------|
| `BR_INFOBASE_NAME` | Имя информационной базы | ✓ |
| `MSSQL_PASSWORD` | Пароль MS SQL Server | ✓ |

#### Пример использования
```bash
export BR_COMMAND="dbrestore"
export BR_INFOBASE_NAME="TestDB"
export MSSQL_PASSWORD="your_password"
apk-ci
```

### create-temp-db - Создание временной БД

Создание временной информационной базы для тестирования.

#### Синтаксис
```bash
export BR_COMMAND="create-temp-db"
apk-ci
```

#### Пример использования
```bash
export BR_COMMAND="create-temp-db"
apk-ci
```

#### Возвращаемые данные
Команда возвращает строку подключения к созданной временной базе.

## Команды сервисного режима

### service-mode-enable - Включение сервисного режима

Включает сервисный режим для информационной базы, блокируя доступ пользователей.

#### Синтаксис
```bash
export BR_COMMAND="service-mode-enable"
apk-ci
```

#### Переменные окружения
| Переменная | Описание | Обязательная |
|------------|----------|--------------|
| `BR_INFOBASE_NAME` | Имя информационной базы | ✓ |
| `RAC_PATH` | Путь к RAC | - |
| `RAC_SERVER` | Сервер 1С | - |
| `RAC_PORT` | Порт RAC | - |
| `RAC_USER` | Пользователь кластера | - |
| `RAC_PASSWORD` | Пароль кластера | - |
| `BR_TERMINATE_SESSIONS` | Завершить активные сессии | - |

#### Пример использования
```bash
export BR_COMMAND="service-mode-enable"
export BR_INFOBASE_NAME="ProductionDB"
export RAC_SERVER="localhost"
export RAC_PORT="1545"
export RAC_USER="admin"
export RAC_PASSWORD="password"
export BR_TERMINATE_SESSIONS="true"
apk-ci
```

#### Описание процесса
1. Подключение к кластеру RAC
2. Поиск информационной базы по имени
3. Включение блокировки сессий (`sessions-deny=on`)
4. Включение блокировки регламентных заданий (`scheduled-jobs-deny=on`)
5. Установка сообщения о сервисном режиме
6. Опциональное завершение активных сессий

### service-mode-disable - Отключение сервисного режима

Отключает сервисный режим, разрешая доступ пользователей к базе.

#### Синтаксис
```bash
export BR_COMMAND="service-mode-disable"
apk-ci
```

#### Переменные окружения
Аналогичны команде `service-mode-enable`, кроме `BR_TERMINATE_SESSIONS`.

#### Пример использования
```bash
export BR_COMMAND="service-mode-disable"
export BR_INFOBASE_NAME="ProductionDB"
export RAC_SERVER="localhost"
apk-ci
```

### service-mode-status - Проверка статуса сервисного режима

Получение текущего статуса сервисного режима информационной базы.

#### Синтаксис
```bash
export BR_COMMAND="service-mode-status"
apk-ci
```

#### Пример использования
```bash
export BR_COMMAND="service-mode-status"
export BR_INFOBASE_NAME="ProductionDB"
apk-ci
```

#### Возвращаемые данные
- Статус сервисного режима (включен/отключен)
- Сообщение блокировки
- Количество активных сессий

## Служебные команды

### storebind - Привязка к хранилищу

Привязка информационной базы к хранилищу конфигураций.

#### Синтаксис
```bash
export BR_COMMAND="storebind"
apk-ci
```

#### Пример использования
```bash
export BR_COMMAND="storebind"
apk-ci
```

### create-stores - Создание хранилищ

Создание хранилищ конфигураций для проекта.

#### Синтаксис
```bash
export BR_COMMAND="create-stores"
apk-ci
```

#### Пример использования
```bash
export BR_COMMAND="create-stores"
apk-ci
```

### action-menu-build - Построение меню действий

Построение интерактивного меню для выбора операций.

#### Синтаксис
```bash
export BR_COMMAND="action-menu-build"
apk-ci
```

#### Пример использования
```bash
export BR_COMMAND="action-menu-build"
apk-ci
```

## Настройка конфигурации

### Файлы конфигурации

#### app.yaml
```yaml
logLevel: "Debug"
workDir: "/tmp/benadis"
tmpDir: "/tmp/benadis/temp"
timeout: 30

paths:
  bin1cv8: "/opt/1cv8/x86_64/8.3.27.1606/1cv8"
  binIbcmd: "/opt/1cv8/x86_64/8.3.27.1606/ibcmd"
  edtCli: "/opt/1C/1CE/components/1c-edt-2024.2.6+7-x86_64/1cedtcli"
  rac: "/opt/1cv8/x86_64/8.3.27.1606/rac"

rac:
  port: 1545
  timeout: 30
  retries: 3
```

#### project.yaml
```yaml
projectName: "MyProject"
storeDb: "local"
addArray:
  - "Extension1"
  - "Extension2"
```

#### dbconfig.yaml
```yaml
databases:
  - name: "TestDB"
    server: "localhost"
    oneServer: "localhost"
    database: "TestDatabase"
```

## Обработка ошибок

### Коды завершения
| Код | Описание |
|-----|----------|
| 0 | Успешное выполнение |
| 2 | Неизвестная команда |
| 5 | Ошибка загрузки конфигурации |
| 6 | Ошибка конвертации |
| 7 | Ошибка обновления хранилища |
| 8 | Ошибка выполнения команды |

### Типичные ошибки

#### "Не удалось загрузить конфигурацию приложения"
**Причина**: Отсутствует или поврежден файл app.yaml  
**Решение**: Проверьте наличие и синтаксис файла конфигурации

#### "Не указано имя информационной базы"
**Причина**: Не установлена переменная `BR_INFOBASE_NAME`  
**Решение**: `export BR_INFOBASE_NAME="YourDatabase"`

#### "Ошибка подключения к кластеру RAC"
**Причина**: Неверные параметры подключения к серверу 1С  
**Решение**: Проверьте переменные `RAC_SERVER`, `RAC_PORT`, `RAC_USER`, `RAC_PASSWORD`

## Примеры сценариев

### Полный цикл развертывания
```bash
#!/bin/bash
# Загрузка конфигурации из Git в хранилище
export BR_COMMAND="git2store"
export BR_OWNER="development"
export BR_REPO="erp-config"
export BR_ACCESS_TOKEN="$GITEA_TOKEN"
apk-ci

# Применение к тестовой базе
export BR_COMMAND="store2db"
export BR_INFOBASE_NAME="TestDB"
apk-ci

# Обновление структуры БД
export BR_COMMAND="dbupdate"
apk-ci
```

### Техническое обслуживание
```bash
#!/bin/bash
# Включение сервисного режима
export BR_COMMAND="service-mode-enable"
export BR_INFOBASE_NAME="ProductionDB"
export BR_TERMINATE_SESSIONS="true"
apk-ci

# Выполнение обслуживания
export BR_COMMAND="dbupdate"
apk-ci

# Отключение сервисного режима
export BR_COMMAND="service-mode-disable"
apk-ci
```

## Логирование

### Уровни логирования
- **Debug**: Детальная отладочная информация
- **Info**: Общая информация о выполнении (по умолчанию)
- **Warn**: Предупреждения
- **Error**: Ошибки выполнения

### Настройка логирования
```bash
export BR_LOG_LEVEL="Debug"
```

### Пример вывода логов
```
2024-08-26T10:30:15.123Z INFO Запуск команды convert
2024-08-26T10:30:15.124Z DEBUG Загрузка конфигурации из app.yaml
2024-08-26T10:30:15.125Z INFO Конвертация успешно завершена
```

---

*Версия документа: 1.0*  
*Последнее обновление: 2025-08-26*