# Архитектура модулей

Данный документ описывает архитектуру модульной системы apk-ci, взаимодействие компонентов и паттерны проектирования.

## Общая архитектура

### Принципы Clean Architecture

apk-ci построен на принципах чистой архитектуры с четким разделением слоев:

```
┌─────────────────────────────────────────────────────────────┐
│                    Внешние интерфейсы                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │     CLI     │ │  Config     │ │   External Tools        │ │
│  │   Commands  │ │   Files     │ │ (1cv8, rac, ibcmd)     │ │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                  Слой приложения                            │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              internal/app/                              │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │ │
│  │  │ Git2Store() │ │ Convert()   │ │ ServiceMode*()      │ │ │
│  │  │ Store2Db()  │ │ DbUpdate()  │ │ DbRestore()         │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                 Бизнес-логика (Usecases)                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │   Service   │ │   Config    │ │       Util              │ │
│  │ Integration │ │ Management  │ │ (runner, templates)     │ │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                  Доменные сущности                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │    One      │ │    Gitea    │ │        RAC              │ │
│  │  Entities   │ │   Entities  │ │      Entities           │ │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Структура модулей

### Основные пакеты

#### cmd/apk-ci
Точка входа приложения, обработка CLI команд и маршрутизация.

**Ключевые файлы:**
- `main.go` — основная логика приложения
- `main_test.go` — тесты основного функционала
- `create_temp_db_test.go` — тесты создания временных БД

#### internal/app
Слой приложения, орхестрация бизнес-процессов.

**Основные функции:**
```go
// Синхронизация Git → Хранилище 1С
func Git2Store(ctx *context.Context, l *slog.Logger, cfg *config.Config) error

// Конвертация конфигураций
func Convert(ctx *context.Context, l *slog.Logger, cfg *config.Config) error

// Загрузка из хранилища в БД
func Store2DbWithConfig(ctx *context.Context, l *slog.Logger, cfg *config.Config) error

// Обновление конфигурации БД
func DbUpdateWithConfig(ctx *context.Context, l *slog.Logger, cfg *config.Config) error

// Восстановление БД
func DbRestoreWithConfig(ctx *context.Context, l *slog.Logger, cfg *config.Config, dbname string) error

// Управление сервисным режимом
func ServiceModeEnable(ctx *context.Context, l *slog.Logger, cfg *config.Config, infobaseName string, terminateSessions bool) error
func ServiceModeDisable(ctx *context.Context, l *slog.Logger, cfg *config.Config, infobaseName string) error
func ServiceModeStatus(ctx *context.Context, l *slog.Logger, cfg *config.Config, infobaseName string) error

// Создание временных ресурсов
func CreateTempDbWrapper(ctx *context.Context, l *slog.Logger, cfg *config.Config) (string, error)
func CreateStoresWrapper(ctx *context.Context, l *slog.Logger, cfg *config.Config) error

// Привязка к хранилищу
func StoreBind(ctx *context.Context, l *slog.Logger, cfg *config.Config) error

// Построение меню действий
func ActionMenuBuildWrapper(ctx *context.Context, l *slog.Logger, cfg *config.Config) error
```

#### internal/config
Централизованная система управления конфигурацией.

**Структуры конфигурации:**
```go
// Основная конфигурация приложения
type Config struct {
    AppConfig     *AppConfig
    ProjectConfig *ProjectConfig  
    SecretConfig  *SecretConfig
    DbConfig      *DbConfig
    // ... другие поля
}

// Конфигурация приложения (app.yaml)
type AppConfig struct {
    LogLevel string
    WorkDir  string
    TmpDir   string
    Timeout  int
    Paths    struct {
        Bin1cv8  string
        BinIbcmd string
        EdtCli   string
        Rac      string
    }
    // ... другие поля
}
```

## Доменные модули

### internal/entity/one
Модуль работы с платформой 1С:Предприятие.

#### internal/entity/one/convert
Конвертация конфигураций между форматами.

**Основные структуры:**
```go
// Конфигурация процесса конвертации
type ConvertConfig struct {
    StoreRoot   string         `json:"Корень хранилища"`
    OneDB       designer.OneDb `json:"Параметры подключения"`
    ConvertPair []ConvertPair  `json:"Сопоставления"`
}

// Пара источник-назначение для конвертации
type ConvertPair struct {
    Source Source      `json:"Источник"`
    Store  store.Store `json:"Хранилище"`
}

// Источник конфигурации
type Source struct {
    Name    string `json:"Имя"`
    RelPath string `json:"Относительный путь"`
    Main    bool   `json:"Основная конфигурация"`
}
```

**Ключевые методы:**
```go
// Загрузка конфигурации из данных
func LoadFromConfig(ctx *context.Context, l *slog.Logger, cfg *config.Config) (*ConvertConfig, error)

// Загрузка из JSON данных
func LoadConfigFromData(ctx *context.Context, l *slog.Logger, data []byte) (*ConvertConfig, error)

// Инициализация БД
func (cc *ConvertConfig) InitDb(ctx *context.Context, l *slog.Logger, cfg *config.Config) error

// Загрузка в БД
func (cc *ConvertConfig) LoadDb(ctx *context.Context, l *slog.Logger, cfg *config.Config) error

// Обновление БД
func (cc *ConvertConfig) DbUpdate(ctx *context.Context, l *slog.Logger, cfg *config.Config) error

// Привязка к хранилищу
func (cc *ConvertConfig) StoreBind(ctx *context.Context, l *slog.Logger, cfg *config.Config) error
```

#### internal/entity/one/designer
Работа с дизайнером 1С и информационными базами.

**Основная структура:**
```go
// Конфигурация информационной базы
type OneDb struct {
    DbConnectString   string `json:"Строка соединения,omitempty"`
    User              string `json:"Пользователь,omitempty"`
    Pass              string `json:"Пароль,omitempty"`
    FullConnectString string
    ServerDb          bool
    DbExist           bool
}
```

**Методы жизненного цикла БД:**
```go
// Создание новой информационной базы
func (odb *OneDb) Create(ctx *context.Context, l *slog.Logger, cfg *config.Config) error

// Загрузка конфигурации из файлов
func (odb *OneDb) Load(ctx context.Context, l *slog.Logger, cfg *config.Config, sourcePath string, extensionName ...string) error

// Обновление конфигурации БД
func (odb *OneDb) UpdateCfg(ctx context.Context, l *slog.Logger, cfg *config.Config, extensionName ...string) error

// Выгрузка конфигурации
func (odb *OneDb) Dump(ctx context.Context, l *slog.Logger, cfg *config.Config, targetPath string, extensionName ...string) error

// Выгрузка в файлы исходного кода
func (odb *OneDb) DumpToFiles(ctx context.Context, l *slog.Logger, cfg *config.Config, targetPath string, extensionName ...string) error
```

**Методы работы с расширениями:**
```go
// Создание расширения
func (odb *OneDb) Add(ctx context.Context, l *slog.Logger, cfg *config.Config, nameAdd string) error

// Загрузка расширения
func (odb *OneDb) LoadAdd(ctx context.Context, l *slog.Logger, cfg *config.Config, sourcePath string, nameAdd string) error

// Обновление расширения
func (odb *OneDb) UpdateAdd(ctx context.Context, l *slog.Logger, cfg *config.Config, nameAdd string) error

// Выгрузка расширения
func (odb *OneDb) DumpAdd(ctx context.Context, l *slog.Logger, cfg *config.Config, targetPath string, nameAdd string) error
```

#### internal/entity/one/store
Работа с хранилищем конфигураций 1С.

**Основные структуры:**
```go
// Хранилище конфигурации
type Store struct {
    Name    string `json:"Имя хранилища,omitempty"`
    Path    string `json:"Относительный путь"`
    User    string `json:"Пользователь"`
    Pass    string `json:"Пароль"`
    Command string `json:"-"`
}

// Запись в хранилище
type StoreRecord struct {
    Version     int       `json:"Версия хранилища"`
    ConfVersion string    `json:"Версия конфигурации"`
    User        string    `json:"Пользователь"`
    Date        time.Time `json:"Дата время"`
    Comment     string    `json:"Комментарий,omitempty"`
}

// Пользователь хранилища
type User struct {
    StoreUserName string `json:"Имя пользователя в хранилище"`
    GitUserName   string `json:"Имя пользователя в Git"`
}
```

**Основные операции:**
```go
// Создание хранилища
func (s *Store) Create(l *slog.Logger, dbConnectString string, cfg *config.Config) error

// Привязка к хранилищу
func (s *Store) Bind(l *slog.Logger, dbConnectString string, cfg *config.Config) error

// Отключение от хранилища
func (s *Store) UnBind(l *slog.Logger, dbConnectString string, cfg *config.Config) error

// Помещение изменений в хранилище
func (s *Store) Commit(l *slog.Logger, dbConnectString string, cfg *config.Config, comment string) error

// Получение изменений из хранилища
func (s *Store) Update(l *slog.Logger, dbConnectString string, cfg *config.Config) error

// Блокировка объектов в хранилище
func (s *Store) Lock(l *slog.Logger, dbConnectString string, cfg *config.Config) error

// Объединение конфигураций
func (s *Store) Merge(l *slog.Logger, dbConnectString string, cfg *config.Config, mergeConfig string) error

// Получение отчета хранилища
func (s *Store) ReadReport(l *slog.Logger, dbConnectString string, cfg *config.Config, startVersion int) ([]StoreRecord, []User, int, error)
```

#### internal/entity/one/edt
Интеграция с EDT (Enterprise Development Tools).

```go
// Конфигурация EDT
type EdtConfig struct {
    EdtCliPath  string `json:"Путь к EDT CLI"`
    WorkDir     string `json:"Рабочая директория"`
    ProjectPath string `json:"Путь к проекту"`
}
```

### internal/entity/gitea
Интеграция с Gitea API.

**Основные структуры:**
```go
// Клиент Gitea API
type Client struct {
    BaseURL string
    Token   string
    Owner   string
    Repo    string
    // ... другие поля
}

// Информация о репозитории
type Repository struct {
    ID          int    `json:"id"`
    Name        string `json:"name"`
    FullName    string `json:"full_name"`
    Description string `json:"description"`
    // ... другие поля
}

// Pull Request
type PullRequest struct {
    ID     int    `json:"id"`
    Number int    `json:"number"`
    Title  string `json:"title"`
    State  string `json:"state"`
    // ... другие поля
}
```

**API методы:**
```go
// Получение информации о репозитории
func (c *Client) GetRepository(ctx context.Context) (*Repository, error)

// Создание Pull Request
func (c *Client) CreatePR(ctx context.Context, title, head, base, body string) (*PullRequest, error)

// Получение списка открытых PR
func (c *Client) ActivePR(ctx context.Context) ([]PullRequest, error)

// Закрытие Pull Request
func (c *Client) ClosePR(ctx context.Context, prNumber int) error

// Создание комментария к issue
func (c *Client) CreateIssueComment(ctx context.Context, issueNumber int, body string) error
```

### internal/rac
Интеграция с RAC (Remote Administration Console).

**Основные структуры:**
```go
// Клиент RAC
type Client struct {
    Server     string
    Port       int
    User       string
    Password   string
    DbUser     string
    DbPassword string
    Timeout    time.Duration
    Logger     *slog.Logger
}

// Статус сервисного режима
type ServiceModeStatus struct {
    Enabled        bool
    Message        string
    ActiveSessions int
}

// Информация о сессии
type SessionInfo struct {
    SessionID    string
    UserName     string
    AppID        string
    StartedAt    time.Time
    LastActiveAt time.Time
}
```

**Основные операции:**
```go
// Включение сервисного режима
func (c *Client) EnableServiceMode(ctx context.Context, clusterUUID, infobaseUUID string, terminateSessions bool) error

// Отключение сервисного режима
func (c *Client) DisableServiceMode(ctx context.Context, clusterUUID, infobaseUUID string) error

// Получение статуса сервисного режима
func (c *Client) GetServiceModeStatus(ctx context.Context, clusterUUID, infobaseUUID string) (*ServiceModeStatus, error)

// Получение списка сессий
func (c *Client) GetSessions(ctx context.Context, clusterUUID, infobaseUUID string) ([]SessionInfo, error)

// Завершение всех сессий
func (c *Client) TerminateAllSessions(ctx context.Context, clusterUUID, infobaseUUID string) error
```

### internal/servicemode
Высокоуровневый модуль управления сервисным режимом.

```go
// Клиент сервисного режима
type Client struct {
    racClient *rac.Client
    config    *config.Config
    logger    *slog.Logger
}

// Основные операции
func (c *Client) EnableServiceMode(ctx context.Context, infobaseName string, terminateSessions bool) error
func (c *Client) DisableServiceMode(ctx context.Context, infobaseName string) error
func (c *Client) GetServiceModeStatus(ctx context.Context, infobaseName string) (*rac.ServiceModeStatus, error)
```

## Сервисный слой

### internal/service
Сервисы интеграции и орхестрации.

#### internal/service/gitea_service.go
```go
// Сервис Gitea интеграции
type GiteaService struct {
    client      GiteaAPIClient
    gitOps      GitOperations
    config      *config.Config
    logger      *slog.Logger
}

// Основные операции
func (s *GiteaService) CloneRepository(ctx context.Context, owner, repo, targetDir string) error
func (s *GiteaService) CreatePullRequest(ctx context.Context, title, head, base, body string) (*gitea.PullRequest, error)
func (s *GiteaService) ProcessIssue(ctx context.Context, issueNumber int) error
```

#### internal/service/config_analyzer.go
```go
// Анализатор конфигурации
type ConfigAnalyzer struct {
    config *config.Config
    logger *slog.Logger
}

// Анализ проекта
func (ca *ConfigAnalyzer) AnalyzeProject(ctx context.Context) (*ProjectAnalysis, error)
func (ca *ConfigAnalyzer) ValidateConfiguration() error
```

### internal/util
Утилиты и вспомогательные компоненты.

#### internal/util/runner
Исполнитель внешних команд.

```go
// Исполнитель команд
type Runner struct {
    RunString  string   // Путь к исполняемому файлу
    Params     []string // Параметры командной строки
    WorkDir    string   // Рабочая директория
    TmpDir     string   // Временная директория
    ConsoleOut []byte   // Вывод в консоль
    FileOut    []byte   // Вывод в файл
}

// Выполнение команды
func (r *Runner) RunCommand(l *slog.Logger) ([]byte, error)
```

#### internal/util/template_processor.go
Обработчик шаблонов конфигурации.

```go
// Результат обработки шаблона
type TemplateResult struct {
    Name    string
    Content string
}

// Процессор шаблонов
type TemplateProcessor struct {
    logger *slog.Logger
}

// Обработка шаблонов
func (tp *TemplateProcessor) ProcessTemplates(ctx context.Context, templates []string, data interface{}) ([]TemplateResult, error)
```

## Паттерны взаимодействия

### Dependency Injection
Все модули получают зависимости через конструкторы или методы:

```go
// Пример создания клиента сервисного режима
func NewServiceModeClient(racClient *rac.Client, config *config.Config, logger *slog.Logger) *Client {
    return &Client{
        racClient: racClient,
        config:    config,
        logger:    logger,
    }
}
```

### Context Propagation
Все операции используют контекст для отмены и таймаутов:

```go
func (s *Store) Create(ctx context.Context, l *slog.Logger, dbConnectString string, cfg *config.Config) error {
    select {
    case <-ctx.Done():
        return ctx.Err()
    default:
        // Выполнение операции
    }
}
```

### Error Wrapping
Ошибки оборачиваются с контекстом:

```go
_, err := r.RunCommand(l)
if err != nil {
    return fmt.Errorf("failed to create store %s: %w", s.Name, err)
}
```

### Interface Segregation
Интерфейсы разделены по функциональности:

```go
// Интерфейс для операций с Git
type GitOperations interface {
    Clone(ctx context.Context, url, dir string) error
    Pull(ctx context.Context, dir string) error
    Checkout(ctx context.Context, dir, branch string) error
}

// Интерфейс для Gitea API
type GiteaAPIClient interface {
    GetRepository(ctx context.Context) (*Repository, error)
    CreatePR(ctx context.Context, title, head, base, body string) (*PullRequest, error)
    ClosePR(ctx context.Context, prNumber int) error
}
```

## Потоки данных

### Git2Store Flow
```
Git Repository → Clone → Load to OneDb → Bind to Store → Merge → Commit to Store
```

### Store2Db Flow  
```
Configuration Store → Connect to Store → Update from Store → Update Database Configuration
```

### Service Mode Flow
```
RAC Connection → Get Cluster UUID → Get Infobase UUID → Enable/Disable Service Mode → Terminate Sessions
```

## Обработка ошибок

### Стратегия обработки ошибок
1. **Fail Fast**: Немедленное прекращение при критических ошибках
2. **Graceful Degradation**: Продолжение работы при некритических ошибках
3. **Retry Logic**: Повторные попытки для сетевых операций
4. **Detailed Logging**: Подробное логирование для диагностики

### Типы ошибок
```go
// Ошибка конфигурации
type ConfigError struct {
    Field   string
    Value   string
    Message string
}

// Ошибка выполнения команды
type CommandError struct {
    Command  string
    ExitCode int
    Output   string
}

// Ошибка сети
type NetworkError struct {
    Operation string
    Endpoint  string
    Cause     error
}
```

## Тестирование

### Unit Tests
Каждый модуль имеет собственные unit тесты:
- `*_test.go` файлы рядом с исходным кодом
- Моки для внешних зависимостей
- Table-driven tests для множественных сценариев

### Integration Tests
Интеграционные тесты для проверки взаимодействия модулей:
- `integration_test.go` файлы
- Реальные подключения к тестовым средам
- End-to-end сценарии

### Мониторинг производительности
- Бенчмарки для критических операций
- Профилирование памяти и CPU
- Метрики времени выполнения

---

*Версия документа: 1.0*  
*Последнее обновление: 2025-08-26*