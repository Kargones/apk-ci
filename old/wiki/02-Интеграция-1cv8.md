# Интеграция с платформой 1cv8

Данный документ описывает интеграцию benadis-runner с платформой 1С:Предприятие и использование командных интерфейсов 1cv8.

## Обзор платформы 1С:Предприятие

### Основные компоненты
- **1cv8** — основной исполняемый файл платформы 1С:Предприятие
- **ibcmd** — утилита командной строки для работы с информационными базами
- **rac** — консоль удаленного администрирования (Remote Administration Console)
- **1cedtcli** — интерфейс командной строки для EDT (Enterprise Development Tools)

### Архитектура платформы
```
┌─────────────────────────────────────────────────────────────┐
│                 benadis-runner                               │
├─────────────────────────────────────────────────────────────┤
│  internal/entity/one/designer/  │  internal/rac/            │
│  ┌─────────────────────────────┐ │  ┌─────────────────────┐  │
│  │        OneDb               │ │  │     RAC Client      │  │
│  │  ┌─────────────────────────┐ │ │  │                     │  │
│  │  │ Create()               │ │ │  │ EnableServiceMode() │  │
│  │  │ Load()                 │ │ │  │ DisableServiceMode()│  │
│  │  │ Update()               │ │ │  │ GetSessions()       │  │
│  │  │ Dump()                 │ │ │  │                     │  │
│  │  └─────────────────────────┘ │ │  └─────────────────────┘  │
│  └─────────────────────────────┘ │                           │
├─────────────────────────────────────────────────────────────┤
│                    Внешние инструменты                       │
├─────────────────────────────────────────────────────────────┤
│ 1cv8 DESIGNER │ ibcmd │ rac │ 1cedtcli │ HASP NetHASP        │
└─────────────────────────────────────────────────────────────┘
```

## Конфигурация путей к исполняемым файлам

### Настройка в app.yaml
```yaml
paths:
  bin1cv8: "/opt/1cv8/x86_64/8.3.27.1606/1cv8"
  binIbcmd: "/opt/1cv8/x86_64/8.3.27.1606/ibcmd" 
  edtCli: "/opt/1C/1CE/components/1c-edt-2024.2.6+7-x86_64/1cedtcli"
  rac: "/opt/1cv8/x86_64/8.3.27.1606/rac"
```

### Переменные окружения
```bash
export Bin1cv8="/opt/1cv8/x86_64/8.3.27.1606/1cv8"
export BinIbcmd="/opt/1cv8/x86_64/8.3.27.1606/ibcmd"
export EdtCli="/opt/1C/1CE/components/1c-edt-2024.2.6+7-x86_64/1cedtcli"
export RacPath="/opt/1cv8/x86_64/8.3.27.1606/rac"
```

## Работа с информационными базами (OneDb)

### Структура OneDb

Структура `OneDb` представляет конфигурацию базы данных 1С:Предприятие:

```go
type OneDb struct {
    DbConnectString   string `json:"Строка соединения,omitempty"`
    User              string `json:"Пользователь,omitempty"`
    Pass              string `json:"Пароль,omitempty"`
    FullConnectString string
    ServerDb          bool
    DbExist           bool
}
```

### Создание информационной базы

#### Create() - создание новой базы данных
```go
func (odb *OneDb) Create(ctx *context.Context, l *slog.Logger, cfg *config.Config) error
```

**Выполняемая команда:**
```bash
ibcmd infobase create --create-database --db-path="/path/to/database"
```

**Процесс создания:**
1. Получение пути к базе данных из конфигурации
2. Вызов `ibcmd` с параметрами создания
3. Проверка успешности создания по сообщению в выводе
4. Настройка строк подключения

### Загрузка конфигурации

#### Load() - загрузка конфигурации из файлов
```go
func (odb *OneDb) Load(ctx context.Context, l *slog.Logger, cfg *config.Config, 
                       sourcePath string, extensionName ...string) error
```

**Выполняемая команда для основной конфигурации:**
```bash
1cv8 DESIGNER /F "/path/to/database" /LoadConfigFromFiles "/path/to/source" 
     /DisableStartupDialogs /DisableStartupMessages /DisableUnrecoverableErrorMessage 
     /Out "/c Загрузка из файлов основной конфигурации"
```

**Выполняемая команда для расширения:**
```bash
1cv8 DESIGNER /F "/path/to/database" /LoadConfigFromFiles "/path/to/source" 
     -Extension "ExtensionName" /DisableStartupDialogs /DisableStartupMessages 
     /DisableUnrecoverableErrorMessage /Out "/c Загрузка из файлов расширения"
```

### Обновление конфигурации

#### UpdateCfg() - обновление конфигурации БД
```go
func (odb *OneDb) UpdateCfg(ctx context.Context, l *slog.Logger, cfg *config.Config, 
                            extensionName ...string) error
```

**Выполняемая команда:**
```bash
1cv8 DESIGNER /F "/path/to/database" /UpdateDBCfg 
     /DisableStartupDialogs /DisableStartupMessages /DisableUnrecoverableErrorMessage 
     /Out "/c Обновление конфигурации БД"
```

### Выгрузка конфигурации

#### Dump() - сохранение конфигурации в файл
```go
func (odb *OneDb) Dump(ctx context.Context, l *slog.Logger, cfg *config.Config, 
                       targetPath string, extensionName ...string) error
```

**Выполняемая команда:**
```bash
1cv8 DESIGNER /F "/path/to/database" /DumpCfg "/path/to/target.cf" 
     /DisableStartupDialogs /DisableStartupMessages /DisableUnrecoverableErrorMessage 
     /Out "/c Выгрузка конфигурации"
```

#### DumpToFiles() - выгрузка в файлы исходного кода
```go
func (odb *OneDb) DumpToFiles(ctx context.Context, l *slog.Logger, cfg *config.Config, 
                              targetPath string, extensionName ...string) error
```

**Выполняемая команда:**
```bash
1cv8 DESIGNER /F "/path/to/database" /DumpConfigToFiles "/path/to/target/dir" 
     /DisableStartupDialogs /DisableStartupMessages /DisableUnrecoverableErrorMessage 
     /Out "/c Выгрузка конфигурации в файлы"
```

## Работа с расширениями

### Создание расширения

#### Add() - создание нового расширения
```go
func (odb *OneDb) Add(ctx context.Context, l *slog.Logger, cfg *config.Config, 
                      nameAdd string) error
```

**Выполняемая команда:**
```bash
ibcmd extension create --db-path="/path/to/database" --name="ExtensionName" --name-prefix="p"
```

### Загрузка расширения

Расширения загружаются через метод `Load()` с указанием имени расширения:

```go
err := oneDb.Load(ctx, logger, config, "/path/to/extension/source", "ExtensionName")
```

### Обновление расширения

#### UpdateAdd() - обновление расширения
```go
func (odb *OneDb) UpdateAdd(ctx context.Context, l *slog.Logger, cfg *config.Config, 
                            nameAdd string) error
```

## Работа с хранилищем конфигураций

### Структура Store

```go
type Store struct {
    Name    string `json:"Имя хранилища,omitempty"`
    Path    string `json:"Относительный путь"`
    User    string `json:"Пользователь"`
    Pass    string `json:"Пароль"`
    Command string `json:"-"`
}
```

### Основные операции с хранилищем

#### Создание хранилища
```bash
1cv8 DESIGNER /F "/path/to/database" /ConfigurationRepositoryF "tcp://server/store" 
     /ConfigurationRepositoryN "Username" /ConfigurationRepositoryP "Password" 
     /ConfigurationRepositoryCreate -AllowConfigurationChanges 
     -ChangesAllowedRule ObjectNotEditable -ChangesNotRecommendRule ObjectNotEditable
```

#### Привязка к хранилищу
```bash
1cv8 DESIGNER /F "/path/to/database" /ConfigurationRepositoryF "tcp://server/store" 
     /ConfigurationRepositoryN "Username" /ConfigurationRepositoryP "Password" 
     /ConfigurationRepositoryBindCfg
```

#### Помещение изменений в хранилище
```bash
1cv8 DESIGNER /F "/path/to/database" /ConfigurationRepositoryF "tcp://server/store" 
     /ConfigurationRepositoryN "Username" /ConfigurationRepositoryP "Password" 
     /ConfigurationRepositoryCommitCfg -comment "Commit message"
```

#### Получение изменений из хранилища
```bash
1cv8 DESIGNER /F "/path/to/database" /ConfigurationRepositoryF "tcp://server/store" 
     /ConfigurationRepositoryN "Username" /ConfigurationRepositoryP "Password" 
     /ConfigurationRepositoryUpdateCfg
```

### Отчеты хранилища

#### ReadReport() - получение отчета хранилища
```go
func (s *Store) ReadReport(l *slog.Logger, dbConnectString string, cfg *config.Config, 
                          startVersion int) ([]StoreRecord, []User, int, error)
```

**Выполняемая команда:**
```bash
1cv8 DESIGNER /F "/path/to/database" /ConfigurationRepositoryF "tcp://server/store" 
     /ConfigurationRepositoryN "Username" /ConfigurationRepositoryP "Password" 
     /ConfigurationRepositoryReport "/path/to/report.txt" -NBegin "1" -ReportFormat "txt"
```

## Управление сервисным режимом через RAC

### Структура RAC Client

```go
type Client struct {
    Server     string
    Port       int
    User       string
    Password   string
    DbUser     string
    DbPassword string
    Timeout    time.Duration
    Logger     *slog.Logger
}
```

### Включение сервисного режима

#### EnableServiceMode() - включение сервисного режима
```go
func (c *Client) EnableServiceMode(ctx context.Context, clusterUUID, infobaseUUID string, 
                                  terminateSessions bool) error
```

**Выполняемая команда:**
```bash
rac infobase update --cluster="cluster-uuid" --infobase="infobase-uuid" 
    --denied-from="2024-08-26T10:30:00" --denied-message="Сервисный режим" 
    --permission-code="ServiceMode" --sessions-deny=on --scheduled-jobs-deny=on 
    --cluster-user="admin" --cluster-pwd="password"
```

### Отключение сервисного режима

#### DisableServiceMode() - отключение сервисного режима
```go
func (c *Client) DisableServiceMode(ctx context.Context, clusterUUID, infobaseUUID string) error
```

**Выполняемая команда:**
```bash
rac infobase update --cluster="cluster-uuid" --infobase="infobase-uuid" 
    --denied-from="" --denied-message="" --permission-code="" 
    --sessions-deny=off --scheduled-jobs-deny=off
```

### Получение статуса

#### GetServiceModeStatus() - проверка статуса сервисного режима
```go
func (c *Client) GetServiceModeStatus(ctx context.Context, clusterUUID, infobaseUUID string) 
                                     (*ServiceModeStatus, error)
```

### Управление сессиями

#### GetSessions() - получение списка активных сессий
```go
func (c *Client) GetSessions(ctx context.Context, clusterUUID, infobaseUUID string) 
                            ([]SessionInfo, error)
```

#### TerminateSession() - завершение конкретной сессии
```go
func (c *Client) TerminateSession(ctx context.Context, clusterUUID, sessionUUID string) error
```

#### TerminateAllSessions() - завершение всех сессий
```go
func (c *Client) TerminateAllSessions(ctx context.Context, clusterUUID, infobaseUUID string) error
```

## Интеграция с HASP NetHASP

### Инициализация сетевого ключа

Функция `NetHaspInit()` настраивает подключение к серверу лицензий HASP:

```go
func NetHaspInit(ctx *context.Context, l *slog.Logger)
```

**Создаваемый файл конфигурации `/opt/1cv8/conf/nethasp.ini`:**
```ini
[NH_COMMON]
NH_IPX=Disabled
NH_NETBIOS=Disabled        
NH_TCPIP=Enabled

[NH_TCPIP]
NH_SERVER_ADDR = 10.50.69.155
NH_PORT_NUMBER = 475
NH_USE_BROADCAST=Disabled
NH_TCPIP_METHOD = TCP
```

## Параметры командной строки 1cv8

### Общие параметры

| Параметр | Описание | Пример |
|----------|----------|--------|
| `/F` | Путь к информационной базе | `/F "C:\Databases\MyDB"` |
| `/S` | Строка подключения к серверу | `/S "server\database"` |
| `/N` | Имя пользователя | `/N "Administrator"` |
| `/P` | Пароль пользователя | `/P "password"` |
| `/UC` | Код блокировки | `/UC "LockCode"` |

### Параметры DESIGNER

| Параметр | Описание |
|----------|----------|
| `/LoadConfigFromFiles` | Загрузка конфигурации из файлов |
| `/DumpConfigToFiles` | Выгрузка конфигурации в файлы |
| `/UpdateDBCfg` | Обновление конфигурации БД |
| `/DumpCfg` | Выгрузка конфигурации в файл .cf |
| `/ConfigurationRepositoryF` | Путь к хранилищу конфигурации |
| `/ConfigurationRepositoryCreate` | Создание хранилища |
| `/ConfigurationRepositoryBindCfg` | Привязка к хранилищу |
| `/ConfigurationRepositoryCommitCfg` | Помещение в хранилище |
| `/ConfigurationRepositoryUpdateCfg` | Получение из хранилища |

### Параметры отключения интерфейса

| Параметр | Описание |
|----------|----------|
| `/DisableStartupDialogs` | Отключение диалогов запуска |
| `/DisableStartupMessages` | Отключение сообщений запуска |
| `/DisableUnrecoverableErrorMessage` | Отключение сообщений о критических ошибках |

## Обработка ошибок

### Поиск сообщений об успехе

benadis-runner анализирует вывод команд 1cv8 для определения успешности операций:

```go
// Константы сообщений об успехе
const (
    SearchMsgBaseCreateOk = "Создание информационной базы успешно завершено"
    SearchMsgBaseLoadOk   = "Обновление конфигурации успешно завершено"
    SearchMsgBaseDumpOk   = "Сохранение конфигурации успешно завершено"
    SearchMsgStoreBindOk  = "Подключение информационной базы к хранилищу успешно завершено"
    SearchMsgStoreCommitOk = "Помещение изменений объектов в хранилище успешно завершено"
)
```

### Типичные ошибки и решения

#### "Неопознанная ошибка создания базы данных"
**Причина**: Вывод 1cv8 не содержит ожидаемого сообщения об успехе  
**Решение**: Проверить права доступа к директории БД и корректность пути

#### "Ошибка загрузки файлов конфигурации"
**Причина**: Неверный путь к исходным файлам или поврежденные файлы  
**Решение**: Проверить существование и структуру исходных файлов

#### "Ошибка подключения к хранилищу"
**Причина**: Неверные параметры подключения к хранилищу  
**Решение**: Проверить URL хранилища, учетные данные и сетевую доступность

## Примеры интеграции

### Создание и настройка новой базы
```go
oneDb := &designer.OneDb{}
err := oneDb.Create(ctx, logger, config)
if err != nil {
    return err
}

err = oneDb.Load(ctx, logger, config, "/path/to/config/files")
if err != nil {
    return err
}

err = oneDb.UpdateCfg(ctx, logger, config)
if err != nil {
    return err
}
```

### Работа с расширениями
```go
// Создание расширения
err := oneDb.Add(ctx, logger, config, "MyExtension")
if err != nil {
    return err
}

// Загрузка файлов расширения
err = oneDb.Load(ctx, logger, config, "/path/to/extension", "MyExtension")
if err != nil {
    return err
}

// Обновление расширения
err = oneDb.UpdateAdd(ctx, logger, config, "MyExtension")
if err != nil {
    return err
}
```

### Управление сервисным режимом
```go
racClient := &rac.Client{
    Server:   "localhost",
    Port:     1545,
    User:     "admin",
    Password: "password",
    Logger:   logger,
}

// Получение UUID кластера и базы
clusterUUID, err := racClient.GetClusterUUID(ctx)
if err != nil {
    return err
}

infobaseUUID, err := racClient.GetInfobaseUUID(ctx, clusterUUID, "MyDatabase")
if err != nil {
    return err
}

// Включение сервисного режима
err = racClient.EnableServiceMode(ctx, clusterUUID, infobaseUUID, true)
if err != nil {
    return err
}
```

## Мониторинг и диагностика

### Логирование операций 1cv8

Все команды 1cv8 логируются с указанием:
- Выполняемой команды
- Параметров запуска
- Кода завершения
- Содержимого вывода

### Таймауты операций

Настройка таймаутов в `app.yaml`:
```yaml
timeout: 30  # Общий таймаут в секундах

rac:
  timeout: 30  # Таймаут для RAC операций
  retries: 3   # Количество повторных попыток
```

### Отладка проблем

1. **Увеличение уровня логирования:**
   ```bash
   export BR_LOG_LEVEL="Debug"
   ```

2. **Проверка вывода команд 1cv8:**
   Логи содержат полный вывод команд для диагностики проблем

3. **Проверка файлов конфигурации:**
   Убедиться в корректности путей к исполняемым файлам в `app.yaml`

---

*Версия документа: 1.0*  
*Последнее обновление: 2025-08-26*