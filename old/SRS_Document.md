# Software Requirements Specification (SRS)
# Benadis Runner Next

## Версия документа: 1.0
## Дата создания: 2024

---

## 1. Введение

### 1.1 Назначение документа
Данный документ содержит полную спецификацию требований к программному обеспечению Benadis Runner Next - системе автоматизации DevOps процессов для платформы 1C:Enterprise. Документ предназначен для разработки архитектуры проекта и реализации программного обеспечения, полностью воспроизводящего текущий функционал.

### 1.2 Область применения
Benadis Runner Next представляет собой модульную систему автоматизации, обеспечивающую:
- Интеграцию с системами контроля версий (Git, Gitea)
    - Проверка конфликтов слияния всех веток для которых есть PR в основную
- Интеграция с SonarQube для анализа кода
    - Создание проекта в SonarQube
    - Запуск сканирования кода
    - Получение результатов сканирования
    - Отображение проблем в Gitea Issues
    - Уведомление разработчиков о проблемах
- Управление жизненным циклом конфигураций 1C:Enterprise
    - Создание конфигурации
    - Обновление конфигурации
    - Применение конфигурации для тестовых и продуктивных баз
- Поддержка разработки в 1C EDT
    - Конвертация конфигурации в формат 1C
    - Синхронизация сконвертированной конфигурации с хранилищем конфигураций 1C
- Автоматизацию процессов разработки и развертывания баз 1С
    - Создание базы 1С
    - Обновление базы 1С
    - Применение конфигурации базы 1С
    - Удаление базы 1С
    - Создание резервной копии базы 1С
    - Восстановление базы 1С из резервной копии
- Восстановление баз данных из исторических резервных копий
- Управление сервисным режимом информационных баз

### 1.3 Определения и сокращения
- **1C** - платформа 1C:Enterprise
- **EDT** - Enterprise Development Tools
- **Gitea** - система управления Git-репозиториями
- **SRS** - Software Requirements Specification
- **EARS** - Easy Approach to Requirements Syntax
- **API** - Application Programming Interface
- **CLI** - Command Line Interface

### 1.4 Запреты действующие на весь проект
- Запрещено рассматривать вопросы касающиеся развертывания данного приложения. Как то:
    - Контейнеризация
    - Docker контейнеризация
    - Kubernetes
    - Helm
    - Terraform
    - Ansible
    - SaltStack
    - Puppet
    - Chef
- Запрещено рассматривать вопросы касающиеся развертывания данного приложения на облачных платформах. Как то:
    - AWS
    - Azure
    - GCP
- Запрещено рассматривать вопросы взаимодействия с git серверами кроме gitea 1.24+
- Запрещено рассматривать вопросы мониторинга с помощью внешних инструментов.
---

## 2. User Stories

### US-001: Разработчик 1C
**Как** разработчик 1C  
**Я хочу** синхронизировать изменения между Git-репозиторием и хранилищем конфигураций 1C  
**Чтобы** обеспечить версионный контроль и совместную разработку

### US-002: DevOps инженер
**Как** DevOps инженер  
**Я хочу** автоматизировать процессы развертывания и восстановления баз данных  
**Чтобы** минимизировать время простоя и человеческие ошибки

### US-003: Администратор системы
**Как** администратор системы  
**Я хочу** управлять сервисным режимом информационных баз  
**Чтобы** безопасно выполнять административные операции

### US-004: Менеджер проекта
**Как** менеджер проекта  
**Я хочу** отслеживать задачи и изменения через интеграцию с Gitea Issues  
**Чтобы** контролировать процесс разработки

---

## 3. Требования по категориям EARS

### 3.1 Ubiquitous (Повсеместные требования)

**REQ-001**: СИСТЕМА ДОЛЖНА обеспечивать загрузку конфигурации из множественных источников (переменные окружения, файлы конфигурации, параметры командной строки, GitHub Actions).  
**Критерии приемки**: Конфигурация успешно загружается из всех поддерживаемых источников с приоритетом переменных окружения.

**REQ-002**: СИСТЕМА ДОЛЖНА поддерживать логирование всех операций с настраиваемым уровнем детализации.  
**Критерии приемки**: Логи содержат временные метки, уровни важности и детальную информацию об операциях, включая стек вызовов, имя модуля и номер строки.

**REQ-003**: СИСТЕМА ДОЛЖНА обеспечивать валидацию входных параметров перед выполнением операций.  
**Критерии приемки**: Некорректные параметры отклоняются с информативными сообщениями об ошибках.

**REQ-004**: СИСТЕМА ДОЛЖНА поддерживать работу с абсолютными и относительными путями к файлам и директориям.  
**Критерии приемки**: Все файловые операции корректно обрабатывают различные форматы путей.

### 3.2 Event-driven (Событийные требования)

**REQ-005**: КОГДА пользователь запускает команду `git2store`, СИСТЕМА ДОЛЖНА выполнить последовательность: клонирование Git-репозитория → конвертация из формата EDT в XML → переключение репозитория на ветку xml → очистку всех файлов и каталогов кроме файлов и каталогов начинающихся с точки  → копирование файлов и каталогов из каталога с сконверированными в формат xml файлами проекта → коммит в репозиторий git → push в Gitea.  
**Критерии приемки**: Все этапы выполняются последовательно, при ошибке на любом этапе процесс прерывается с детальным сообщением.


**REQ-007**: КОГДА пользователь запускает команду `dbrestore`, СИСТЕМА ДОЛЖНА восстановить базу данных из указанной резервной копии.  
**Критерии приемки**: База данных восстанавливается с проверкой целостности и корректным расчетом таймаутов.


**REQ-009**: КОГДА выполняется команда конвертации, СИСТЕМА ДОЛЖНА преобразовать файлы между форматами EDT и XML.  
**Критерии приемки**: Конвертация выполняется без потери данных с валидацией результата.

### 3.3 Unwanted Behavior (Требования к нежелательному поведению)

**REQ-010**: ЕСЛИ соединение с базой данных прервано, ТО СИСТЕМА ДОЛЖНА повторить попытку подключения до 3 раз с экспоненциальной задержкой.  
**Критерии приемки**: Система автоматически восстанавливает соединение или корректно завершается с ошибкой.

**REQ-011**: ЕСЛИ Git-репозиторий недоступен, ТО СИСТЕМА ДОЛЖНА зафиксировать ошибку и предоставить рекомендации по устранению.  
**Критерии приемки**: Пользователь получает понятное сообщение об ошибке с инструкциями.

**REQ-012**: ЕСЛИ конфигурационные файлы повреждены или отсутствуют, ТО СИСТЕМА ДОЛЖНА зафиксировать ошибку и предоставить рекомендации по устранению и завершить работу.  
**Критерии приемки**: Система заканчивает работу с подробным сообщением об ошибке.

**REQ-013**: ЕСЛИ процесс 1C завершается с ошибкой, ТО СИСТЕМА ДОЛЖНА зафиксировать детали ошибки и не очищать временные файлы.  
**Критерии приемки**: Временные файлы остаются на диске, ошибки логируются с полной диагностической информацией.

**REQ-014**: ЕСЛИ операция превышает установленный таймаут, ТО СИСТЕМА ДОЛЖНА прервать выполнение и освободить ресурсы.  
**Критерии приемки**: Операции корректно прерываются без блокировки ресурсов.

### 3.4 State-driven (Состоянийные требования)

**REQ-015**: ПОКА информационная база находится в сервисном режиме, СИСТЕМА ДОЛЖНА блокировать пользовательские подключения.  
**Критерии приемки**: Новые пользовательские сеансы не могут быть созданы в сервисном режиме.

**REQ-016**: ПОКА выполняется операция восстановления базы данных, СИСТЕМА ДОЛЖНА отклонять другие операции с этой базой.  
**Критерии приемки**: Параллельные операции с базой данных блокируются до завершения восстановления.

**REQ-017**: ПОКА активен процесс синхронизации с Git, СИСТЕМА ДОЛЖНА предотвращать конфликтующие операции с репозиторием.  
**Критерии приемки**: Блокировка репозитория действует до завершения синхронизации.

**REQ-018**: ПОКА выполняется конвертация конфигурации, СИСТЕМА ДОЛЖНА блокировать доступ к исходным файлам.  
**Критерии приемки**: Файлы защищены от изменения во время конвертации.

### 3.5 Optional Features (Опциональные требования)

**REQ-019**: ГДЕ включена опция принудительного обновления, СИСТЕМА ДОЛЖНА выполнять операции даже при отсутствии изменений в репозитории с добавлением (или редактированием) в корень репозитория файла force_update, записывая в файл текущую дату и время.  
**Критерии приемки**: Параметр `force_update=true` заставляет выполнить операцию независимо от состояния.


**REQ-022**: ГДЕ настроено завершение сеансов, СИСТЕМА ДОЛЖНА принудительно завершать активные пользовательские сеансы при включении сервисного режима.  
**Критерии приемки**: Параметр `terminateSessions=true` корректно завершает все активные сеансы.

### 3.6 Complex (Комплексные требования)


**REQ-024**: ПОКА выполняется синхронизация Git, ЕСЛИ возникает конфликт слияния, ТО КОГДА система обнаруживает конфликт, СИСТЕМА ДОЛЖНА создать Issue в Gitea с детальным описанием конфликта.  
**Критерии приемки**: Issue создается автоматически с полной информацией о конфликте и предлагаемыми решениями.

---

## 4. Архитектурные аспекты

### 4.1 Компоненты системы

#### 4.1.1 CLI Interface (cmd/github.com/Kargones/apk-ci/main.go)
**Назначение**: Точка входа в приложение, обработка командной строки  
**Ответственность**: Парсинг параметров, инициализация логирования, диспетчеризация команд

#### 4.1.2 Application Layer (internal/app)
**Назначение**: Координация бизнес-логики и оркестрация операций  
**Основные функции**:
- `InitGit()` - инициализация Git-клиента
- `InitSQ()` - инициализация SonarQube-клиента
- `InitDB()` - инициализация БД-клиента
- `InitConfig()` - инициализация конфигурации

- `Convert()` - конвертация конфигураций
- `Git2Store()` - синхронизация Git → Store
- `Store2Db()` - загрузка из хранилища в БД
- `DbUpdate()` - обновление конфигурации БД
- `DbRestore()` - восстановление базы данных
- `ServiceModeEnable/Disable/Status()` - управление сервисным режимом
- `SQscan()` - сканирование проекта в SonarQube
- `SQgetIssues()` - получение списка проблем в SonarQube
- `SQgetProjectInfo()` - получение информации о проекте в SonarQube
- `SQgetProjectQualityGate()` - получение качества проекта в SonarQube
- `SQgetProjectMetrics()` - получение метрик проекта в SonarQube
- `SQgetNewProject()` - получение нового проекта в SonarQube

#### 4.1.3 Configuration Module (internal/config)
**Назначение**: Централизованное управление конфигурацией  
**Источники конфигурации**:
- Переменные окружения
- Файлы конфигурации (YAML)
- Параметры командной строки
- GitHub Actions параметры

#### 4.1.4 Business Logic Entities

##### Gitea Entity (internal/entity/gitea)
**Назначение**: Интеграция с Gitea API  
**API методы**:
- `GetIssue(issueNumber)` - получение задачи
- `AddIssueComment(issueNumber, commentText)` - добавление комментария
- `CreatePR(title, description, sourceBranch, targetBranch)` - создание Pull Request
- `MergePR(prNumber)` - слияние Pull Request
- `GetFileContent(fileName)` - получение содержимого файла
- `TestMerge(sourceBranch, targetBranch)` - проверка возможности слияния

##### Git Entity (internal/git)
**Назначение**: Операции с Git-репозиториями  
**Основные методы**:
- `Clone(ctx, logger)` - клонирование репозитория
- `Switch(branch)` - переключение ветки
- `Commit(message)` - создание коммита
- `Push()` - отправка изменений
- `Pull()` - получение изменений

##### DBRestore Entity (internal/entity/dbrestore)
**Назначение**: Восстановление баз данных MS SQL Server  
**Функциональность**:
- Восстановление из исторических резервных копий
- Расчет таймаутов операций
- Управление подключениями к БД
- Валидация целостности данных

##### EDT Entity (internal/entity/one/edt)
**Назначение**: Работа с Enterprise Development Tools  
**Операции**:
- Конвертация EDT ↔ XML

##### Store Entity (internal/entity/one/store)
**Назначение**: Управление хранилищем конфигураций 1C  
**Функции**:
- Подключение к хранилищу
- Получение истории изменений
- Коммит изменений

### 4.2 Интерфейсы взаимодействия

#### 4.2.1 Внешние интерфейсы
- **Gitea API**: REST API для управления репозиториями и задачами
- **SonarQube API**: REST API для работы с SonarQube
- **Executor**: Интерфейс для выполнения команд, все внешние команды выполняются через этот интерфейс
- **Git CLI**: Интерфейс командной строки Git
- **1C Platform**: Интерфейс платформы 1C:Enterprise, используется для выполнения команд 1C. Может использовать 1cv8 или ibcmd. Должна быть возможность выбрать для операции конкретную реализацию. Должна быть возможность выбрать разные версии платформы 1С установленные на хосте.
- **1C EDT Platform**: Интерфейс платформы 1C EDT. Реализуется через 1cedtcli. Должна быть возможность выбрать для операции конкретную версию из установленных на хосте.
- **MS SQL Server**: Интерфейс базы данных

#### 4.2.2 Внутренние интерфейсы

### 4.3 Потоки данных

#### 4.3.1 Инициализация приложения
```
User → Main App → Config → GiteaFactory → GiteaService
```

#### 4.3.2 Обработка команд
```
CLI → Config → App Layer → Business Entities → Utilities
```

#### 4.3.3 Процесс Git2Store
```
Git Clone → EDT Convert → 1C Load → Store Commit → Git Push
```

### 4.4 Модель данных

#### 4.4.1 Конфигурационные структуры
- `InputParams` - параметры из GitHub Actions. Используются для передачи параметров из GitHub Actions в приложение. На основе этих данных происходит загрузка остальных файлов конфигурации из репозитоиев gitea.
- `AppConfig` - основная конфигурация приложения. Содержит настройки общие для всех проектов и настройки подключения к внешним сервисам за исключения секретных данных.
- `ProjectConfig` - конфигурация проекта по разработке конфигурации на 1c EDT. Содержит настройки специфичные только для данного проекта.
- `SecretConfig` - секретные данные. Содержит данные для подключения к Gitea, SonarQube, 1C Platform, 1C EDT Platform, MS SQL Server. Хранятся в виде yaml файла зашифрованного sops используя ключи age.
- `DatabaseInfo` - информация о базах данных. Содержит данные о конкретной базе данных 1С (сервер 1С, сервер MS SQL на котором хранится база данных).

#### 4.4.2 Бизнес-сущности
- `PullRequest` - запрос на слияние
- `Issue` - задача в системе
- `ConflictFile` - файл с конфликтом
- `StoreRecord` - запись хранилища
- `User` - пользователь системы

---

## 5. Критерии приемки

### 5.1 Функциональные критерии

#### 5.1.1 Команды CLI
- Все команды (`git2store`, `store2git`, `dbrestore`, `convert`, `servicemode`) выполняются успешно
- Корректная обработка параметров командной строки
- Информативные сообщения об ошибках

#### 5.1.2 Интеграция с Gitea
- Успешное создание и слияние Pull Requests
- Корректная работа с Issues (создание, комментирование, закрытие)
- Проверка конфликтов слияния

#### 5.1.3 Работа с базами данных
- Успешное восстановление из резервных копий
- Корректное управление сервисным режимом
- Валидация целостности данных

#### 5.1.4 Синхронизация данных
- Корректная синхронизация Git -> 1C Store
- Сохранение метаданных (автор, время, комментарии)

### 5.2 Нефункциональные критерии

#### 5.2.1 Производительность
- Время выполнения операций не превышает установленных таймаутов
- Эффективное использование системных ресурсов
- Масштабируемость для больших репозиториев

#### 5.2.2 Надежность
- Система восстанавливается после сбоев
- Корректная обработка всех типов ошибок
- Целостность данных при любых условиях

#### 5.2.3 Безопасность
- Безопасное хранение секретных данных
- Аутентификация и авторизация
- Защита от несанкционированного доступа

#### 5.2.4 Удобство использования
- Интуитивно понятный интерфейс командной строки
- Подробная документация
- Информативные сообщения и логи

### 5.3 Критерии качества кода

#### 5.3.1 Архитектура
- Модульная структура с четким разделением ответственности
- Соблюдение принципов SOLID
- Минимальная связанность между компонентами

#### 5.3.2 Тестирование
- Покрытие тестами не менее 80%
- Юнит-тесты для всех критических функций
- Интеграционные тесты для основных сцен��риев

#### 5.3.3 Документация
- Полная документация конфигурационных файлов
- Документирование кода с помощью комментариев в формате go doc

---

## 6. Ограничения и условия работы

### 6.1 Технические ограничения
- Операционная система: Linux (Ubuntu 24.04)
- Язык программирования: Go 1.25+
- База данных: MS SQL Server
- Система контроля версий: Git
- Платформа разработки: 1C:Enterprise, 1C:EDT Platform
- Сервер git - gitea 1.24+

### 6.2 Системные требования
- Минимум 4 GB RAM
- Минимум 10 GB свободного дискового пространства
- Сетевое подключение для работы с удаленными репозиториями
- Установленные компоненты: samba-client, krb5-user, cifs-utils

### 6.3 Ограничения производительности
- Максимальный размер обрабатываемого репозитория: 20 GB
- Максимальное время выполнения операции: 600 минут
- Максимальное количество одновременных операций: 1

### 6.4 Ограничения безопасности
- Все секретные данные должны храниться в зашифрованном (с помощью sops + age) виде
- Доступ к системе только через аутентифицированные соединения
- Логирование всех операций для аудита, с выводом информационных сообщений и ошибок в консоль и выводом всех сообщений включая Debug в файл в рабочем каталоге программы, с автоматическим присвоением уникального имени.

---

## 7. Требования к производительности и безопасности

### 7.1 Требования к производительности




### 7.2 Требования к безопасности

**REQ-028**: СИСТЕМА ДОЛЖНА шифровать все секретные данные (пароли, токены, ключи) при хранении и передаче.  
**Критерии приемки**: Секретные данные недоступны в открытом виде в файлах конфигурации и логах.

**REQ-029**: СИСТЕМА ДОЛЖНА использовать аутентификацию с использованием токенов для доступа к серверу gitea и имя пользователя и пароль к базе данных MS SQL Server.  
**Критерии приемки**: Доступ к операциям управления базами данных и репозиториями требует аутентификации.

**REQ-030**: СИСТЕМА ДОЛЖНА логировать все операции с указанием пользователя, времени и результата выполнения.  
**Критерии приемки**: Логи содержат полную информацию для аудита безопасности.

---

## Заключение

Данный документ SRS полностью описывает функциональные и нефункциональные требования к системе Benadis Runner Next. Документ структурирован с использованием шаблонов EARS и содержит все необходимые детали для разработки архитектуры и реализации системы.

Все требования имеют уникальные идентификаторы для обеспечения traceability и содержат четкие критерии приемки для валидации реализации.

Документ должен регулярно обновляться при изменении требований или добавлении новой функциональности.

---

## 8. Добавленные требования

### 8.1 Требования к архитектуре и обработке операций

**REQ-031**: СИСТЕМА ДОЛЖНА выполнять операции последовательно без параллельной обработки команд.  
**Критерии приемки**: Команды выполняются строго по очереди, новая команда не начинается до завершения предыдущей.

**REQ-032**: СИСТЕМА ДОЛЖНА поддерживать только CLI интерфейс без предоставления REST API.  
**Критерии приемки**: Все операции доступны исключительно через командную строку.

### 8.2 Требования к конфигурации

**REQ-033**: СИСТЕМА ДОЛЖНА поддерживать YAML конфигурацию с шаблонизацией Go templates.  
**Критерии приемки**: Конфигурационные файлы поддерживают синтаксис Go templates для динамической подстановки значений.

**REQ-034**: СИСТЕМА ДОЛЖНА использовать текущий подход управления секретами через SOPS + age.  
**Критерии приемки**: Секреты шифруются и расшифровываются с использованием SOPS и age ключей.

### 8.3 Требования к логированию и аудиту

**REQ-035**: СИСТЕМА ДОЛЖНА обеспечивать базовое логирование операций с уровнем Debug в файл.  
**Критерии приемки**: Все операции логируются с детальной отладочной информацией в файлы логов.

**REQ-036**: СИСТЕМА НЕ ДОЛЖНА интегрироваться с внешними системами мониторинга.  
**Критерии приемки**: Мониторинг осуществляется исключительно через анализ файлов логов.

**REQ-037**: СИСТЕМА НЕ ДОЛЖНА собирать и предоставлять метрики производительности.  
**Критерии приемки**: Система не экспортирует метрики в формате Prometheus или других систем мониторинга.

### 8.4 Требования к обработке ошибок

**REQ-038**: СИСТЕМА ДОЛЖНА использовать стратегию повторных попыток с фиксированной задержкой для операций с внешними системами.  
**Критерии приемки**: При сбоях повторные попытки выполняются через равные интервалы времени.


**REQ-040**: СИСТЕМА ДОЛЖНА немедленно останавливать pipeline при критических ошибках.  
**Критерии приемки**: Критические ошибки приводят к полной остановке выполнения операций с детальным логированием.

### 8.5 Требования к производительности

**REQ-041**: СИСТЕМА ДОЛЖНА поддерживать параллельную обработку только для файловых операций.  
**Критерии приемки**: Операции чтения/записи файлов могут выполняться параллельно, остальные операции - последовательно.


### 8.6 Требования к интеграции с 1C платформой

**REQ-043**: СИСТЕМА ДОЛЖНА поддерживать автоматический выбор версии 1C платформы по серверу с хранением данных о версиях в файле dbconfig.yaml.  
**Критерии приемки**: Для каждого сервера 1C автоматически выбирается соответствующая версия платформы на основе конфигурации.

**REQ-044**: СИСТЕМА ДОЛЖНА замещать версию в хранилище конфигураций 1C версией из Git без синхронизации изменений.  
**Критерии приемки**: При операции git2store версия из Git полностью замещает текущую версию в хранилище 1C.

**REQ-045**: СИСТЕМА НЕ ДОЛЖНА выполнять валидацию конфигурации 1C перед коммитом.  
**Критерии приемки**: Изменения коммитятся в Git без предварительной проверки синтаксиса или структуры конфигурации 1C.

### 8.7 Требования к управлению жизненным циклом

**REQ-046**: СИСТЕМА ДОЛЖНА обрабатывать проекты независимо без учета зависимостей между ними.  
**Критерии приемки**: Каждый проект обрабатывается как изолированная единица без анализа межпроектных связей.

**REQ-047**: СИСТЕМА НЕ ДОЛЖНА поддерживать feature flags для постепенного развертывания.  
**Критерии приемки**: Все функции системы активны постоянно без возможности их выборочного включения/выключения.
