@startuml load-config
' !theme plain
title Схема загрузки конфигурационных данных

' Определение участников
participant "GitHub Actions" as GHA
participant "LoadConfiguration()" as LoadConfig
participant "GetConfigData()" as GetData
participant "Gitea API" as Gitea
participant "loadAppConfig()" as LoadApp
participant "loadProjectConfig()" as LoadProject
participant "loadSecretConfig()" as LoadSecret
participant "loadDbConfig()" as LoadDb
participant "cleanenv" as Env
participant "yaml.Unmarshal" as YAML

' Основная последовательность загрузки
GHA -> LoadConfig: Входные параметры\n(configSystem, configProject,\nconfigSecret, actor, accessToken, etc.)

activate LoadConfig
LoadConfig -> LoadConfig: Инициализация логгера
LoadConfig -> LoadConfig: Загрузка базовых настроек\nиз переменных окружения
LoadConfig -> LoadConfig: Установка значений по умолчанию\n(ConfigSystem="app.yaml",\nConfigProject="project.yaml",\nConfigSecret="secret.yaml")

' Загрузка AppConfig
LoadConfig -> LoadApp: loadAppConfig(cfg)
activate LoadApp
LoadApp -> GetData: GetConfigData(cfg, logger, cfg.ConfigSystem)
activate GetData
GetData -> Gitea: HTTP GET /api/v1/repos/{owner}/{repo}/contents/{filename}
Gitea --> GetData: JSON response with base64 content
GetData -> GetData: Декодирование base64
GetData --> LoadApp: []byte (YAML данные)
deactivate GetData
LoadApp -> YAML: yaml.Unmarshal(data, &appConfig)
YAML --> LoadApp: AppConfig структура
LoadApp --> LoadConfig: *AppConfig
deactivate LoadApp

' Загрузка ProjectConfig
LoadConfig -> LoadProject: loadProjectConfig(cfg)
activate LoadProject
LoadProject -> GetData: GetConfigData(cfg, logger, cfg.ConfigProject)
activate GetData
GetData -> Gitea: HTTP GET /api/v1/repos/{owner}/{repo}/contents/{filename}
Gitea --> GetData: JSON response with base64 content
GetData -> GetData: Декодирование base64
GetData --> LoadProject: []byte (YAML данные)
deactivate GetData
LoadProject -> YAML: yaml.Unmarshal(data, &projectConfig)
YAML --> LoadProject: ProjectConfig структура
LoadProject --> LoadConfig: *ProjectConfig
deactivate LoadProject

' Загрузка SecretConfig
LoadConfig -> LoadSecret: loadSecretConfig(cfg)
activate LoadSecret
LoadSecret -> GetData: GetConfigData(cfg, logger, cfg.ConfigSecret)
activate GetData
GetData -> Gitea: HTTP GET /api/v1/repos/{owner}/{repo}/contents/{filename}
Gitea --> GetData: JSON response with base64 content
GetData -> GetData: Декодирование base64
GetData --> LoadSecret: []byte (YAML данные)
deactivate GetData
LoadSecret -> YAML: yaml.Unmarshal(data, &secretConfig)
YAML --> LoadSecret: SecretConfig структура
LoadSecret --> LoadConfig: *SecretConfig
deactivate LoadSecret

' Загрузка DbConfig
LoadConfig -> LoadDb: loadDbConfig(cfg)
activate LoadDb
LoadDb -> GetData: GetConfigData(cfg, logger, cfg.ConfigDbData)
activate GetData
GetData -> Gitea: HTTP GET /api/v1/repos/{owner}/{repo}/contents/{filename}
Gitea --> GetData: JSON response with base64 content
GetData -> GetData: Декодирование base64
GetData --> LoadDb: []byte (YAML данные)
deactivate GetData
LoadDb -> YAML: yaml.Unmarshal(data, &dbConfig)
YAML --> LoadDb: map[string]*DatabaseInfo
LoadDb --> LoadConfig: map[string]*DatabaseInfo
deactivate LoadDb

' Переопределение из переменных окружения
LoadConfig -> Env: cleanenv.ReadEnv(cfg)
Env --> LoadConfig: Переопределенные значения

LoadConfig -> LoadConfig: createWorkDirectories(cfg)
LoadConfig -> LoadConfig: initGiteaSettings(cfg)

LoadConfig --> GHA: *Config (полная конфигурация)
deactivate LoadConfig

' Использование конфигурации в специализированных функциях
group Специализированные функции загрузки
    participant "LoadDBRestoreConfig()" as LoadDBRestore
    participant "LoadServiceModeConfig()" as LoadServiceMode
    participant "LoadServiceModeConfigFromSecret()" as LoadServiceSecret
    participant "LoadEdtConfig()" as LoadEdt
    participant "LoadConvertConfig()" as LoadConvert
    
    GHA -> LoadDBRestore: LoadDBRestoreConfig(cfg, dbName)
    activate LoadDBRestore
    LoadDBRestore -> LoadDBRestore: Создание DBRestoreConfig\nс значениями по умолчанию
    LoadDBRestore -> LoadDBRestore: Загрузка настроек из cfg.AppConfig.Dbrestore
    LoadDBRestore -> LoadDBRestore: Загрузка пароля из cfg.SecretConfig.Passwords.Mssql
    LoadDBRestore -> LoadDBRestore: Определение srcServer и dstServer\nчерез cfg.DetermineSrcAndDstServers(dbName)
    LoadDBRestore -> Env: cleanenv.ReadEnv(dbCfg)
    Env --> LoadDBRestore: Переопределение из переменных окружения
    LoadDBRestore --> GHA: *DBRestoreConfig
    deactivate LoadDBRestore
    
    GHA -> LoadServiceMode: LoadServiceModeConfig(cfg, dbName)
    activate LoadServiceMode
    LoadServiceMode -> LoadServiceMode: Создание ServiceModeConfig\nс значениями по умолчанию
    LoadServiceMode -> LoadServiceMode: Загрузка настроек из cfg.AppConfig
    LoadServiceMode -> LoadServiceMode: Получение RAC сервера\nчерез cfg.GetRacServerForDb(dbName)
    LoadServiceMode -> LoadServiceMode: Загрузка паролей из cfg.SecretConfig
    LoadServiceMode -> Env: cleanenv.ReadEnv(serviceCfg)
    Env --> LoadServiceMode: Переопределение из переменных окружения
    LoadServiceMode --> GHA: *ServiceModeConfig
    deactivate LoadServiceMode
    
    GHA -> LoadServiceSecret: LoadServiceModeConfigFromSecret(cfg, configSecret)
    activate LoadServiceSecret
    LoadServiceSecret -> LoadServiceSecret: Создание ServiceModeConfig\nс базовыми значениями из cfg
    alt configSecret содержит YAML напрямую
        LoadServiceSecret -> LoadServiceSecret: Использование configSecret как YAML
    else configSecret - имя файла
        LoadServiceSecret -> GetData: GetConfigData(cfg, logger, configSecret)
        activate GetData
        GetData -> Gitea: HTTP GET /api/v1/repos/{owner}/{repo}/contents/{filename}
        Gitea --> GetData: JSON response with base64 content
        GetData -> GetData: Декодирование base64
        GetData --> LoadServiceSecret: []byte (YAML данные)
        deactivate GetData
    end
    LoadServiceSecret -> YAML: yaml.Unmarshal(configData, serviceCfg)
    YAML --> LoadServiceSecret: Обновленная ServiceModeConfig
    LoadServiceSecret -> Env: cleanenv.ReadEnv(serviceCfg)
    Env --> LoadServiceSecret: Переопределение из переменных окружения
    LoadServiceSecret --> GHA: *ServiceModeConfig
    deactivate LoadServiceSecret
    
    GHA -> LoadEdt: LoadEdtConfig(cfg)
    activate LoadEdt
    LoadEdt -> LoadEdt: Создание EdtConfig с настройками\nиз cfg.AppConfig.Paths.EdtCli
    LoadEdt -> Env: cleanenv.ReadEnv(edtCfg)
    Env --> LoadEdt: Переопределение из переменных окружения
    LoadEdt --> GHA: *EdtConfig
    deactivate LoadEdt
    
    GHA -> LoadConvert: LoadConvertConfig(cfg, configPath)
    activate LoadConvert
    LoadConvert -> GetData: GetConfigData(cfg, logger, configPath)
    activate GetData
    GetData -> Gitea: HTTP GET /api/v1/repos/{owner}/{repo}/contents/{filename}
    Gitea --> GetData: JSON response with base64 content
    GetData -> GetData: Декодирование base64
    GetData --> LoadConvert: []byte (YAML данные)
    deactivate GetData
    LoadConvert -> YAML: yaml.Unmarshal(data, &convertConfig)
    YAML --> LoadConvert: ConvertConfig структура
    LoadConvert -> Env: cleanenv.ReadEnv(convertConfig)
    Env --> LoadConvert: Переопределение из переменных окружения
    LoadConvert --> GHA: *ConvertConfig
    deactivate LoadConvert
end group

note over GHA
  **Основные структуры конфигурации:**
  
  • Config - основная структура
  • AppConfig - настройки приложения
  • ProjectConfig - настройки проекта
  • SecretConfig - секретные данные
  • DatabaseInfo - информация о БД
  • DBRestoreConfig - конфигурация восстановления БД
  • ServiceModeConfig - конфигурация сервисного режима
  • EdtConfig - конфигурация EDT
  • ConvertConfig - конфигурация конвертации
end note

note right of GetData
  Универсальная функция для загрузки
  конфигурационных данных из Gitea API.
  Поддерживает как файлы репозитория,
  так и прямые URL.
end note

note right of LoadServiceSecret
  Специальная функция для загрузки
  конфигурации Service Mode, которая
  может принимать как имя файла,
  так и YAML-содержимое напрямую.
end note

@enduml