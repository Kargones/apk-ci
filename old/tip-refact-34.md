# План рефакторинга: Перенос структур из модуля config в модуль entity

## Обзор задачи
Согласно инструкции из файла `refact-34.md`, необходимо перенести все структуры из модуля `config` в модуль `entity` для улучшения архитектуры приложения и разделения ответственности.

## Анализ текущего состояния

### Структуры в модуле config для переноса:

1. **AppConfig** - настройки приложения из app.yaml
2. **ProjectConfig** - настройки проекта из project.yaml  
3. **SecretConfig** - секреты из secret.yaml
4. **DatabaseInfo** - информация о базе данных из dbconfig.yaml
5. **Config** - основная структура конфигурации
6. **ConvertConfig** - настройки для конвертации
7. **DBRestoreConfig** - настройки для восстановления базы данных
8. **ServiceModeConfig** - настройки для сервисного режима
9. **EdtConfig** - настройки для EDT
10. **Repo** - информация о репозитории
11. **FileInfo** - информация о файле (дублируется с gitea)
12. **GiteaAPI** - API для работы с Gitea (дублируется с gitea)

### Существующие структуры в модуле entity:
- **dbrestore.DBRestore** - клиент для восстановления БД
- **dbrestore.RestoreStats** - статистика восстановления
- **gitea.GiteaAPI** - API для работы с Gitea
- **gitea.FileInfo** - информация о файле
- **gitea.Issue**, **gitea.PR**, **gitea.Repo** и др.

## План выполнения

### Этап 1: Создание новых модулей в entity

#### 1.1 Создать модуль `entity/config`
- Перенести основные конфигурационные структуры:
  - `AppConfig`
  - `ProjectConfig` 
  - `SecretConfig`
  - `DatabaseInfo`
  - `Config`

#### 1.2 Создать модуль `entity/convert`
- Перенести `ConvertConfig`
- Интегрировать с существующим `entity/one/convert`

#### 1.3 Обновить модуль `entity/dbrestore`
- Перенести `DBRestoreConfig` и объединить с существующим `DBRestore`
- Удалить дублирование функциональности

#### 1.4 Создать модуль `entity/service`
- Перенести `ServiceModeConfig`

#### 1.5 Обновить модуль `entity/one/edt`
- Перенести `EdtConfig` и интегрировать с существующим функционалом

#### 1.6 Обновить модуль `entity/gitea`
- Удалить дублирующиеся структуры (`FileInfo`, `GiteaAPI`)
- Перенести недостающие структуры из config

### Этап 2: Обновление импортов и зависимостей

#### 2.1 Обновить все файлы, использующие структуры из config
- Заменить импорты `github.com/Kargones/apk-ci/internal/config` на соответствующие `github.com/Kargones/apk-ci/internal/entity/*`
- Обновить пути к структурам в коде

#### 2.2 Файлы для обновления (предварительный список):
- `internal/entity/one/store/store.go`
- `internal/entity/one/designer/designer.go`
- `internal/entity/gitea/gitea.go`
- `internal/git/git.go`
- `cmd/` директория
- Тестовые файлы

### Этап 3: Рефакторинг модуля config

#### 3.1 Оставить в config только функции загрузки и инициализации
- `MustLoad()`
- `LoadConfiguration()`
- Функции загрузки отдельных конфигураций
- Вспомогательные функции

#### 3.2 Обновить функции для работы с новыми путями к структурам

### Этап 4: Тестирование и валидация

#### 4.1 Запустить тесты
- Убедиться, что все тесты проходят
- Исправить возникшие ошибки

#### 4.2 Проверить сборку
- Убедиться, что проект собирается без ошибок
- Проверить отсутствие циклических зависимостей

## Детальный план действий

### Шаг 1: Создание entity/config/config.go
```go
package config

// Перенести структуры:
// - AppConfig
// - ProjectConfig
// - SecretConfig
// - DatabaseInfo
// - Config (основная)
```

### Шаг 2: Создание entity/convert/convert.go
```go
package convert

// Перенести:
// - ConvertConfig
// Интегрировать с существующим функционалом
```

### Шаг 3: Обновление entity/dbrestore/dbrestore.go
```go
// Добавить:
// - DBRestoreConfig (объединить с DBRestore)
// Удалить дублирование
```

### Шаг 4: Создание entity/service/service.go
```go
package service

// Перенести:
// - ServiceModeConfig
```

### Шаг 5: Обновление entity/one/edt/edt.go
```go
// Добавить:
// - EdtConfig
```

### Шаг 6: Очистка entity/gitea/gitea.go
```go
// Удалить дублирующиеся структуры
// Оставить только уникальные для gitea
```

### Шаг 7: Массовое обновление импортов
- Использовать поиск и замену для обновления всех импортов
- Обновить пути к структурам в коде

### Шаг 8: Рефакторинг internal/config/config.go
- Оставить только функции загрузки
- Обновить импорты на новые пути к структурам
- Обновить возвращаемые типы функций

## Ожидаемые преимущества

1. **Улучшенная архитектура**: Четкое разделение между конфигурацией и бизнес-логикой
2. **Устранение дублирования**: Удаление дублирующихся структур между модулями
3. **Лучшая организация кода**: Логическая группировка связанных структур
4. **Упрощение тестирования**: Более изолированные модули
5. **Улучшенная читаемость**: Более понятная структура проекта

## Риски и меры по их снижению

1. **Поломка существующего кода**: Тщательное тестирование после каждого этапа
2. **Циклические зависимости**: Проверка зависимостей на каждом шаге
3. **Потеря функциональности**: Детальная проверка всех перенесенных структур

## Критерии успеха

1. Все тесты проходят успешно
2. Проект собирается без ошибок
3. Отсутствуют циклические зависимости
4. Код стал более организованным и читаемым
5. Устранено дублирование структур

## Временные затраты

Ориентировочное время выполнения: 4-6 часов
- Этап 1: 2 часа
- Этап 2: 2 часа  
- Этап 3: 1 час
- Этап 4: 1 час

## Заключение

Данный план обеспечивает систематический подход к рефакторингу с минимизацией рисков и максимизацией преимуществ новой архитектуры.