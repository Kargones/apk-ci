# Requirements Document

## Введение

Benadis Runner Next - это CLI-приложение на Go 1.25 для автоматизации DevOps процессов в экосистеме 1C:Enterprise. Система обеспечивает интеграцию между Git/Gitea, хранилищами конфигураций 1C, серверами 1С и базами данных MS SQL Server, автоматизируя процессы конвертации, синхронизации и развертывания конфигураций 1C.

## Requirements

### Requirement 1

**User Story:** Как DevOps инженер, я хочу синхронизировать изменения из Git-репозитория с хранилищем конфигураций 1C, чтобы автоматизировать процесс развертывания конфигураций.

#### Acceptance Criteria

1. WHEN пользователь выполняет команду convert THEN система SHALL клонировать указанный Git-репозиторий
2. WHEN репозиторий клонирован THEN система SHALL конвертировать конфигурацию из формата EDT в XML во временный каталог
3. WHEN конвертация завершена THEN система SHALL переключиться на ветку xml
4. WHEN система находится на ветке xml THEN система SHALL очистить каталог репозитория от файлов (кроме начинающихся на точку) AND скопировать сконвертированные файлы из временного каталога
5. WHEN файлы скопированы THEN система SHALL выполнить коммит и push изменений в Gitea


. WHEN пользователь выполняет команду git2store THEN система SHALL клонировать указанный Git-репозиторий
. WHEN репозиторий клонируется THEN система SHALL подключится к серверу gitea используя API
. WHEN система подключилась к серверу gitea используя API THEN система SHALL пролучить список корневых каталогов репозитория
. WHEN репозиторий клонирован THEN система SHALL переключиться на ветку xml
4. WHEN система находится на ветке xml THEN система SHALL создать временную файловую базу 1С, дабавив в нее расширения на основе списка из массива со списком расширений
5. WHEN временная файловая база 1С создана THEN система SHALL последовательно загрузить в нее файлы основной конфигурации и файлы расширений
6. WHEN все файлы загружены THEN система SHALL применить изменения основной конфигурации и расширений во временной файловой базе 1С
7. WHEN изменения применены THEN система SHALL выгрузить основную конфигурацию
8. WHEN коммит создан THEN система SHALL выполнить push изменений в Gitea

6. WHEN изменения отправлены в Gitea THEN система SHALL обновить хранилище конфигураций 1C

### Requirement 2

**User Story:** Как администратор 1C, я хочу загружать конфигурацию из хранилища в информационную базу, чтобы обновить рабочую среду до последней версии.

#### Acceptance Criteria

1. WHEN пользователь выполняет команду store2db THEN система SHALL подключиться к хранилищу конфигураций
2. WHEN подключение установлено THEN система SHALL получить последнюю версию конфигурации
3. WHEN версия получена THEN система SHALL загрузить конфигурацию в информационную базу
4. WHEN загрузка завершена THEN система SHALL проверить успешность операции
5. WHEN операция проверена THEN система SHALL записать в лог все этапы процесса

### Requirement 3

**User Story:** Как администратор базы данных, я хочу восстанавливать базы данных из резервных копий, чтобы быстро развернуть тестовую или рабочую среду.

#### Acceptance Criteria

1. WHEN пользователь выполняет команду dbrestore THEN система SHALL подключиться к MS SQL Server
2. WHEN подключение установлено THEN система SHALL рассчитать оптимальные таймауты на основе истории предыдущих восстановлений
3. WHEN таймауты рассчитаны THEN система SHALL восстановить базу данных с проверкой целостности
4. WHEN восстановление завершено THEN система SHALL получить статистику восстановления
5. IF восстановление завершилось с ошибкой THEN система SHALL обработать ошибки восстановления

### Requirement 4

**User Story:** Как разработчик 1C, я хочу обновлять конфигурацию базы данных, чтобы применить изменения структуры к информационной базе.

#### Acceptance Criteria

1. WHEN пользователь выполняет команду dbupdate THEN система SHALL проанализировать изменения конфигурации
2. WHEN изменения проанализированы THEN система SHALL применить изменения к структуре БД
3. WHEN изменения применяются THEN система SHALL проверить совместимость изменений
4. IF возникают критические ошибки THEN система SHALL выполнить откат изменений
5. WHEN операция завершена THEN система SHALL записать детальный лог процесса обновления

### Requirement 5

**User Story:** Как разработчик, я хочу конвертировать конфигурации из формата EDT в XML, чтобы обеспечить совместимость с различными инструментами 1C.

#### Acceptance Criteria

1. WHEN пользователь выполняет команду convert THEN система SHALL выполнить конвертацию EDT → XML
2. WHEN конвертация выполняется THEN система SHALL сохранить метаданные и структуру
3. WHEN конвертация завершена THEN система SHALL валидировать результаты конвертации
4. IF возникают ошибки конвертации THEN система SHALL обработать ошибки конвертации

### Requirement 6

**User Story:** Как системный администратор, я хочу управлять сервисным режимом информационных баз 1C, чтобы безопасно выполнять операции обслуживания.

#### Acceptance Criteria

1. WHILE система находится в сервисном режиме THEN система SHALL блокировать пользовательские подключения к информационной базе
2. WHEN включается сервисный режим THEN система SHALL использовать RAC API для управления режимом
3. WHEN сервисный режим активен THEN система SHALL принудительно завершить пользовательские сеансы
4. WHEN сервисный режим активен THEN система SHALL блокировать новые подключения
5. WHEN режим изменяется THEN система SHALL записать изменения в лог

### Requirement 7

**User Story:** Как DevOps инженер, я хочу получать уведомления о конфликтах слияния, чтобы оперативно их разрешать.

#### Acceptance Criteria

1. WHEN обнаружены конфликты слияния в Git-репозитории AND автоматическое разрешение невозможно THEN система SHALL создать Issue в Gitea с детальным описанием конфликтов
2. WHEN Issue создается THEN система SHALL включить описание конфликтующих файлов
3. WHEN Issue создается THEN система SHALL назначить ответственных разработчиков
4. WHEN конфликты разрешены THEN система SHALL автоматически закрыть Issue

### Requirement 8

**User Story:** Как администратор системы, я хочу иметь надежную систему логирования, чтобы отслеживать все операции и диагностировать проблемы.

#### Acceptance Criteria

1. СИСТЕМА SHALL логировать все операции с настраиваемым уровнем детализации
2. СИСТЕМА SHALL поддерживать уровни Debug, Info, Warn, Error
3. СИСТЕМА SHALL использовать JSON формат логов с группировкой информации
4. СИСТЕМА SHALL включать стек вызовов, имя модуля и номер строки
5. СИСТЕМА SHALL выполнять ротацию логов по размеру и времени
6. СИСТЕМА SHALL логировать все операции с указанием пользователя и временных меток

### Requirement 9

**User Story:** Как администратор безопасности, я хочу обеспечить защиту секретных данных, чтобы предотвратить несанкционированный доступ к конфиденциальной информации.

#### Acceptance Criteria

1. СИСТЕМА SHALL шифровать все секретные данные с использованием SOPS + age
2. СИСТЕМА SHALL использовать токены API для аутентификации в Gitea
3. СИСТЕМА SHALL использовать аутентификацию пользователь/пароль для MS SQL Server
4. СИСТЕМА SHALL НЕ хранить секретные данные в открытом виде в конфигурационных файлах или логах
5. СИСТЕМА SHALL использовать TLS для всех сетевых соединений с внешними системами

### Requirement 10

**User Story:** Как пользователь системы, я хочу получать понятные сообщения об ошибках, чтобы быстро диагностировать и устранять проблемы.

#### Acceptance Criteria

1. СИСТЕМА SHALL валидировать все входные параметры перед выполнением операций
2. СИСТЕМА SHALL предоставлять понятные сообщения об ошибках с рекомендациями по устранению
3. IF подключение к базе данных недоступно THEN система SHALL НЕ завершаться аварийно AND SHALL выполнять повторные попытки подключения
4. IF Git-репозиторий недоступен THEN система SHALL НЕ продолжать выполнение операций, требующих доступа к репозиторию
5. IF конфигурационные файлы повреждены THEN система SHALL НЕ продолжать выполнение

### Requirement 11

**User Story:** Как системный администратор, я хочу иметь систему с высокой производительностью, чтобы эффективно обрабатывать большие объемы данных.

#### Acceptance Criteria

1. СИСТЕМА SHALL поддерживать параллельную обработку файловых операций (до 4 потоков)
2. СИСТЕМА SHALL обрабатывать репозитории размером не более 80 ГБ
3. СИСТЕМА SHALL поддерживать операции длительностью не более 600 минут
4. СИСТЕМА SHALL использовать стратегию повторных попыток с фиксированной задержкой для операций с внешними системами

### Requirement 12

**User Story:** Как разработчик, я хочу работать с системой через командную строку, чтобы интегрировать её в существующие DevOps процессы.

#### Acceptance Criteria

1. СИСТЕМА SHALL работать исключительно через CLI интерфейс
2. СИСТЕМА SHALL загружать конфигурацию из множественных источников (переменные окружения, YAML файлы, параметры командной строки)
3. СИСТЕМА SHALL корректно обрабатывать абсолютные и относительные пути к файлам и каталогам
4. СИСТЕМА SHALL поддерживать конфигурационные файлы в формате YAML с валидацией схемы