# Отчет об анализе проблемы конвертации EDT в XML

**Дата:** 2025-10-15
**Тест:** `TestMain_WithRealYamlFile`
**Команда:** `convert`

## Краткое резюме проблемы

При запуске интеграционного теста `TestMain_WithRealYamlFile` процесс конвертации из формата EDT в формат 1C-XML завершается с ошибкой `context deadline exceeded` сразу же после запуска команды EDT, не успев начать выполнение.

## Анализ выполнения теста

### Успешные этапы
1. ✅ Загрузка конфигурации из YAML файлов (app.yaml, project.yaml, secret.yaml, dbconfig.yaml)
2. ✅ Анализ структуры проекта (определен проект "LIS" и расширение "апк_ИсправлениеНомера")
3. ✅ Клонирование репозитория (выполнено за ~6 минут, с 09:50:36 до 09:56:32)
4. ✅ Переключение веток (main → main успешно)

### Проблемный этап
❌ **Конвертация EDT в XML** - завершилась мгновенно с ошибкой:

```
{"time":"2025-10-15T09:56:35.708","level":"ERROR","msg":"Runner","error":"context deadline exceeded"}
{"time":"2025-10-15T09:56:35.708","level":"ERROR","msg":"Превышен таймаут выполнения команды EDT"}
```

**Временные метки:**
- Запуск: `09:56:35.708390362`
- Ошибка: `09:56:35.708514790`
- **Разница: ~0.12 миллисекунды** - команда даже не успела начать выполнение!

## Корневая причина

### Цепочка выполнения кода

1. **main.go:18** - Создается базовый контекст без таймаута:
   ```go
   ctx := context.Background()
   ```

2. **main.go:41** - Вызывается функция Convert:
   ```go
   err = app.Convert(&ctx, l, cfg)
   ```

3. **app.go:119** - Создается контекст с таймаутом для EDT операций:
   ```go
   edtCtx, cancel := context.WithTimeout(*ctx, cfg.AppConfig.EdtTimeout)
   defer cancel()

   err = c.Convert(&edtCtx, l, cfg)
   ```

4. **edt.go:232** - Вызывается метод Convert EDT CLI:
   ```go
   r.Convert(ctx, l, cfg)
   ```

5. **edt.go:456** - Передается контекст в Runner:
   ```go
   _, e.LastErr = r.RunCommand(*ctx, l)
   ```

6. **runner.go:108** - Используется контекст для запуска команды:
   ```go
   cmd := exec.CommandContext(ctx, r.RunString, r.Params...)
   ```

### Причина мгновенного таймаута

В файле `config.go:57` определен параметр `EdtTimeout`:
```go
EdtTimeout time.Duration `yaml:"edt_timeout" env:"EDT_TIMEOUT" env-default:"90m"`
```

Значение по умолчанию в `config.go:940`:
```go
EdtTimeout: 90 * time.Minute,
```

**ПРОБЛЕМА:** Когда конфигурация загружается из `app.yaml` через `yaml.Unmarshal` (config.go:811), если параметр `edt_timeout` **отсутствует** в YAML файле, то поле `EdtTimeout` получает **нулевое значение** (`0`), а не значение по умолчанию `90m`.

Когда в `app.go:119` вызывается:
```go
context.WithTimeout(*ctx, cfg.AppConfig.EdtTimeout) // где EdtTimeout = 0
```

Это создает контекст с **нулевым таймаутом**, который **истекает немедленно**!

## Проверка конфигурации

Файл `app.yaml` в репозитории `gitops-tools/gitops_congif` скорее всего **не содержит** параметр `edt_timeout`, поэтому используется нулевое значение вместо значения по умолчанию.

## Варианты решения

### Решение 1: Добавить проверку и использование значения по умолчанию (РЕКОМЕНДУЕТСЯ)

**Файл:** `internal/app/app.go`
**Строка:** 119

**До:**
```go
edtCtx, cancel := context.WithTimeout(*ctx, cfg.AppConfig.EdtTimeout)
defer cancel()

err = c.Convert(&edtCtx, l, cfg)
```

**После:**
```go
// Определяем таймаут для EDT операций
edtTimeout := cfg.AppConfig.EdtTimeout
if edtTimeout <= 0 {
	// Используем значение по умолчанию если не задано
	edtTimeout = 90 * time.Minute
	l.Debug("Используется таймаут EDT по умолчанию",
		slog.Duration("timeout", edtTimeout))
}

// Создаем контекст с таймаутом для EDT операций
edtCtx, cancel := context.WithTimeout(*ctx, edtTimeout)
defer cancel()

err = c.Convert(&edtCtx, l, cfg)
```

**Преимущества:**
- Простое и быстрое исправление
- Не требует изменения конфигурационных файлов
- Работает для всех существующих инсталляций
- Обеспечивает обратную совместимость

### Решение 2: Исправить загрузку конфигурации

**Файл:** `internal/config/config.go`
**Функция:** `loadAppConfig` (строка 802)

**После:**
```go
func loadAppConfig(l *slog.Logger, cfg *Config) (*AppConfig, error) {
	giteaAPI := CreateGiteaAPI(cfg)
	data, err := giteaAPI.GetConfigData(l, cfg.ConfigSystem)
	if err != nil {
		return nil, fmt.Errorf("ошибка получения данных app.yaml: %w", err)
	}

	var appConfig AppConfig
	if err = yaml.Unmarshal(data, &appConfig); err != nil {
		return nil, fmt.Errorf("ошибка парсинга app.yaml: %w", err)
	}

	// Применяем значения по умолчанию для нулевых значений
	if appConfig.EdtTimeout <= 0 {
		appConfig.EdtTimeout = 90 * time.Minute
	}

	return &appConfig, nil
}
```

**Преимущества:**
- Централизованное решение
- Применяется для всех случаев загрузки конфигурации
- Гарантирует корректные значения по умолчанию

### Решение 3: Добавить параметр в app.yaml

**Файл:** `gitops-tools/gitops_congif/app.yaml`

**Добавить:**
```yaml
# Таймаут для операций EDT (экспорт/импорт конфигурации)
edt_timeout: 90m
```

**Преимущества:**
- Явная настройка в конфигурации
- Позволяет настраивать таймаут для разных окружений

**Недостатки:**
- Требует изменения конфигурационного файла в другом репозитории
- Не решает проблему для существующих установок без этого параметра

### Решение 4: Использовать переменную окружения

**В тесте или при запуске:**
```bash
export EDT_TIMEOUT=90m
```

**Преимущества:**
- Быстрое временное решение для тестирования
- Не требует изменения кода

**Недостатки:**
- Не решает проблему на уровне приложения
- Требует настройки для каждого запуска

## Рекомендации

### Приоритет 1: Исправить код приложения
Реализовать **Решение 1** И **Решение 2** одновременно для максимальной надежности:
- Решение 2 обеспечивает корректную загрузку конфигурации
- Решение 1 добавляет дополнительную защиту на уровне использования

### Приоритет 2: Обновить конфигурацию
После исправления кода добавить параметр `edt_timeout` в `app.yaml` (**Решение 3**) для явной документации настроек.

### Приоритет 3: Добавить тесты
Создать unit-тесты для проверки:
1. Загрузки конфигурации с отсутствующим параметром `edt_timeout`
2. Корректной установки значений по умолчанию
3. Создания контекста с корректным таймаутом

## Дополнительные замечания

### Логирование
Добавить отладочное логирование в ключевых точках:
```go
l.Debug("Создание контекста EDT",
	slog.Duration("timeout", edtTimeout),
	slog.String("config_source", "app.yaml"))
```

### Мониторинг
Рассмотреть добавление метрик для отслеживания:
- Времени выполнения EDT операций
- Количества таймаутов
- Средней продолжительности конвертации

## Заключение

Проблема вызвана тем, что при отсутствии параметра `edt_timeout` в файле `app.yaml` используется нулевое значение таймаута вместо значения по умолчанию 90 минут. Это приводит к мгновенному истечению контекста при запуске команды EDT.

Рекомендуется реализовать комбинацию Решений 1 и 2 для обеспечения максимальной надежности и обратной совместимости с существующими конфигурациями.

---

**Автор анализа:** Claude Code
**Дата создания:** 2025-10-15
