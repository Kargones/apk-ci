# Финальный план завершения реализации функционала SonarQube

## 1. Краткая сводка

### Цель доводки
Завершить реализацию интеграции с SonarQube в проекте apk-ci, обеспечив полный жизненный цикл работы с анализом качества кода: создание проектов, сканирование веток и pull request'ов, синхронизацию репозиториев, генерацию отчетов и управление проектами в SonarQube.

### Область охвата (модули/пакеты)
- `internal/entity/sonarqube/` - низкоуровневое взаимодействие с SonarQube API и sonar-scanner
- `internal/service/sonarqube/` - бизнес-логика и сервисы для работы с SonarQube
- `cmd/apk-ci/main.go` - интеграция команд в основное приложение
- `internal/config/` - расширение конфигурационной системы для SonarQube
- `internal/constants/` - добавление констант для команд SonarQube

### Критерии готовности релиза (Definition of Done)
- Все команды SonarQube полностью реализованы и протестированы
- Достигнуто минимум 80% покрытие кода тестами
- Реализована обработка ошибок с понятными сообщениями для пользователей
- Все компоненты следуют принципам SOLID и существующим паттернам проекта
- Документация обновлена и включает руководство пользователя для всех команд
- Интеграция с CI/CD pipeline протестирована
- Производительность и безопасность проверены

## 2. Матрица трассируемости

| REQ-ID | TASK-ID | DESIGN-REF | CODE-LOCATIONS | СТАТУС | ПРОБЕЛЫ |
|--------|---------|------------|----------------|--------|---------|
| REQ-001 | 2.1, 2.2, 2.3 | SonarQubeAPIInterface | internal/entity/sonarqube/sonarqube.go:L21-652 | Частично | Требуется реализация unit-тестов |
| REQ-002 | 10.1, 10.2 | Configuration Management | internal/config/config.go:L54, internal/config/sonarqube.go | Реализовано | Требуется реализация unit-тестов |
| REQ-003 | 9.1, 9.2, 9.3 | Error Handling | internal/entity/sonarqube/errors.go, internal/service/sonarqube/error_handling.go | Частично | Требуется расширение обработки ошибок |
| REQ-004 | 9.3 | Retry Mechanism | internal/entity/sonarqube/sonarqube.go:L127-197 | Реализовано | Требуется unit-тестирование |
| REQ-005 | 4.1, 4.2, 4.3 | SQScanBranch | internal/service/sonarqube/branch.go | Частично | Требуется реализация инкрементального сканирования |
| REQ-006 | 5.1, 5.2 | SQScanPR | internal/service/sonarqube/pr.go | Частично | Требуется интеграция с Gitea API |
| REQ-007 | 3.1, 3.2 | SonarScannerService | internal/service/sonarqube/scanner.go, internal/entity/sonarqube/scanner.go | Частично | Требуется реализация unit-тестов |
| REQ-008 | 7.1, 7.2, 7.3 | Reporting | internal/service/sonarqube/reporting.go | Частично | Требуется реализация получения ошибок между коммитами |
| REQ-009 | 6.1, 6.2, 6.3 | Project Management | internal/service/sonarqube/project.go | Частично | Требуется реализация синхронизации администраторов |
| REQ-010 | 8.1, 8.2 | SQCommandHandler | internal/service/sonarqube/command_handler.go | Частично | Требуется реализация всех методов обработки команд |
| REQ-011 | 11.1, 11.2, 11.3 | Testing | internal/service/sonarqube/testing.go | Не реализовано | Требуется реализация всех unit-тестов |
| REQ-012 | 12.1, 12.2 | Monitoring | internal/service/sonarqube/monitoring.go | Частично | Требуется реализация метрик и health checks |
| REQ-013 | 9.2 | Logging | internal/service/sonarqube/logging.go | Частично | Требуется расширение логирования |
| REQ-014 | 10.1, 10.2 | Configuration | internal/config/sonarqube.go | Реализовано | Требуется unit-тестирование |
| REQ-015 | 13.1, 13.2 | Documentation | internal/service/sonarqube/documentation.go | Частично | Требуется создание API документации |
| REQ-017 | 1.0 | Core Interfaces | internal/entity/sonarqube/interfaces.go | Реализовано | Требуется расширение интерфейсов для недостающих методов |
| REQ-018 | 11.0 | Test Coverage | internal/service/sonarqube/testing.go | Не реализовано | Требуется достижение 80% покрытия кода тестами |

## 3. Индекс незавершенных участков кода

| КОД | МЕТКА | КОНТЕКСТ | ССЫЛКИ | РИСК/ВЛИЯНИЕ |
|-------|----------|--------|--------------|
| internal/entity/sonarqube/sonarqube.go:L645-652 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add unit tests for all methods | tasks.md: 2.1, 2.2; requirements.md: 1.1, 3.1, 3.2, 9.1, 9.2 | Без тестов невозможно гарантировать корректную работу API клиента |
| internal/service/sonarqube/service.go:L509-519 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Caching mechanism improvements with expiration based on time - Cache invalidation strategies - Bulk operations for better performance - Advanced filtering and sorting for project lists - Metrics aggregation and analysis - Integration with other services for cross-functional operations | tasks.md: 2.3; requirements.md: 3.1, 3.2, 9.1 | Отсутствие улучшенного кэширования может привести к снижению производительности |
| internal/service/sonarqube/command_handler.go:L218-227 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add unit tests for all methods - Implement more sophisticated command routing - Add support for different command types - Implement better error handling and recovery - Add progress reporting during command execution | tasks.md: 8.1; requirements.md: 9.1, 9.3 | Без тестов невозможно гарантировать корректную работу обработчика команд |
| internal/service/sonarqube/project.go:L278-286 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add unit tests for all methods - Implement project age checking and deletion logic - Implement better error handling and recovery - Add progress reporting during operations | tasks.md: 6.1, 6.2, 6.3; requirements.md: 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4, 5.5 | Без тестов невозможно гарантировать корректную работу управления проектами |
| internal/service/sonarqube/branch.go:L299-309 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add unit tests for all methods - Implement more sophisticated branch data retrieval - Add support for different branch types (main, feature, release, etc.) - Implement better error handling and recovery - Add progress reporting during scanning - Implement caching for branch data | tasks.md: 4.1, 4.2; requirements.md: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6 | Без тестов невозможно гарантировать корректную работу сканирования веток |
| internal/service/sonarqube/pr.go:L106-13 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add unit tests for all methods - Implement better error handling and recovery - Add progress reporting during scanning | tasks.md: 5.1; requirements.md: 2.1, 2.2, 2.3 | Без тестов невозможно гарантировать корректную работу сканирования PR |
| internal/service/sonarqube/reporting.go:L113-120 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add unit tests for all methods | tasks.md: 7.1, 7.2, 7.3; requirements.md: 7.1, 7.2 | Без тестов невозможно гарантировать корректную работу отчетов |
| internal/service/sonarqube/error_handling.go:L311-318 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add unit tests for all methods | tasks.md: 9.1, 9.2, 9.3; requirements.md: 9.1, 9.3, 9.4, 11, 12 | Без тестов невозможно гарантировать корректную работу обработки ошибок |
| internal/service/sonarqube/logging.go:L150-157 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add unit tests for all methods | tasks.md: 9.2; requirements.md: 9.1, 12 | Без тестов невозможно гарантировать корректную работу логирования |
| internal/service/sonarqube/config.go:L228-235 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add unit tests for all methods | tasks.md: 10.1, 10.2; requirements.md: 9.2, 9.3, 11, 12 | Без тестов невозможно гарантировать корректную работу конфигурации |
| internal/service/sonarqube/scanner.go:L191-198 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add unit tests for all methods | tasks.md: 3.1, 3.2; requirements.md: 10.1, 10.2, 10.3, 11, 12 | Без тестов невозможно гарантировать корректную работу сканера |
| internal/service/sonarqube/testing.go:L112-123 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add comprehensive unit tests for all components - Implement integration tests for complete command workflows - Add end-to-end tests for all SQ commands - Implement performance benchmarks for scanning operations - Implement load testing for concurrent operations - Create tests for real-world scenarios - Achieve minimum 80% code coverage | tasks.md: 11.1, 11.2, 11.3; requirements.md: 11, 12 | Отсутствие тестов делает невозможным проверку корректности реализации |
| internal/service/sonarqube/documentation.go:L242-249 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Write comprehensive API documentation for all interfaces | tasks.md: 13.1; requirements.md: 11, 12 | Отсутствие документации затрудняет использование и поддержку кода |
| internal/service/sonarqube/monitoring.go:L213-20 | ToDo | Необходимо дополнительно реализовать следующий функционал: - Add comprehensive metrics collection for all components | tasks.md: 12.1, 12.2; requirements.md: 11, 12 | Отсутствие метрик затрудняет мониторинг и диагностику |
| internal/config/config.go:L180-181 | TODO | Устаревшие поля (сохранены для обратной совместимости) TODO: Удалить после полной миграции | | Риск безопасности при использовании устаревших полей |
| internal/constants/constants.go:L39-40 | ToDo | StoreRoot - корневой путь хранилища ToDo: перенести значение в конфигурацию | | Риск жестко закодированных путей |
| internal/entity/dbrestore/dbrestore.go:L247-248 | ToDo | Обязательно удалить! | | Риск безопасности из-за хранения пароля в коде |
| internal/entity/dbrestore/dbrestore.go:L292-293 | ToDo | Заменить на шифрование yaml (sops) | Риск безопасности из-за хранения пароля в коде |
| internal/entity/one/designer/designer.go:L92-93 | ToDo | заменить на приличное | Риск некорректной работы с параметрами |
| internal/entity/one/designer/designer.go:L180-181 | ToDo | дополнить игнорирование предупреждений | | Риск некорректной обработки ошибок |
| internal/entity/one/designer/designer.go:L191-192 | ToDo | дополнить игнорирование предупреждений | | Риск некорректной обработки ошибок |
| internal/service/sonarqube/branch.go:L359-360 | STUB | Simplified implementation - in a real implementation, you would need to scan the base commit | | Риск некорректной работы инкрементального сканирования |
| internal/service/sonarqube/branch.go:L364-365 | STUB | Simplified implementation - in a real implementation, you would need to scan incremental changes | | Риск некорректной работы инкрементального сканирования |
| internal/service/sonarqube/branch.go:L376-377 | STUB | Simplified implementation - in a real implementation, you would need to scan specific commit | | Риск некорректной работы сканирования конкретного коммита |
| internal/service/sonarqube/branch.go:L386-387 | STUB | Simplified implementation - in a real implementation, you would need to scan specific commit | | Риск некорректной работы сканирования конкретного коммита |
| internal/service/sonarqube/command_handler.go:L104-105 | STUB | Simplified implementation - in a real implementation, you would need to retrieve PR data from Gitea and then delegate to the branch scanning service | | Риск некорректной работы обработки PR |
| internal/service/sonarqube/command_handler.go:L116-117 | STUB | Simplified implementation - in a real implementation, you would need to update project metadata in SonarQube | | Риск некорректной работы обновления проектов |
| internal/service/sonarqube/command_handler.go:L133-134 | STUB | Simplified implementation - in a real implementation, you would need to synchronize repository branches with SonarQube projects | | Риск некорректной работы синхронизации репозиториев |
| internal/service/sonarqube/command_handler.go:L151-152 | STUB | Simplified implementation - in a real implementation, you would need to clear old projects from SonarQube | | Риск некорректной работы очистки репозиториев |
| internal/service/sonarqube/command_handler.go:L171-172 | STUB | Simplified implementation - in a real implementation, you would need to generate a report for a PR | | Риск некорректной работы генерации отчетов по PR |
| internal/service/sonarqube/command_handler.go:L192-193 | STUB | Simplified implementation - in a real implementation, you would need to generate a report for a branch | | Риск некорректной работы генерации отчетов по веткам |
| internal/service/sonarqube/command_handler.go:L211-212 | STUB | Simplified implementation - in a real implementation, you would need to generate a report for a project | | Риск некорректной работы генерации отчетов по проектам |
| internal/service/sonarqube/pr.go:L99-10 | STUB | Simplified implementation - in a real implementation, you would need to get the source branch name | | Риск некорректной работы определения ветки источника |
| internal/service/sonarqube/project.go:L267-268 | STUB | Simplified implementation - in a real implementation, you would need to get the last analysis date and compare it with the current date | | Риск некорректной работы проверки возраста проекта |
| internal/service/sonarqube/project.go:L270-271 | STUB | In a real implementation, you would delete the project if it's older than the threshold | | Риск некорректной работы удаления устаревших проектов |

## 4. Детальный план реализации (по шагам)

### TASK-1: Завершение реализации SonarQube API клиента
**Связанные требования:** REQ-001, REQ-017
**Связанные пункты плана:** TASK-2.1, TASK-2.2, TASK-2.3
**Связанные разделы дизайна:** SonarQubeAPIInterface
**Точки входа в код:** internal/entity/sonarqube/sonarqube.go:L21-652, internal/entity/sonarqube/interfaces.go:L19-75
**Что нужно изменить/добавить:** 
- Реализовать недостающие методы в интерфейсе SonarQubeAPIInterface
- Добавить unit-тесты для всех методов SonarQubeEntity
- Расширить обработку ошибок API с детализацией для различных типов ошибок SonarQube
- Добавить методы для работы с качеством кода (quality gates, метрики и т.д.)
**Граничные случаи/ошибки:** 
- Обработка ошибок сети и таймаутов
- Обработка ошибок аутентификации
- Обработка ошибок API с различными кодами состояния
- Обработка пустых ответов от API
**Безопасность и доступы:** 
- Проверка корректности токена перед каждым запросом
- Логирование без раскрытия чувствительных данных
- Защита от injection атак при формировании запросов
**Производительность и ресурсы:** 
- Оптимизация количества запросов к API
- Правильное закрытие HTTP соединений
- Ограничение по времени выполнения запросов
**Зависимости от других задач:** 
- Зависит от завершения реализации конфигурационной системы (TASK-10)
**Миграции и обратная совместимость:** 
- Сохранение совместимости с существующими методами
- Добавление новых методов без изменения сигнатур существующих
**Тесты:** 
- Unit-тесты для всех методов API клиента
- Тесты для обработки ошибок
- Тесты для различных сценариев ответов API
- Mock-тесты для эмуляции различных состояний API
**Артефакты/документация:** 
- Обновление GoDoc комментариев в interfaces.go
- Добавление примеров использования в documentation.go
**Определение готовности (DoD):** 
- [ ] Все методы интерфейса реализованы
- [ ] Добавлены unit-тесты с покрытием не менее 80%
- [ ] Реализована обработка всех типов ошибок
- [ ] Проведено ручное тестирование всех методов
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Методы корректно работают с реальным SonarQube API
- [ ] Ошибки обрабатываются с понятными сообщениями
- [ ] Тесты проходят успешно
- [ ] Документация соответствует реализации

### TASK-2: Завершение реализации сервиса SonarQube
**Связанные требования:** REQ-001, REQ-009
**Связанные пункты плана:** TASK-2.3
**Связанные разделы дизайна:** SonarQubeService
**Точки входа в код:** internal/service/sonarqube/service.go:L17-L519
**Что нужно изменить/добавить:** 
- Реализовать улучшенный механизм кэширования с истечением по времени
- Добавить стратегии инвалидации кэша
- Реализовать bulk операции для повышения производительности
- Добавить расширенную фильтрацию и сортировку для списков проектов
- Реализовать агрегацию метрик и анализ
- Добавить интеграцию с другими сервисами для кросс-функциональных операций
**Граничные случаи/ошибки:** 
- Обработка переполнения кэша
- Обработка истечения времени жизни кэша
- Обработка ошибок при bulk операциях
- Обработка пустых результатов при фильтрации
**Безопасность и доступы:** 
- Защита кэша от несанкционированного доступа
- Проверка прав доступа при bulk операциях
**Производительность и ресурсы:** 
- Оптимизация использования памяти для кэша
- Минимизация времени отклика за счет кэширования
- Эффективное использование ресурсов при bulk операциях
**Зависимости от других задач:** 
- Зависит от завершения TASK-1 (API клиент)
**Миграции и обратная совместимость:** 
- Сохранение существующего API сервиса
- Постепенная миграция на улучшенный кэш
**Тесты:** 
- Unit-тесты для кэширующих методов
- Тесты производительности для bulk операций
- Тесты для сценариев истечения кэша
- Интеграционные тесты с реальным API
**Артефакты/документация:** 
- Обновление комментариев в service.go
- Добавление документации по кэшированию
**Определение готовности (DoD):** 
- [ ] Реализован улучшенный механизм кэширования
- [ ] Добавлены стратегии инвалидации кэша
- [ ] Реализованы bulk операции
- [ ] Добавлена расширенная фильтрация и сортировка
- [ ] Проведено тестирование производительности
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Кэш корректно работает с истечением по времени
- [ ] Bulk операции значительно быстрее одиночных
- [ ] Фильтрация и сортировка работают корректно
- [ ] Все тесты проходят успешно

### TASK-3: Завершение реализации обработчика команд SonarQube
**Связанные требования:** REQ-010
**Связанные пункты плана:** TASK-8.1, TASK-8.2
**Связанные разделы дизайна:** SQCommandHandlerInterface
**Точки входа в код:** internal/service/sonarqube/command_handler.go:L15-L227
**Что нужно изменить/добавить:** 
- Реализовать все методы обработки команд (HandleSQScanBranch, HandleSQScanPR, и т.д.)
- Добавить более сложную маршрутизацию команд
- Поддержку различных типов команд
- Улучшенную обработку ошибок и восстановление
- Отчеты о прогрессе во время выполнения команд
**Граничные случаи/ошибки:** 
- Обработка недопустимых параметров команд
- Обработка ошибок выполнения команд
- Обработка прерываний выполнения команд
- Обработка таймаутов при длительных операциях
**Безопасность и доступы:** 
- Проверка прав доступа для каждой команды
- Логирование операций без раскрытия чувствительных данных
**Производительность и ресурсы:** 
- Минимизация времени отклика обработчика
- Эффективное использование ресурсов при параллельном выполнении
**Зависимости от других задач:** 
- Зависит от завершения всех сервисов SonarQube
**Миграции и обратная совместимость:** 
- Сохранение совместимости с существующими командами
- Постепенное добавление новых типов команд
**Тесты:** 
- Unit-тесты для всех методов обработчика
- Тесты для обработки ошибок
- Тесты для различных сценариев команд
- Интеграционные тесты с реальными сервисами
**Артефакты/документация:** 
- Обновление комментариев в command_handler.go
- Добавление примеров использования команд
**Определение готовности (DoD):** 
- [ ] Все методы обработки команд реализованы
- [ ] Добавлена сложная маршрутизация команд
- [ ] Реализована поддержка различных типов команд
- [ ] Улучшена обработка ошибок
- [ ] Добавлены отчеты о прогрессе
- [ ] Все тесты проходят успешно
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Все команды корректно обрабатываются
- [ ] Ошибки обрабатываются с восстановлением
- [ ] Прогресс выполнения отображается
- [ ] Тесты проходят успешно

### TASK-4: Завершение реализации управления проектами
**Связанные требования:** REQ-009
**Связанные пункты плана:** TASK-6.1, TASK-6.2, TASK-6.3
**Связанные разделы дизайна:** ProjectManagementService
**Точки входа в код:** internal/service/sonarqube/project.go:L15-L286
**Что нужно изменить/добавить:** 
- Реализовать проверку возраста проекта и удаление
- Добавить unit-тесты для всех методов
- Улучшить обработку ошибок и восстановление
- Добавить отчеты о прогрессе во время операций
**Граничные случаи/ошибки:** 
- Обработка недопустимых параметров проекта
- Обработка ошибок при синхронизации администраторов
- Обработка ошибок при проверке возраста проекта
- Обработка ошибок при удалении проектов
**Безопасность и доступы:** 
- Проверка прав доступа при управлении проектами
- Защита от удаления активных проектов
**Производительность и ресурсы:** 
- Минимизация времени выполнения операций
- Эффективное использование ресурсов при параллельной обработке
**Зависимости от других задач:** 
- Зависит от завершения сервиса SonarQube (TASK-2)
**Миграции и обратная совместимость:** 
- Сохранение совместимости с существующими методами управления
**Тесты:** 
- Unit-тесты для всех методов управления проектами
- Тесты для сценариев проверки возраста проекта
- Тесты для сценариев синхронизации администраторов
- Интеграционные тесты с реальным API
**Артефакты/документация:** 
- Обновление комментариев в project.go
- Добавление документации по управлению проектами
**Определение готовности (DoD):** 
- [ ] Реализована проверка возраста проекта и удаление
- [ ] Добавлены unit-тесты
- [ ] Улучшена обработка ошибок
- [ ] Добавлены отчеты о прогрессе
- [ ] Все тесты проходят успешно
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Проверка возраста проекта работает корректно
- [ ] Удаление проектов происходит безопасно
- [ ] Синхронизация администраторов работает корректно
- [ ] Тесты проходят успешно

### TASK-5: Завершение реализации сканирования веток
**Связанные требования:** REQ-005
**Связанные пункты плана:** TASK-4.1, TASK-4.2
**Связанные разделы дизайна:** BranchScanningService
**Точки входа в код:** internal/service/sonarqube/branch.go:L16-L309
**Что нужно изменить/добавить:** 
- Реализовать сложное получение данных о ветках
- Добавить поддержку различных типов веток (main, feature, release и т.д.)
- Улучшить обработку ошибок и восстановление
- Добавить отчеты о прогрессе во время сканирования
- Реализовать кэширование данных о ветках
**Граничные случаи/ошибки:** 
- Обработка недопустимых имен веток
- Обработка ошибок при получении данных о ветках
- Обработка ошибок при сканировании базового коммита
- Обработка ошибок при инкрементальном сканировании
**Безопасность и доступы:** 
- Проверка прав доступа к репозиториям
- Защита от сканирования закрытых веток без разрешения
**Производительность и ресурсы:** 
- Минимизация времени сканирования
- Эффективное использование ресурсов при параллельном сканировании
- Кэширование данных о ветках для ускорения повторных операций
**Зависимости от других задач:** 
- Зависит от завершения сервиса сканера (TASK-7)
**Миграции и обратная совместимость:** 
- Сохранение совместимости с существующими методами сканирования
**Тесты:** 
- Unit-тесты для всех методов сканирования веток
- Тесты для сценариев сканирования различных типов веток
- Тесты для инкрементального сканирования
- Интеграционные тесты с реальным API и сканером
**Артефакты/документация:** 
- Обновление комментариев в branch.go
- Добавление документации по сканированию веток
**Определение готовности (DoD):** 
- [ ] Реализовано сложное получение данных о ветках
- [ ] Добавлена поддержка различных типов веток
- [ ] Улучшена обработка ошибок
- [ ] Добавлены отчеты о прогрессе
- [ ] Реализовано кэширование данных о ветках
- [ ] Все тесты проходят успешно
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Сканирование всех типов веток работает корректно
- [ ] Инкрементальное сканирование работает эффективно
- [ ] Кэширование ускоряет повторные операции
- [ ] Тесты проходят успешно

### TASK-6: Завершение реализации сканирования PR
**Связанные требования:** REQ-006
**Связанные пункты плана:** TASK-5.1, TASK-5.2
**Связанные разделы дизайна:** PRScanningService
**Точки входа в код:** internal/service/sonarqube/pr.go:L15-L113
**Что нужно изменить/добавить:** 
- Реализовать получение данных PR из Gitea API
- Извлечь имя ветки источника из данных PR
- Интегрировать сканирование PR со сканированием веток
- Добавить параметры сканирования, специфичные для PR
- Добавить обработку результатов сканирования PR
**Граничные случаи/ошибки:** 
- Обработка недопустимых номеров PR
- Обработка ошибок при получении данных PR
- Обработка ошибок при извлечении ветки источника
- Обработка ошибок при сканировании PR
**Безопасность и доступы:** 
- Проверка прав доступа к PR
- Защита от сканирования закрытых PR без разрешения
**Производительность и ресурсы:** 
- Минимизация времени сканирования PR
- Эффективное использование ресурсов при параллельном сканировании
**Зависимости от других задач:** 
- Зависит от завершения сканирования веток (TASK-5)
- Зависит от интеграции с Gitea API
**Миграции и обратная совместимость:** 
- Сохранение совместимости с существующими методами сканирования
**Тесты:** 
- Unit-тесты для всех методов сканирования PR
- Тесты для сценариев получения данных PR
- Тесты для извлечения ветки источника
- Интеграционные тесты с реальным Gitea API
**Артефакты/документация:** 
- Обновление комментариев в pr.go
- Добавление документации по сканированию PR
**Определение готовности (DoD):** 
- [ ] Реализовано получение данных PR из Gitea API
- [ ] Извлечено имя ветки источника
- [ ] Интегрировано сканирование PR со сканированием веток
- [ ] Добавлены параметры сканирования PR
- [ ] Добавлена обработка результатов сканирования
- [ ] Все тесты проходят успешно
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Получение данных PR работает корректно
- [ ] Извлечение ветки источника работает корректно
- [ ] Интеграция со сканированием веток работает
- [ ] Тесты проходят успешно

### TASK-7: Завершение реализации сервиса сканера
**Связанные требования:** REQ-007
**Связанные пункты плана:** TASK-3.1, TASK-3.2
**Связанные разделы дизайна:** SonarScannerService
**Точки входа в код:** internal/service/sonarqube/scanner.go:L15-L198, internal/entity/sonarqube/scanner.go
**Что нужно изменить/добавить:** 
- Добавить unit-тесты для всех методов
- Реализовать все методы интерфейса SonarScannerInterface
- Улучшить обработку ошибок сканера
- Добавить мониторинг выполнения сканирования
**Граничные случаи/ошибки:** 
- Обработка ошибок загрузки сканера
- Обработка ошибок конфигурации сканера
- Обработка ошибок выполнения сканирования
- Обработка таймаутов сканирования
**Безопасность и доступы:** 
- Защита конфигурации сканера от несанкционированного доступа
- Проверка источника загрузки сканера
**Производительность и ресурсы:** 
- Оптимизация времени загрузки сканера
- Эффективное использование ресурсов при выполнении сканирования
- Минимизация потребления памяти
**Зависимости от других задач:** 
- Зависит от завершения entity сканера
**Миграции и обратная совместимость:** 
- Сохранение совместимости с существующими методами
**Тесты:** 
- Unit-тесты для всех методов сервиса сканера
- Тесты для обработки ошибок сканера
- Тесты для различных сценариев конфигурации
- Интеграционные тесты с реальным сканером
**Артефакты/документация:** 
- Обновление комментариев в scanner.go
- Добавление документации по использованию сканера
**Определение готовности (DoD):** 
- [ ] Добавлены unit-тесты для всех методов
- [ ] Реализованы все методы интерфейса
- [ ] Улучшена обработка ошибок
- [ ] Добавлен мониторинг выполнения
- [ ] Все тесты проходят успешно
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Все методы сервиса работают корректно
- [ ] Ошибки сканера обрабатываются правильно
- [ ] Конфигурация сканера работает гибко
- [ ] Тесты проходят успешно

### TASK-8: Завершение реализации отчетов
**Связанные требования:** REQ-008
**Связанные пункты плана:** TASK-7.1, TASK-7.2, TASK-7.3
**Связанные разделы дизайна:** ReportingService
**Точки входа в код:** internal/service/sonarqube/reporting.go:L15-L120
**Что нужно изменить/добавить:** 
- Добавить unit-тесты для всех методов
- Реализовать получение ошибок между коммитами
- Добавить форматирование отчетов в JSON
- Реализовать комплексные отчеты по проектам
**Граничные случаи/ошибки:** 
- Обработка ошибок получения данных для отчетов
- Обработка пустых результатов
- Обработка ошибок форматирования отчетов
- Обработка таймаутов при получении данных
**Безопасность и доступы:** 
- Защита данных отчетов от несанкционированного доступа
- Проверка прав доступа к отчетам
**Производительность и ресурсы:** 
- Оптимизация времени получения данных для отчетов
- Эффективное использование памяти при формировании отчетов
- Кэширование данных отчетов
**Зависимости от других задач:** 
- Зависит от завершения API клиента (TASK-1)
**Миграции и обратная совместимость:** 
- Сохранение совместимости с существующими методами отчетов
**Тесты:** 
- Unit-тесты для всех методов отчетов
- Тесты для различных форматов отчетов
- Тесты для сценариев пустых результатов
- Интеграционные тесты с реальным API
**Артефакты/документация:** 
- Обновление комментариев в reporting.go
- Добавление документации по отчетам
**Определение готовности (DoD):** 
- [ ] Добавлены unit-тесты для всех методов
- [ ] Реализовано получение ошибок между коммитами
- [ ] Добавлено форматирование отчетов в JSON
- [ ] Реализованы комплексные отчеты по проектам
- [ ] Все тесты проходят успешно
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Получение ошибок между коммитами работает корректно
- [ ] Форматирование отчетов работает правильно
- [ ] Комплексные отчеты по проектам создаются успешно
- [ ] Тесты проходят успешно

### TASK-9: Завершение реализации обработки ошибок и логирования
**Связанные требования:** REQ-003, REQ-013
**Связанные пункты плана:** TASK-9.1, TASK-9.2, TASK-9.3
**Связанные разделы дизайна:** Error Handling, Logging
**Точки входа в код:** internal/service/sonarqube/error_handling.go:L15-L318, internal/service/sonarqube/logging.go:L15-L157
**Что нужно изменить/добавить:** 
- Добавить unit-тесты для всех методов обработки ошибок
- Расширить систему типизированных ошибок
- Добавить unit-тесты для всех методов логирования
- Расширить структурированное логирование
- Реализовать механизм повтора с экспоненциальной задержкой
- Реализовать circuit breaker для внешних вызовов API
- Добавить таймауты с отменой через контекст
**Граничные случаи/ошибки:** 
- Обработка всех типов ошибок API
- Обработка сетевых ошибок
- Обработка ошибок конфигурации
- Обработка ошибок выполнения сканера
**Безопасность и доступы:** 
- Логирование без раскрытия чувствительных данных
- Защита от log injection атак
**Производительность и ресурсы:** 
- Минимизация накладных расходов на логирование
- Эффективное использование ресурсов при обработке ошибок
- Оптимизация механизмов повтора
**Зависимости от других задач:** 
- Зависит от завершения всех компонентов системы
**Миграции и обратная совместимость:** 
- Сохранение совместимости с существующими методами обработки ошибок
- Постепенное внедрение улучшенного логирования
**Тесты:** 
- Unit-тесты для всех методов обработки ошибок
- Unit-тесты для всех методов логирования
- Тесты для сценариев повтора
- Тесты для сценариев circuit breaker
- Интеграционные тесты с реальными ошибками
**Артефакты/документация:** 
- Обновление комментариев в error_handling.go и logging.go
- Добавление документации по обработке ошибок и логированию
**Определение готовности (DoD):** 
- [ ] Добавлены unit-тесты для обработки ошибок
- [ ] Расширена система типизированных ошибок
- [ ] Добавлены unit-тесты для логирования
- [ ] Расширено структурированное логирование
- [ ] Реализован механизм повтора
- [ ] Реализован circuit breaker
- [ ] Добавлены таймауты с контекстом
- [ ] Все тесты проходят успешно
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Все типы ошибок обрабатываются корректно
- [ ] Логирование содержит всю необходимую информацию
- [ ] Механизмы повтора работают эффективно
- [ ] Circuit breaker защищает от каскадных сбоев
- [ ] Тесты проходят успешно

### TASK-10: Завершение реализации конфигурационной системы
**Связанные требования:** REQ-002, REQ-014
**Связанные пункты плана:** TASK-10.1, TASK-10.2
**Связанные разделы дизайна:** Configuration Management
**Точки входа в код:** internal/config/sonarqube.go, internal/service/sonarqube/config.go:L15-L235
**Что нужно изменить/добавить:** 
- Добавить unit-тесты для всех методов конфигурации
- Реализовать валидацию и установку значений по умолчанию
- Добавить поддержку переменных окружения для чувствительных данных
- Реализовать горячую перезагрузку конфигурации
**Граничные случаи/ошибки:** 
- Обработка отсутствующих конфигурационных файлов
- Обработка некорректных значений в конфигурации
- Обработка ошибок доступа конфигурационным файлам
- Обработка ошибок парсинга конфигурации
**Безопасность и доступы:** 
- Защита чувствительных данных в конфигурации
- Проверка прав доступа к конфигурационным файлам
- Шифрование токенов и паролей
**Производительность и ресурсы:** 
- Минимизация времени загрузки конфигурации
- Эффективное использование памяти при хранении конфигурации
- Оптимизация горячей перезагрузки
**Зависимости от других задач:** 
- Зависит от структуры конфигурационных файлов проекта
**Миграции и обратная совместимость:** 
- Сохранение совместимости с существующими конфигурациями
- Постепенная миграция на новые параметры
**Тесты:** 
- Unit-тесты для всех методов конфигурации
- Тесты для сценариев отсутствующих файлов
- Тесты для сценариев некорректных значений
- Интеграционные тесты с реальными файлами конфигурации
**Артефакты/документация:** 
- Обновление комментариев в config.go
- Добавление документации по конфигурации
**Определение готовности (DoD):** 
- [ ] Добавлены unit-тесты для конфигурации
- [ ] Реализована валидация и значения по умолчанию
- [ ] Добавлена поддержка переменных окружения
- [ ] Реализована горячая перезагрузка
- [ ] Все тесты проходят успешно
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Конфигурация загружается корректно
- [ ] Валидация работает правильно
- [ ] Переменные окружения используются безопасно
- [ ] Горячая перезагрузка работает без сбоев
- [ ] Тесты проходят успешно

### TASK-11: Реализация комплексного тестирования
**Связанные требования:** REQ-011, REQ-018
**Связанные пункты плана:** TASK-11.1, TASK-11.2, TASK-11.3
**Связанные разделы дизайна:** Testing Strategy
**Точки входа в код:** internal/service/sonarqube/testing.go:L1-L123
**Что нужно изменить/добавить:** 
- Реализовать unit-тесты для всех компонентов
- Создать интеграционные тесты для полных сценариев команд
- Добавить end-to-end тесты для всех команд SQ
- Реализовать тесты производительности для операций сканирования
- Реализовать нагрузочные тесты для параллельных операций
- Создать тесты для реальных сценариев использования
- Достичь минимум 80% покрытия кода тестами
**Граничные случаи/ошибки:** 
- Тестирование всех сценариев ошибок
- Тестирование граничных условий
- Тестирование сценариев таймаутов
- Тестирование сценариев частичных сбоев
**Безопасность и доступы:** 
- Тестирование сценариев нарушения безопасности
- Тестирование сценариев несанкционированного доступа
**Производительность и ресурсы:** 
- Тестирование производительности при различных нагрузках
- Тестирование использования ресурсов
- Тестирование масштабируемости
**Зависимости от других задач:** 
- Зависит от завершения всех компонентов системы
**Миграции и обратная совместимость:** 
- Проверка обратной совместимости через тесты
**Тесты:** 
- Все перечисленные тесты являются частью этой задачи
**Артефакты/документация:** 
- Обновление комментариев в testing.go
- Добавление документации по тестированию
**Определение готовности (DoD):** 
- [ ] Реализованы unit-тесты для всех компонентов
- [ ] Созданы интеграционные тесты
- [ ] Добавлены end-to-end тесты
- [ ] Реализованы тесты производительности
- [ ] Реализованы нагрузочные тесты
- [ ] Созданы тесты реальных сценариев
- [ ] Достигнуто 80% покрытие кода тестами
- [ ] Все тесты проходят успешно
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Все типы тестов успешно проходят
- [ ] Покрытие кода составляет не менее 80%
- [ ] Производительность соответствует требованиям
- [ ] Система проходит все сценарии безопасности

### TASK-12: Реализация мониторинга и наблюдаемости
**Связанные требования:** REQ-012
**Связанные пункты плана:** TASK-12.1, TASK-12.2
**Связанные разделы дизайна:** Monitoring and Observability
**Точки входа в код:** internal/service/sonarqube/monitoring.go:L15-L220, internal/service/sonarqube/service.go
**Что нужно изменить/добавить:** 
- Реализовать сбор метрик, совместимых с Prometheus
- Реализовать мониторинг производительности
- Добавить отслеживание использования ресурсов
- Реализовать health check endpoints
- Добавить сбор диагностической информации
- Реализовать отчеты о состоянии системы
**Граничные случаи/ошибки:** 
- Обработка ошибок сбора метрик
- Обработка ошибок health check
- Обработка ошибок сбора диагностической информации
**Безопасность и доступы:** 
- Защита метрик от несанкционированного доступа
- Проверка прав доступа к health check
**Производительность и ресурсы:** 
- Минимизация накладных расходов на сбор метрик
- Эффективное использование ресурсов при мониторинге
**Зависимости от других задач:** 
- Зависит от завершения всех компонентов системы
**Миграции и обратная совместимость:** 
- Постепенное внедрение мониторинга без сбоев
**Тесты:** 
- Тесты для всех методов сбора метрик
- Тесты для health check endpoints
- Тесты для сбора диагностической информации
**Артефакты/документация:** 
- Обновление комментариев в monitoring.go
- Добавление документации по мониторингу
**Определение готовности (DoD):** 
- [ ] Реализован сбор метрик Prometheus
- [ ] Реализован мониторинг производительности
- [ ] Добавлено отслеживание ресурсов
- [ ] Реализованы health check endpoints
- [ ] Добавлен сбор диагностической информации
- [ ] Реализованы отчеты о состоянии системы
- [ ] Все тесты проходят успешно
- [ ] Обновлена документация
**Критерии приёмки:** 
- [ ] Метрики собираются корректно
- [ ] Производительность отслеживается эффективно
- [ ] Health check работает надежно
- [ ] Диагностическая информация полезна
- [ ] Тесты проходят успешно

### TASK-13: Подготовка документации и развертывания
**Связанные требования:** REQ-015
**Связанные пункты плана:** TASK-13.1, TASK-13.2
**Связанные разделы дизайна:** Documentation, Deployment Considerations
**Точки входа в код:** internal/service/sonarqube/documentation.go:L15-L249
**Что нужно изменить/добавить:** 
- Написать API документацию для всех интерфейсов
- Создать руководство пользователя для команд SQ
- Добавить руководство по устранению неполадок
- Задокументировать опции конфигурации
- Обновить конфигурацию Docker
- Добавить модификации CI/CD pipeline
- Реализовать скрипты миграции БД при необходимости
- Создать документацию по развертыванию
**Граничные случаи/ошибки:** 
- Обработка недостающей документации
- Обработка устаревшей документации
**Безопасность и доступы:** 
- Защита документации от несанкционированного изменения
**Производительность и ресурсы:** 
- Оптимизация размера документации
- Эффективная структура документации
**Зависимости от других задач:** 
- Зависит от завершения всех компонентов системы
**Миграции и обратная совместимость:** 
- Документирование изменений в миграции
**Тесты:** 
- Проверка полноты документации
- Проверка актуальности документации
**Артефакты/документация:** 
- Все перечисленные документы являются артефактами этой задачи
**Определение готовности (DoD):** 
- [ ] Написана API документация
- [ ] Создано руководство пользователя
- [ ] Добавлено руководство по устранению неполадок
- [ ] Задокументированы опции конфигурации
- [ ] Обновлена конфигурация Docker
- [ ] Добавлены модификации CI/CD
- [ ] Реализованы скрипты миграции при необходимости
- [ ] Создана документация по развертыванию
- [ ] Все документы проверены на актуальность
**Критерии приёмки:** 
- [ ] Документация полная и понятная
- [ ] Руководство пользователя помогает в работе
- [ ] Docker конфигурация корректна
- [ ] CI/CD модификации работают
- [ ] Документация по развертыванию полезна

## 5. План рефакторинга/улучшений (без изменения внешнего поведения)

* Модульные границы: 
  - Уточнить интерфейсы между слоями entity, service и app
  - Выделить общие интерфейсы для взаимодействия с внешними системами
  - Разделить большие сервисы на более мелкие специализированные компоненты

* Интерфейсы и зависимости:
  - Упростить зависимости между компонентами через внедрение интерфейсов
  - Использовать композицию вместо наследования где это возможно
  - Применить принцип инверсии зависимостей (Dependency Inversion Principle)

* Обработка ошибок/логирование:
  - Стандартизировать форматы ошибок по всему проекту
  - Улучшить контекст ошибок с трассировкой вызовов
  - Оптимизировать логирование для лучшей диагностики без ущерба производительности

* Конфигурация и параметры среды:
  - Централизовать конфигурационную систему
  - Улучшить валидацию конфигурационных параметров
  - Добавить поддержку конфигурации через переменные окружения

* Улучшение тестопригодности:
  - Создать интерфейсы для всех внешних зависимостей
  - Упростить создание mock-объектов для тестирования
 - Добавить контракты для всех основных интерфейсов

* Снижение технического долга:
  - Устранить дублирование кода между компонентами
  - Упростить сложные методы и функции
  - Обновить устаревшие части кода в соответствии современными практиками Go

## 6. План тестирования и качество

* Стратегия тестов:
  - Unit-тесты для каждого компонента (80% покрытия)
  - Интеграционные тесты для взаимодействия между компонентами
  - End-to-end тесты для полных сценариев использования
  - Приоритет: critical functionality (безопасность, целостность, отказоустойчивость) > основной функционал > вспомогательный функционал

* Покрытие:
  - Минимум 80% покрытия кода тестами
  - 100% покрытие критических путей выполнения
  - Покрытие всех сценариев ошибок

* Инварианты, idempotency, ретраи, таймауты, контексты:
  - Проверка соблюдения инвариантов данных
  - Тестирование идемпотентности операций
  - Тестирование механизмов повтора
  - Проверка корректной работы таймаутов
  - Тестирование управления контекстом выполнения

* Гейты CI:
  - Линтеры (golint, go vet)
  - Статические анализаторы (staticcheck)
  - Правила SonarQube для Go
  - Проверка покрытия кода тестами

* Нефункциональные проверки:
  - Проверка использования памяти
  - Проверка времени выполнения операций
  - Тестирование параллельности и конкурентности
  - Проверка утечек ресурсов

## 7. Риски и меры их снижения

* Матрица рисков:
  | Риск | Влияние | Вероятность | Меры снижения |
  |------|---------|-------------|---------------|
  | Недостаточное покрытие тестами | Высокое | Средняя | Построение плана тестирования с обязательным покрытием 80% кода |
  | Проблемы с производительностью | Высокое | Низкая | Реализация бенчмарков и профилирование на ранних этапах |
  | Несовместимость с существующими компонентами | Среднее | Средняя | Постепенная интеграция с тщательным тестированием |
  | Проблемы безопасности | Высокое | Низкая | Регулярные аудиты безопасности и code review |
  | Недостатки в документации | Среднее | Высокая | Параллельное создание документации с разработкой |

* План отката:
  - Возможность отключения функционала SonarQube через флаги конфигурации
  - Сохранение совместимости с предыдущими версиями API
  - Реализация feature flags для постепенного внедрения

## 8. Список артефактов к обновлению

* Документация:
  - README.md - обновление с описанием новых команд
  - ADR (Architectural Decision Records) - фиксация архитектурных решений
  - GoDoc комментарии - обновление документации к коду
  - Руководство пользователя - описание всех команд SonarQube

* Конфиги, схемы, диаграммы:
  - app.yaml - обновление с секциями SonarQube и scanner
  - secret.yaml - добавление токена SonarQube
  - Диаграммы классов и компонентов - обновление с новыми компонентами
  - Диаграммы последовательности и активности - обновление с новыми командами

* CI/CD:
  - Скрипты сборки - обновление с учетом новых зависимостей
  - Пайплайны - добавление шагов тестирования SonarQube
  - Конфигурации Docker - обновление с новыми зависимостями

## 9. Приложения

* Полный список найденных `ToDo/TODO/FIXME/STUB` с контекстами:
  - См. раздел 3 "Индекс незавершенных участков кода"

* Список внешних зависимостей их влияния:
  - github.com/stretchr/testify - для unit-тестирования
  - net/http - для взаимодействия с SonarQube API
  - context - для управления таймаутами и отменой операций
  - log/slog - для структурированного логирования
  - time - для работы с временными метками и таймаутами

* Ссылки на ключевые участки кода/коммиты:
  - internal/entity/sonarqube/ - основные entity для работы с SonarQube
  - internal/service/sonarqube/ - сервисный слой интеграции
  - cmd/apk-ci/main.go - интеграция команд в основное приложение
  - internal/config/ - конфигурационная система