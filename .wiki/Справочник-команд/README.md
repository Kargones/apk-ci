# Справочник команд

benadis-runner поддерживает множество команд для автоматизации различных аспектов работы с системами 1C:Enterprise.

## Обзор команд

### Команды управления сервисным режимом

- **[service-mode-enable](service-mode/service-mode-enable.md)** - Включение сервисного режима для информационной базы
- **[service-mode-disable](service-mode/service-mode-disable.md)** - Отключение сервисного режима для информационной базы  
- **[service-mode-status](service-mode/service-mode-status.md)** - Проверка статуса сервисного режима

### Команды работы с базами данных

- **[dbrestore](dbrestore.md)** - Восстановление базы данных из резервной копии
- **[dbupdate](dbupdate.md)** - Обновление конфигурации базы данных
- **[create-temp-db](create-temp-db.md)** - Создание временной базы данных

### Команды работы с конфигурациями

- **[convert](convert.md)** - Конвертация форматов конфигураций
- **[execute-epf](execute-epf.md)** - Выполнение внешних обработок
- **[storebind](storebind.md)** - Привязка к хранилищу конфигурации

### Команды автоматизации

- **[action-menu-build](action-menu-build.md)** - Построение меню действий
- **[issuetask](issuetask.md)** - Работа с задачами

## Общий синтаксис

Все команды benadis-runner следуют единому синтаксису:

```bash
benadis-runner <команда> [параметры] [флаги]
```

### Глобальные параметры

Все команды поддерживают следующие глобальные параметры:

| Параметр | Переменная окружения | Описание |
|----------|---------------------|----------|
| `--config-system` | `BR_CONFIG_SYSTEM` | Путь к системной конфигурации |
| `--config-project` | `BR_CONFIG_PROJECT` | Путь к конфигурации проекта |
| `--config-secret` | `BR_CONFIG_SECRET` | Путь к секретной конфигурации |
| `--env` | `BR_ENV` | Тип окружения (dev/prod) |
| `--actor` | `BR_ACTOR` | Пользователь, инициировавший операцию |
| `--debug` | `BR_DEBUG` | Включение режима отладки |

### Общие флаги

| Флаг | Описание |
|------|----------|
| `--help, -h` | Показать справку |
| `--version, -v` | Показать версию |
| `--verbose` | Подробный вывод |
| `--dry-run` | Имитация выполнения без реальных изменений |

## Коды возврата

Приложение использует стандартные коды возврата для индикации результата выполнения:

| Код | Описание |
|-----|----------|
| 0 | Успешное выполнение |
| 1 | Общая ошибка |
| 2 | Неизвестная команда |
| 5 | Ошибка загрузки конфигурации |
| 6 | Ошибка конвертации |
| 7 | Ошибка обновления хранилища |
| 8 | Ошибки операций (зависит от команды) |
| 11 | Ошибка файла настроек слияния |

## Обработка ошибок

benadis-runner реализует комплексную обработку ошибок во всех командах:

### Стратегия кодов ошибок

- **Код выхода 2**: Неизвестная команда
- **Код выхода 5**: Ошибка загрузки конфигурации
- **Код выхода 6**: Ошибка конвертации
- **Код выхода 7**: Ошибка обновления хранилища
- **Код выхода 8**: Различные ошибки, специфичные для операций
- **Код выхода 11**: Ошибка файла настроек слияния

### Распространение ошибок

- Ошибки распространяются от модулей нижнего уровня к обработчикам команд
- Контекст сохраняется по всей цепочке ошибок
- Специфические детали ошибок логируются перед выходом

### Механизмы восстановления

- Отложенные операции очистки для освобождения ресурсов
- Отмена контекста при таймауте операции
- Обработка частичного успеха где это применимо

### Логирование ошибок

- Сообщения об ошибках включают специфические детали о сбое
- Стек трейс не выводится в продакшене
- Конфиденциальная информация редактируется из сообщений об ошибках

## Поведение логирования

Приложение benadis-runner использует структурированное логирование с конфигурируемыми уровнями:

### Уровни логирования

- **DEBUG**: Подробная информация для отладки
- **INFO**: Общая информация о ходе выполнения
- **WARN**: Предупреждения о потенциальных проблемах
- **ERROR**: Ошибки, которые не прерывают выполнение

### Конфигурация логирования

```bash
# Установка уровня логирования
export BR_LOG_LEVEL="debug"

# Или в app.yaml:
logLevel: "debug"
```

### Структура логов

Логи включают структурированные поля для фильтрации и анализа:

```json
{
    "level": "info",
    "time": "2024-01-15T10:30:45Z",
    "msg": "Команда выполнена успешно",
    "command": "service-mode-enable",
    "infobase": "MyInfobase",
    "duration": "2.5s"
}
```

## Точки интеграции

### Система конфигурации

- Все команды используют централизованную систему конфигурации
- Конфигурация поддерживает переменные окружения, файлы и значения по умолчанию
- Конфиденциальные данные вынесены в отдельную секретную конфигурацию

### Интеграция с системами

Команды интегрируются с различными внешними системами:

- **1C:Enterprise серверы** через RAC (Remote Administration Client)
- **MS SQL Server** для операций с базами данных
- **Gitea** для операций с репозиториями
- **Файловая система** для операций с файлами и директориями

## Примеры использования

### Базовое использование

```bash
# Включение сервисного режима
benadis-runner service-mode-enable --infobase MyInfobase

# Восстановление базы данных
benadis-runner dbrestore --config config.yaml

# Выполнение внешней обработки
benadis-runner execute-epf --file processing.epf
```

### Использование с переменными окружения

```bash
# Установка переменных
export BR_CONFIG_SYSTEM="config/app.yaml"
export BR_INFOBASE_NAME="MyInfobase"
export BR_COMMAND="service-mode-enable"

# Запуск команды
benadis-runner
```

### Интеграция с CI/CD

```yaml
# GitHub Actions пример
- name: Enable Service Mode
  uses: ./
  with:
    command: service-mode-enable
    infobase: MyInfobase
    terminate-sessions: true
```

## Производительность и надежность

### Таймауты

Все команды поддерживают конфигурируемые таймауты:

```yaml
# В app.yaml
timeout: 300  # Общий таймаут в секундах

rac:
  timeout: 30  # Таймаут RAC операций

dbrestore:
  timeout: "3600s"  # Таймаут восстановления БД
  autotimeout: true  # Автоматический расчет таймаута
```

### Повторные попытки

Команды реализуют логику повторных попыток для обработки временных сетевых проблем:

```yaml
rac:
  retries: 3  # Количество повторных попыток
  timeout: 30  # Таймаут между попытками
```

### Оптимизация ресурсов

- Потоковый парсинг вывода команд вместо загрузки полных ответов
- Минимизация количества выполняемых RAC команд
- Правильное освобождение ресурсов через defer блоки