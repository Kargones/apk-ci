# Устранение неполадок

Это руководство поможет диагностировать и решить распространенные проблемы при работе с apk-ci.

## Общие принципы диагностики

### Включение отладочного режима

Первый шаг в диагностике проблем - включение подробного логирования:

```bash
export BR_LOG_LEVEL="debug"
export BR_DEBUG="true"
apk-ci <команда>
```

### Проверка конфигурации

Убедитесь, что все необходимые файлы конфигурации существуют и доступны:

```bash
# Проверка файлов конфигурации
ls -la config/
test -f "$BR_CONFIG_SYSTEM" && echo "app.yaml найден" || echo "app.yaml отсутствует"
test -f "$BR_CONFIG_PROJECT" && echo "project.yaml найден" || echo "project.yaml отсутствует"  
test -f "$BR_CONFIG_SECRET" && echo "secret.yaml найден" || echo "secret.yaml отсутствует"
```

### Проверка переменных окружения

```bash
# Проверка основных переменных
env | grep "^BR_\|^SERVICE_\|^DBRESTORE_\|^INPUT_"

# Проверка обязательных переменных
: ${BR_COMMAND:?"Переменная BR_COMMAND обязательна"}
: ${BR_CONFIG_SYSTEM:?"Переменная BR_CONFIG_SYSTEM обязательна"}
```

## Проблемы установки и настройки

### Отсутствующие бинарные файлы 1cv8

**Симптомы**: Ошибки "command not found" или "no such file or directory"

**Диагностика**:
```bash
# Проверьте, что 1cv8 находится в PATH
which 1cv8
# Ожидаемый вывод: /usr/bin/1cv8 или /opt/1C/v8.3/x86_64/1cv8

# Проверьте установку 1C платформы
ls -la /opt/1C/v8.3/x86_64/
```

**Решение**:
```bash
# Если не найден, добавьте в PATH
export PATH=$PATH:/opt/1C/v8.3/x86_64

# Или создайте символические ссылки
sudo ln -s /opt/1C/v8.3/x86_64/1cv8 /usr/local/bin/
sudo ln -s /opt/1C/v8.3/x86_64/rac /usr/local/bin/
sudo ln -s /opt/1C/v8.3/x86_64/ibcmd /usr/local/bin/
```

### Неправильная конфигурация PATH

**Симптомы**: Команды Go, task, golangci-lint не найдены

**Диагностика**:
```bash
# Проверьте текущий PATH
echo $PATH

# Проверьте доступность инструментов
go version
task --version  
golangci-lint --version
```

**Решение**:
```bash
# Добавьте недостающие пути
export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin:/usr/local/bin

# Добавьте в ~/.bashrc для постоянного эффекта
echo 'export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin:/usr/local/bin' >> ~/.bashrc
source ~/.bashrc
```

### Проблемы с разрешениями

**Симптомы**: "Permission denied", ошибки доступа к файлам

**Диагностика**:
```bash
# Проверьте права доступа к файлам конфигурации
ls -la config/
ls -la build/

# Проверьте владельца и группу
id
groups
```

**Решение**:
```bash
# Для системной установки
sudo ./scripts/install-dev-tools.sh

# Для пользовательской установки
./scripts/install-dev-tools-no-sudo.sh

# Исправьте права доступа к конфигурации
chmod 600 config/secret.yaml
chmod 644 config/app.yaml config/project.yaml
```

## Проблемы подключения

### Проблемы подключения к Gitea

**Симптомы**: Ошибки подключения к API, 401/403 ошибки

**Диагностика**:
```bash
# Проверьте сетевое подключение
ping regdv.apkholding.ru

# Проверьте URL Gitea и токен доступа
echo $GITEA_URL
echo $ACCESS_TOKEN  # НЕ выводите в продакшене!

# Тестируйте доступ к API
curl -H "Authorization: token $ACCESS_TOKEN" $GITEA_URL/api/v1/user
```

**Решение**:
```bash
# Проверьте правильность URL (должен включать протокол)
export GITEA_URL="https://regdv.apkholding.ru"

# Проверьте срок действия токена в Gitea
# Создайте новый токен если необходимо

# Проверьте права доступа токена (должен иметь repo права)
```

### Проблемы подключения к базе данных

**Симптомы**: Ошибки подключения к SQL Server, таймауты

**Диагностика**:
```bash
# Проверьте доступность сервера 1C
telnet <1C-server> 1541

# Проверьте доступность SQL сервера  
telnet <sql-server> 1433

# Проверьте DNS разрешение
nslookup <server-name>
```

**Решение**:
```bash
# Проверьте конфигурацию в dbconfig.yaml
cat config/dbconfig.yaml

# Убедитесь, что переменная BR_INFOBASE_NAME установлена правильно
export BR_INFOBASE_NAME="CorrectDatabaseName"

# Проверьте учетные данные в secret.yaml
```

### Проблемы с RAC подключением

**Симптомы**: Ошибки RAC операций, таймауты

**Диагностика**:
```bash
# Проверьте доступность RAC сервера
telnet <rac-server> 1545

# Проверьте конфигурацию RAC
grep -A10 "rac:" config/app.yaml

# Тестируйте RAC команды напрямую
/opt/1C/v8.3/x86_64/rac cluster list --ras=<server>:1545
```

**Решение**:
```bash
# Проверьте настройки в app.yaml
rac:
  port: 1545
  timeout: 30
  retries: 3

# Увеличьте таймаут если необходимо
export SERVICE_RAC_TIMEOUT="60"

# Проверьте учетные данные RAC в secret.yaml
```

## Проблемы конфигурации

### Неправильная кодировка файлов

**Симптомы**: Ошибки парсинга YAML, странные символы

**Диагностика**:
```bash
# Проверьте кодировку файлов
file config/*.yaml

# Проверьте содержимое на наличие специальных символов
hexdump -C config/app.yaml | head
```

**Решение**:
```bash
# Преобразуйте в UTF-8
iconv -f windows-1251 -t utf-8 config/app.yaml > config/app.yaml.utf8
mv config/app.yaml.utf8 config/app.yaml

# Убедитесь, что редактор сохраняет в UTF-8
```

### Отсутствующие обязательные поля

**Симптомы**: Ошибки валидации конфигурации

**Диагностика**:
```bash
# Проверьте структуру файлов YAML
yamllint config/app.yaml
yamllint config/project.yaml

# Проверьте наличие обязательных полей
grep -E "logLevel|workDir|paths" config/app.yaml
```

**Решение**:
```bash
# Используйте примеры конфигурации
cp examples/app.yaml.example config/app.yaml
cp examples/project.yaml.example config/project.yaml

# Заполните обязательные поля
```

### Конфликты переменных окружения и файлов

**Симптомы**: Неожиданные значения конфигурации

**Диагностика**:
```bash
# Проверьте приоритет загрузки
echo "Переменные окружения (высший приоритет):"
env | grep "^BR_"

echo "Файлы конфигурации:"
cat config/app.yaml
```

**Решение**:
```bash
# Очистите конфликтующие переменные окружения
unset BR_LOG_LEVEL BR_WORK_DIR

# Или явно установите нужные значения
export BR_LOG_LEVEL="debug"
```

## Проблемы выполнения команд

### Команды сервисного режима

#### Информационная база не найдена

**Симптомы**: "infobase not found", "cluster UUID not found"

**Диагностика**:
```bash
# Проверьте имя информационной базы
echo $BR_INFOBASE_NAME

# Проверьте конфигурацию базы данных
grep -A5 "$BR_INFOBASE_NAME" config/dbconfig.yaml

# Список доступных информационных баз (если RAC доступен)
rac infobase summary list --cluster=<cluster-uuid>
```

**Решение**:
```bash
# Убедитесь в правильности имени
export BR_INFOBASE_NAME="CorrectInfobaseName"

# Добавьте конфигурацию базы в dbconfig.yaml
echo "MyInfobase:
  one-server: SERVER-001
  prod: false
  dbserver: SQL-001" >> config/dbconfig.yaml
```

#### Сервисный режим уже активен

**Симптомы**: "Service mode already enabled"

**Диагностика**:
```bash
# Проверьте статус сервисного режима
apk-ci service-mode-status --infobase MyInfobase
```

**Решение**:
```bash
# Отключите сервисный режим сначала
apk-ci service-mode-disable --infobase MyInfobase

# Затем включите снова если необходимо
apk-ci service-mode-enable --infobase MyInfobase
```

### Команды восстановления базы данных

#### Таймаут операции восстановления

**Симптомы**: "operation timeout", "context deadline exceeded"

**Диагностика**:
```bash
# Проверьте текущий таймаут
grep -A5 "dbrestore:" config/app.yaml

# Проверьте размер резервной копии
```

**Решение**:
```bash
# Увеличьте таймаут в конфигурации
dbrestore:
  timeout: "7200s"  # 2 часа
  autotimeout: true

# Или через переменную окружения
export DBRESTORE_TIMEOUT="7200"
```

#### Недостаточно места на диске

**Симптомы**: "no space left on device", "disk full"

**Диагностика**:
```bash
# Проверьте свободное место
df -h

# Проверьте использование временной директории
du -sh /tmp/apk-ci/
```

**Решение**:
```bash
# Очистите временные файлы
rm -rf /tmp/apk-ci/*

# Измените временную директорию
export BR_TMP_DIR="/var/tmp"

# Или в app.yaml:
tmpDir: "/var/tmp"
```

## Проблемы производительности

### Медленное выполнение команд

**Симптомы**: Команды выполняются дольше ожидаемого

**Диагностика**:
```bash
# Включите профилирование
export BR_PROFILE="true"

# Проверьте нагрузку на систему
top
iostat -x 1

# Проверьте сетевую задержку
ping <target-server>
```

**Решение**:
```bash
# Увеличьте количество повторов для нестабильных соединений
rac:
  retries: 5
  timeout: 60

# Оптимизируйте размер временной директории
tmpDir: "/fast-storage/tmp"
```

### Проблемы памяти

**Симптомы**: "out of memory", "killed"

**Диагностика**:
```bash
# Проверьте использование памяти
free -h
cat /proc/meminfo

# Проверьте логи системы
dmesg | grep -i "killed process"
```

**Решение**:
```bash
# Увеличьте swap если необходимо
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# Оптимизируйте конфигурацию
export GOGC=100  # Более агрессивная сборка мусора
```

## Проблемы безопасности

### Утечка паролей в логах

**Симптомы**: Пароли видны в выводе команд

**Диагностика**:
```bash
# Проверьте уровень логирования
echo $BR_LOG_LEVEL

# Проверьте файлы логов
grep -i password /var/log/apk-ci.log
```

**Решение**:
```bash
# Снизьте уровень логирования в продакшене
export BR_LOG_LEVEL="info"

# Убедитесь, что secret.yaml защищен
chmod 600 config/secret.yaml
chown root:root config/secret.yaml

# Используйте переменные окружения для паролей
unset HISTFILE  # Отключить историю команд
```

### Проблемы с токенами доступа

**Симптомы**: 401 Unauthorized, "invalid token"

**Диагностика**:
```bash
# НЕ выводите токен в продакшене!
# Проверьте в тестовой среде:
echo ${ACCESS_TOKEN:0:10}...  # Покажите только первые 10 символов

# Проверьте срок действия токена через API
curl -s -H "Authorization: token $ACCESS_TOKEN" \
  $GITEA_URL/api/v1/user | jq .
```

**Решение**:
```bash
# Создайте новый токен в Gitea UI
# Убедитесь в правильных правах доступа (repo, user)

# Обновите конфигурацию
export ACCESS_TOKEN="new_token_here"
```

## Инструменты отладки

### Запуск в режиме dry-run

```bash
# Имитация выполнения без реальных изменений (если поддерживается)
apk-ci --dry-run service-mode-enable --infobase MyInfobase
```

### Вывод конфигурации

```bash
# Показать загруженную конфигурацию
apk-ci --dump-config

# Показать только определенную секцию
apk-ci --dump-config --section=app
```

### Трассировка выполнения

```bash
# Включить трассировку системных вызовов (Linux)
strace -e trace=network,file apk-ci service-mode-enable --infobase MyInfobase

# Профилирование производительности
time apk-ci service-mode-enable --infobase MyInfobase
```

## Получение помощи

### Создание отчета об ошибке

При создании отчета об ошибке включите:

1. **Версию apk-ci**: `apk-ci --version`
2. **Операционную систему**: `uname -a`
3. **Версию Go**: `go version`
4. **Команду, которая вызвала ошибку**
5. **Полный вывод с уровнем debug**
6. **Конфигурацию (БЕЗ паролей и токенов)**

### Шаблон отчета

```
## Описание проблемы
[Опишите что произошло]

## Ожидаемое поведение
[Опишите что должно было произойти]

## Шаги для воспроизведения
1. [Первый шаг]
2. [Второй шаг]
3. [Ошибка]

## Среда
- apk-ci версия: [версия]
- ОС: [операционная система]
- Go версия: [версия Go]

## Логи
```
[Вставьте логи с debug уровнем, удалив пароли/токены]
```

## Дополнительный контекст
[Любая дополнительная информация]
```

### Сбор диагностической информации

```bash
#!/bin/bash
# Скрипт для сбора диагностической информации

echo "=== Системная информация ==="
uname -a
echo

echo "=== Версии ==="
apk-ci --version
go version
echo

echo "=== Переменные окружения ==="
env | grep "^BR_\|^SERVICE_\|^DBRESTORE_" | sed 's/=.*PASSWORD.*/=***HIDDEN***/'
echo

echo "=== Конфигурационные файлы ==="
find config/ -name "*.yaml" -exec echo "--- {} ---" \; -exec cat {} \; | \
  sed 's/password:.*/password: ***HIDDEN***/' | \
  sed 's/accessToken:.*/accessToken: ***HIDDEN***/'
echo

echo "=== Сетевая доступность ==="
ping -c 1 <your-server> || echo "Сервер недоступен"
```