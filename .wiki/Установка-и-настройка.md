# Установка и настройка

## Предварительные требования

### Системные требования

- **Go 1.25+** - язык программирования
- **Make** - инструмент автоматизации сборки
- **Git** - система контроля версий
- **1C:Enterprise платформа** - для интеграции с 1C системами

### Необходимые инструменты

- Go 1.25+
- Make
- Git
- Task (опционально, для использования Taskfile.yml)
- golangci-lint (для линтинга кода)

## Подготовка окружения

### Скрипт конфигурации системы

Скрипт `0-env-config.sh` настраивает основную конфигурацию Git для среды разработки:

```bash
#!/bin/bash

# Конфигурация git
git config --global user.name "XoR"
git config --global user.email xor@benadis.ru
git config pull.rebase false
git config --global credential.helper cache
git config --global credential.helper 'cache --timeout=2880'
```

### Установка инструментов разработки

Используйте предоставленные скрипты для установки необходимых инструментов:

```bash
# Для установки в системе (требуются права sudo)
./scripts/install-dev-tools.sh

# Для пользовательской установки (без sudo)
./scripts/install-dev-tools-no-sudo.sh

# Установка golangci-lint v2
./scripts/inst-golangci-lint-v2.sh
```

### Настройка среды 1C

Выполните скрипты для настройки компонентов 1C:

```bash
./scripts/1-ibcmd.sh    # Настройка ibcmd
./scripts/2-1cv8.sh     # Настройка 1cv8
./scripts/3-1cedtcli.sh # Настройка EDT CLI
```

## Управление версиями

### Скрипт управления версиями

Скрипт создает два файла:
- `version.go`: Go исходный файл с константами информации о версии
- `version.md`: Markdown файл с подробными метаданными версии

При выполнении как части процесса сборки (через Makefile или Taskfile) захватывает:
- Git тег или хеш коммита
- Время сборки
- Короткий хеш Git коммита
- Состояние dirty (если рабочая директория имеет незафиксированные изменения)

Информация о версии встраивается в бинарный файл во время компиляции с использованием ldflags, делая её доступной во время выполнения для диагностики и логирования.

Использование в Taskfile.yml:

```yaml
generate-version:
  desc: "Генерация файла version.go с автоматическими константами версии"
  cmds:
    - |
      echo "Генерация файла version.go..."
      ./scripts/generate-version.sh {{.BUILD_DIR}}
```

## Режимы выполнения

### Прямое выполнение бинарного файла

После сборки приложение может выполняться напрямую:

```bash
./build/apk-ci service-mode-enable --infobase MyInfobase
./build/apk-ci dbrestore --config config.yaml
./build/apk-ci convert --config convert-config.json
```

Приложение поддерживает множественные команды, соответствующие его модулям:
- `service-mode-enable`: Включение сервисного режима для информационной базы
- `service-mode-disable`: Отключение сервисного режима для информационной базы
- `service-mode-status`: Проверка статуса сервисного режима
- `dbrestore`: Восстановление базы данных
- `convert`: Конвертация данных
- И другие...

### Загрузка конфигурации

Приложение следует иерархическому подходу к конфигурации:

1. **Переменные окружения** (высший приоритет)
2. **Файлы конфигурации** (JSON/YAML)
3. **Значения по умолчанию** (низший приоритет)

Каждый модуль использует специфический префикс для переменных окружения:
- Convert: `CONVERT_`
- DBRestore: `DBRESTORE_`
- ServiceMode: `SERVICE_MODE_`
- EDT: `EDT_`

Пример файла конфигурации:

```bash
cp examples/all-modules-config.env .env
# Отредактируйте .env файл с настройками вашего окружения
```

## Интеграция с CI/CD

### Интеграция с GitHub Actions

Файл `action.yaml` определяет рабочий процесс GitHub Actions:

```yaml
# Содержимое action.yaml определяет
# рабочий процесс GitHub Actions для apk-ci
# Интегрируется с экземпляром Gitea для операций с репозиторием
```

Конвейер CI/CD включает:
- Автоматическую проверку конфликтов слияния
- Валидацию pull request'ов
- Автоматизированное тестирование
- Генерацию артефактов

Ключевые особенности:
- Запускается на debian-latest с контейнером golang:1.21
- Проверяет конфликты слияния в pull request'ах
- Автоматически закрывает PR с конфликтами
- Интегрируется с Gitea API для операций с репозиторием

### Настройка окружения CI/CD

Для окружений CI/CD используйте следующую настройку:

```bash
# Установка зависимостей
./scripts/install-dev-tools.sh

# Сборка приложения
make all

# Запуск тестов
make test-coverage

# Генерация артефактов
make build-all
```

## Устранение неполадок

### Распространенные проблемы и решения

#### Отсутствующие бинарные файлы 1cv8

```bash
# Проверьте, что 1cv8 находится в PATH
which 1cv8
# Ожидаемый вывод: /usr/bin/1cv8 или подобное

# Если не найден, добавьте в PATH
export PATH=$PATH:/opt/1C/v8.3/x86_64
```

#### Неправильная конфигурация PATH

```bash
# Проверьте текущий PATH
echo $PATH

# Убедитесь, что Go и инструменты доступны
go version
task --version
golangci-lint --version

# Добавьте недостающие пути
export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin:/usr/local/bin
```

#### Проблемы с разрешениями

```bash
# Для системной установки
sudo ./scripts/install-dev-tools.sh

# Для пользовательской установки, измените скрипт для установки в домашнюю директорию
```

#### Проблемы подключения к Gitea

```bash
# Проверьте сетевое подключение
ping regdv.apkholding.ru

# Проверьте URL Gitea и токен доступа
echo $GITEA_URL
echo $ACCESS_TOKEN

# Тестируйте доступ к API
curl -H "Authorization: token $ACCESS_TOKEN" $GITEA_URL/api/v1/user
```

#### Проблемы подключения к базе данных

```bash
# Проверьте доступность сервера 1C
telnet <1C-server> 1541

# Проверьте имя базы данных и учетные данные
# Убедитесь, что переменная окружения DB_NAME установлена правильно
```

### Советы по отладке

1. **Включите подробное логирование**:
   ```bash
   export LOG_LEVEL=Debug
   ```

2. **Используйте отладочную сборку**:
   ```bash
   task build-debug
   task debug
   ```

3. **Проверьте загрузку конфигурации**:
   ```bash
   # Убедитесь, что переменные окружения загружены
   env | grep BR_
   env | grep SERVICE_
   ```

4. **Проверьте файлы конфигурации**:
   ```bash
   # Убедитесь, что файлы конфигурации существуют и доступны
   ls -la config/
   cat config/app.yaml
   ```

5. **Используйте режим dry-run** (если поддерживается):
   ```bash
   ./build/apk-ci --dry-run service-mode-enable --infobase MyInfobase
   ```