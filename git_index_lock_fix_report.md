# Отчет об исправлении ошибки Git index.lock

## Проблема
В логе `/root/r/apk-ci/promts/err-debug-01.md` была обнаружена критическая ошибка:
```
fatal: Не удалось создать «/tmp/4del/s2032845846/.git/index.lock»: Файл существует.
```

Эта ошибка возникает, когда:
- Другой процесс Git уже выполняется в том же репозитории
- Предыдущий процесс Git завершился аварийно, оставив файл блокировки

## Внесенные изменения

### 1. Добавлена функция `removeGitIndexLock`
- Проверяет наличие файла `.git/index.lock`
- Удаляет его, если он существует
- Добавлены подробные дебаг и информационные сообщения

### 2. Добавлена функция `executeGitCommandWithRetry`
- Выполняет Git команды с повторными попытками (до 3 раз)
- Автоматически обнаруживает ошибки связанные с `index.lock`
- При обнаружении ошибки удаляет файл блокировки и повторяет команду
- Добавлена задержка 500мс между попытками

### 3. Обновлена функция `SwitchOrCreateBranch`
- Добавлен вызов `removeGitIndexLock` перед выполнением Git операций
- Использует `executeGitCommandWithRetry` для операций checkout
- Добавлены подробные дебаг сообщения

### 4. Обновлена функция `Switch`
- Теперь возвращает ошибку вместо только логирования
- Добавлены дебаг и информационные сообщения

### 5. Обновлены все вызовы `Switch`
- В `app.go`: добавлена обработка ошибок для всех 4 вызовов
- В `edt.go`: добавлена обработка ошибки
- В `git_test.go`: обновлен тест для проверки возвращаемой ошибки

## Результат
- Код успешно компилируется без ошибок
- Все тесты проходят успешно
- Добавлена автоматическая обработка ошибок блокировки Git index
- Улучшена диагностика с подробными дебаг сообщениями

## Тестирование
Выполнены команды:
- `go build ./...` - успешно
- `go test ./internal/git/... -v` - все тесты прошли

Теперь система автоматически обрабатывает ошибки блокировки Git index и продолжает работу после их устранения.