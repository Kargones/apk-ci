# CLAUDE.md

Этот файл содержит руководство для Claude Code (claude.ai/code) при работе с кодом в этом репозитории.

## Важное требование!

Используй русский язык для:
- Всех комментариев в коде
- Всех сообщений в интерфейсе Claude Code
- Всех выводов в терминале

## Обзор проекта

`apk-ci` — это инструмент автоматизации для систем 1C:Enterprise, написанный на Go. Он оркестрирует сложные рабочие процессы, включая конвертацию данных, операции с базами данных, управление конфигурациями и интеграцию с внешними системами, такими как EDT, SonarQube и Gitea.

## Обзор архитектуры

### Поток обработки запроса
1. **Точка входа** (`cmd/apk-ci/main.go`): Получает команду через переменную окружения `BR_COMMAND`
2. **Загрузка конфигурации** (`internal/config/`): Загружает многоуровневую конфигурацию из Gitea API и переменных окружения
3. **Слой приложения** (`internal/app/`): Оркестрирует бизнес-логику и координирует работу между сервисами
4. **Доменные сущности** (`internal/entity/`): Содержит доменную логику для операций 1C, управления базами данных и внешних интеграций
5. **Слой сервисов** (`internal/service/`): Предоставляет переиспользуемые реализации сервисов

### Архитектура конфигурации

Система конфигурации использует иерархический подход с несколькими источниками:

1. **Основные источники** (в порядке приоритета):
   - Переменные окружения (наивысший приоритет, с префиксами: `BR_*`, `DBRESTORE_*`, `SERVICE_MODE_*` и т.д.)
   - Удалённые конфигурационные файлы из репозитория Gitea
   - Значения по умолчанию (наименьший приоритет)

2. **Структура конфигурации**:
   - `AppConfig`: Системные настройки (пути, таймауты, расположение инструментов)
   - `ProjectConfig`: Настройки проекта (маппинг баз данных, расширения)
   - `SecretConfig`: Конфиденциальные данные (пароли, токены)
   - `DatabaseInfo`: Конфигурация для каждой базы данных (серверы, флаги продуктивности)

3. **Ключевая особенность**: Конфигурация загружается через Gitea API во время выполнения, что поддерживает динамические обновления без передеплоя

### Организация доменных сущностей

`internal/entity/one/` содержит сущности, специфичные для 1C:Enterprise:
- **convert**: Логика конвертации форматов данных
- **designer**: Операции 1C Designer (создание баз данных, выгрузка конфигураций)
- **edt**: Интеграция с 1C EDT (Enterprise Development Tools)
- **enterprise**: Операции в режиме 1C Enterprise (выполнение EPF)
- **store**: Управление хранилищем конфигурации

### Точки интеграции с 1C

Приложение взаимодействует с платформой 1C:Enterprise через:
- **1cv8**: Основной исполняемый файл платформы для операций с базами данных
- **ibcmd**: Интерфейс командной строки для информационных баз
- **rac** (Консоль администрирования): Управление кластером и сервисным режимом
- **1cedtcli (1C EDT CLI)**: Автоматизация EDT для процессов разработки

## Команды для разработки

### Сборка
```bash
# Стандартная сборка
make build

# Сборка для всех платформ
make build-all

# Сборка для конкретных платформ
make build-linux
make build-windows
make build-darwin
```

### Тестирование
```bash
# Запуск всех тестов
make test
go test ./...

# Запуск тестов с покрытием
make test-coverage

# Запуск интеграционных тестов (требуется настройка окружения)
make test-integration

# Запуск тестов SMB модуля
make test-smb

# Запуск отдельной тестовой функции
go test -v ./internal/config -run TestMustLoad
```

### Качество кода
```bash
# Запуск линтера (использует golangci-lint настроенный в .golangci.yml)
make lint

# Запуск линтера исключая тестовые файлы
make lint-no-test

# Форматирование кода
make fmt

# Запуск go vet
make vet

# Запуск всех проверок (fmt, vet, lint, test)
make check
```

### Настройка окружения разработки
```bash
# Установка зависимостей для разработки (golangci-lint, godoc)
make setup-dev

# Установка и проверка зависимостей
make deps
```

### Запуск приложения
```bash
# Прямое выполнение с конкретной командой
BR_COMMAND=service-mode-status BR_INFOBASE_NAME=MyInfobase ./apk-ci

# Приложение разработано для запуска в CI/CD как Gitea Actions, а не локально
# Большинство команд требуют удалённую конфигурацию из Gitea API
```

## Доступные команды

Команды выполняются через переменную окружения `BR_COMMAND` (определены в `internal/constants/constants.go`):

### Управление сервисным режимом
- `service-mode-enable` - Включить сервисный режим для информационной базы (блокирует доступ пользователей)
- `service-mode-disable` - Отключить сервисный режим (восстанавливает обычный доступ)
- `service-mode-status` - Проверить текущий статус сервисного режима

### Операции с базами данных
- `dbrestore` - Восстановить базу данных MSSQL из резервной копии с автоматическим расчётом таймаута
- `dbupdate` - Обновить структуру базы данных в соответствии с конфигурацией (выполняется дважды для расширений)
- `create-temp-db` - Создать временную локальную базу данных с указанными расширениями

### Синхронизация конфигурации
- `store2db` - Загрузить конфигурацию из хранилища 1C в базу данных
- `storebind` - Привязать хранилище конфигурации к базе данных
- `git2store` - Синхронизировать формат EDT из Git в хранилище 1C (полный рабочий процесс)
- `create-stores` - Инициализировать хранилища конфигурации для проекта и расширений

### Интеграция с SonarQube
- `sq-scan-branch` - Сканировать коммиты ветки (фильтрация по шаблону ветки и изменениям файлов)
- `sq-scan-pr` - Сканировать pull request с помощью SonarQube
- `sq-project-update` - Обновить метаданные проекта SonarQube
- `sq-report-branch` - Сгенерировать отчёт о качестве для ветки

### Прочие операции
- `convert` - Конвертировать между форматами EDT и XML с использованием 1C Designer
- `execute-epf` - Выполнить внешнюю обработку (.epf) в 1C Enterprise
- `action-menu-build` - Построить динамическое меню действий из конфигурации
- `test-merge` - Проверить конфликты слияния для всех открытых pull request

## Важные детали реализации

### Загрузка конфигурации
- Конфигурация загружается из репозитория Gitea во время выполнения через API
- Загружаются несколько YAML файлов: `app.yaml`, `project.yaml`, `secret.yaml`, `dbconfig.yaml`
- `Config.AnalyzeProject()` сканирует репозиторий для определения структуры проекта и расширений
- Маппинг серверов баз данных использует связи `related` в `ProjectConfig`

### Операции в сервисном режиме
- Использует RAC (Консоль администрирования) для управления кластерами 1C
- Требует правильной конфигурации RAC в `app.yaml` и учётных данных в `secret.yaml`
- Клиент сервисного режима находится в `internal/servicemode/`

### Логика восстановления базы данных
- Автоматически определяет исходные/целевые серверы используя `DetermineSrcAndDstServers()`
- Продуктивные базы данных восстанавливаются ИЗ продуктивных серверов В тестовые серверы
- Таймаут может быть автоматически рассчитан на основе размера резервной копии если `autotimeout: true`

### Рабочий процесс Git2Store
- Клонирует репозиторий → переключается на ветку EDT → загружает конфигурацию EDT
- Переключается на ветку XML → инициализирует базу данных → загружает конфигурацию
- Отвязывает хранилище → обновляет БД → выгружает БД → привязывает хранилище
- Блокирует объекты → выполняет слияние → обновляет БД (для расширений) → фиксирует в хранилище

### Сканирование веток SonarQube
- Фильтрует ветки: "main" или "t######" (6-7 цифр)
- Проверяет изменения в коммитах для каталогов конфигурации перед сканированием
- Получает список несканированных коммитов из SonarQube API для избежания дублирования сканирований

### Стратегия тестирования
- Табличные тесты для бизнес-логики
- Интеграционные тесты для внешних зависимостей (платформа 1C, MSSQL, RAC)
- Тесты SMB требуют системных зависимостей (`make check-smb-deps`)
- Использование sqlmock для тестов базы данных

## Ключевые файлы для понимания

- `cmd/apk-ci/main.go` - Маршрутизатор команд (switch-выражение для всех команд)
- `internal/config/config.go` - Логика загрузки и валидации конфигурации
- `internal/constants/constants.go` - Все имена команд и константные значения
- `internal/app/app.go` - Высокоуровневые функции оркестрации для каждой команды
- `internal/entity/one/convert/convert.go` - Основной рабочий процесс конвертации 1C
- `internal/servicemode/servicemode.go` - Реализация управления сервисным режимом