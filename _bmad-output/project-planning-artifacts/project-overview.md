# Обзор проекта apk-ci

**Последнее обновление:** 2025-11-24 (Exhaustive Rescan)

## Общая информация

| Параметр | Значение |
|----------|----------|
| **Название** | apk-ci |
| **Тип** | CLI инструмент автоматизации |
| **Язык** | Go 1.25.1 |
| **Репозиторий** | Монолит |
| **Лицензия** | Проприетарная |

## Назначение

`apk-ci` — инструмент автоматизации для систем 1C:Enterprise, предназначенный для:

- Оркестрации CI/CD процессов для 1C проектов
- Управления сервисным режимом информационных баз
- Операций с базами данных MSSQL
- Синхронизации конфигураций между Git и хранилищами 1C
- Интеграции с SonarQube для анализа качества кода
- Автоматизации DevOps задач через Gitea Actions

## Технологический стек

| Категория | Технология | Версия | Назначение |
|-----------|------------|--------|------------|
| Язык | Go | 1.25.1 | Основной язык |
| База данных | MSSQL | - | go-mssqldb |
| Конфигурация | cleanenv | 1.5.0 | Env/YAML конфиги |
| Тестирование | testify | 1.11.1 | Assertions/mocks |
| Тестирование | sqlmock | 1.5.2 | Мокирование БД |
| Кодировка | golang.org/x/text | 0.29.0 | Windows-1251 |
| Сериализация | yaml.v3 | 3.0.1 | YAML парсинг |
| Сборка | Make | - | Автоматизация |
| Линтинг | golangci-lint | v2 | 20+ линтеров |

## Архитектурный паттерн

- **Standard Go Layout**: `cmd/`, `internal/`, `vendor/`
- **Command Pattern**: маршрутизация через `BR_COMMAND`
- **Clean Architecture**: слои app → service → entity
- **Repository Pattern**: сервисный слой для внешних интеграций

## Поддерживаемые команды (17)

### Управление сервисным режимом
- `service-mode-enable` - Включить сервисный режим
- `service-mode-disable` - Отключить сервисный режим
- `service-mode-status` - Проверить статус

### Операции с базами данных
- `dbrestore` - Восстановить MSSQL из бэкапа
- `dbupdate` - Обновить структуру БД
- `create-temp-db` - Создать временную БД

### Синхронизация конфигурации
- `store2db` - Загрузить из хранилища в БД
- `storebind` - Привязать хранилище к БД
- `git2store` - Синхронизация Git → хранилище
- `create-stores` - Создать хранилища

### SonarQube интеграция
- `sq-scan-branch` - Сканировать ветку
- `sq-scan-pr` - Сканировать PR
- `sq-project-update` - Обновить метаданные проекта
- `sq-report-branch` - Отчёт по ветке

### Прочие операции
- `convert` - Конвертация EDT ↔ XML
- `execute-epf` - Выполнить внешнюю обработку
- `action-menu-build` - Построить меню действий
- `test-merge` - Проверить конфликты слияния

## Интеграции

### 1C:Enterprise
- **1cv8** - операции с базами данных
- **ibcmd** - CLI для информационных баз
- **rac** - консоль администрирования кластера
- **1cedtcli (EDT CLI)** - автоматизация EDT

### Внешние системы
- **Gitea API** - управление репозиториями, PR, issues
- **SonarQube API** - анализ качества кода
- **MSSQL** - операции с базами данных

## Конфигурация

Иерархическая система с приоритетами:
1. **Переменные окружения** (наивысший) - `BR_*`, `DBRESTORE_*`, `SERVICE_MODE_*`
2. **Удалённые файлы** - из Gitea API (app.yaml, project.yaml, secret.yaml, dbconfig.yaml)
3. **Значения по умолчанию** (наименьший)

## Ключевые файлы

- `cmd/apk-ci/main.go` - точка входа, маршрутизатор команд
- `internal/config/config.go` - загрузка конфигурации
- `internal/constants/constants.go` - все константы
- `internal/app/app.go` - функции оркестрации
- `internal/entity/one/convert/convert.go` - workflow конвертации

## Документация

- **Wiki (RU)**: `.wiki/`
- **Wiki (EN)**: `.qoder/repowiki/en/`
- **Архитектура**: `docs/architecture/`
- **Руководства**: `docs/guides/`
