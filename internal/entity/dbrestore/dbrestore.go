// Package dbrestore –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö MS SQL Server
// –∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞—Å—á–µ—Ç–æ–º —Ç–∞–π–º–∞—É—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
//
// –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
// - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MS SQL Server
// - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤
// - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
// - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
// - –ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ YAML —Ñ–∞–π–ª—ã
package dbrestore

import (
	"context"
	"database/sql"
	"fmt"
	"log/slog"
	"os"
	"time"

	"github.com/Kargones/apk-ci/internal/config"

	// blank import for sql server driver
	_ "github.com/denisenkom/go-mssqldb"
	"gopkg.in/yaml.v3"
)

const (
	// DefaultPort - –ø–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MS SQL Server –æ—Ç–≤–µ—á–∞—é—â–µ–º—É –∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
	DefaultPort = 1433
	// DefaultServer - —Å–µ—Ä–≤–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MS SQL Server.
	DefaultServer = "MSK-SQL-SVC-01"
)

// DBRestore –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö MS SQL Server.
// –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.
type DBRestore struct {
	// Db - –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
	Db *sql.DB

	// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
	Server   string `yaml:"server"`   // –ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ MS SQL
	User     string `yaml:"user"`     // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
	Password string `yaml:"password"` // –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	Port     int    `yaml:"port"`     // –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1433)
	Database string `yaml:"database"` // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ master)

	// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
	Timeout         time.Duration `yaml:"timeout"`        // –¢–∞–π–º–∞—É—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
	TimeToRestore   string        `yaml:"time2restore"`   // –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ RFC3339
	TimeToStatistic string        `yaml:"time2statistic"` // –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –¥–ª—è —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
	AutoTimeOut     bool          `yaml:"autotimeout"`    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Ç–∞–π–º–∞—É—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
	Description     string        `yaml:"description"`    // –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

	// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
	SrcServer string `yaml:"srcServer"` // –°–µ—Ä–≤–µ—Ä-–∏—Å—Ç–æ—á–Ω–∏–∫
	SrcDB     string `yaml:"srcDB"`     // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö-–∏—Å—Ç–æ—á–Ω–∏–∫
	DstServer string `yaml:"dstServer"` // –°–µ—Ä–≤–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
	DstDB     string `yaml:"dstDB"`     // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
}

// RestoreStats —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö.
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤.
type RestoreStats struct {
	// AvgRestoreTimeSecond - —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
	AvgRestoreTimeSecond sql.NullInt64
	// MaxRestoreTimeSecond - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
	MaxRestoreTimeSecond sql.NullInt64
}

// New —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä DBRestore —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É DBRestore, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
// –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - *DBRestore: –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã DBRestore
func New() *DBRestore {
	return &DBRestore{}
}

// LoadDBRestoreConfig –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞.
// –ò—â–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç DBRestore —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - l: –ª–æ–≥–≥–µ—Ä –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
//   - cfg: –æ–±—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
//   - dbName: –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - *DBRestore: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
//   - error: –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–ª–∏ nil –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
func LoadDBRestoreConfig(l *slog.Logger, cfg *config.Config, dbName string) (*DBRestore, error) {
	// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
	dbCfg, err := config.LoadDBRestoreConfig(cfg, dbName)
	if err != nil {
		l.Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î",
			slog.String("dbName", dbName),
			slog.String("error", err.Error()),
		)
		return nil, err
	}

	// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä DBRestore —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
	dbR := &DBRestore{
		Server:      dbCfg.Server,
		User:        dbCfg.User,
		Password:    dbCfg.Password,
		Database:    dbCfg.Database,
		Timeout:     dbCfg.Timeout,
		AutoTimeOut: dbCfg.Autotimeout,
		SrcServer:   dbCfg.SrcServer,
		SrcDB:       dbCfg.SrcDB,
		DstServer:   dbCfg.DstServer,
		DstDB:       dbCfg.DstDB,
		Port:        1433, // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
	}

	// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
	setupDBRestoreDefaults(dbR)

	l.Debug("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞",
		slog.String("server", dbR.Server),
		slog.String("user", dbR.User),
		slog.String("database", dbR.Database),
		slog.Duration("timeout", dbR.Timeout),
	)

	return dbR, nil
}

// NewFromConfig —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä DBRestore –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.
// –ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç.
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - logger: –ª–æ–≥–≥–µ—Ä –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
//   - cfg: –æ–±—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø—É—Ç—è–º–∏ –∫ —Ñ–∞–π–ª–∞–º
//   - dbName: –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - *DBRestore: –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
//   - error: –æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞, –∏–ª–∏ nil –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
func NewFromConfig(logger *slog.Logger, cfg *config.Config, dbName string) (*DBRestore, error) {
	logger.Debug("–ù–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è DBRestore –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏", "dbName", dbName)

	if cfg == nil {
		logger.Debug("–û—à–∏–±–∫–∞: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–≤–Ω–∞ nil")
		return nil, fmt.Errorf("config –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å nil")
	}

	// –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–æ–Ω—É Europe/Moscow
	moscowTZ, err := time.LoadLocation("Europe/Moscow")
	if err != nil {
		logger.Warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–æ–Ω—É Europe/Moscow, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è UTC", "error", err)
		moscowTZ = time.UTC
	}

	// –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä DBRestore
	nowInMoscow := time.Now().In(moscowTZ)
	dbR := &DBRestore{
		Port:            DefaultPort, // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
		Server:          DefaultServer,
		TimeToRestore:   nowInMoscow.Format("2006-01-02T15:04:05"),
		TimeToStatistic: nowInMoscow.AddDate(0, 0, -120).Format("2006-01-02T15:04:05"),
		Description:     "gitops db restore task",
	}
	// –°–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ —Ç–æ—Ç –∂–µ, —á—Ç–æ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫)
	logger.Debug("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è", "server", DefaultServer)

	logger.Debug("–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä DBRestore —Å –ø–æ—Ä—Ç–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é", "port", dbR.Port)

	// –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ AppConfig
	if cfg.AppConfig != nil {
		logger.Debug("–û–±—Ä–∞–±–æ—Ç–∫–∞ AppConfig")

		// –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î
		if cfg.AppConfig.Dbrestore.Database != "" {
			dbR.Database = cfg.AppConfig.Dbrestore.Database
			logger.Debug("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ AppConfig", "database", dbR.Database)
		}
		dbR.AutoTimeOut = cfg.AppConfig.Dbrestore.Autotimeout
		logger.Debug("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω AutoTimeOut", "autoTimeout", dbR.AutoTimeOut)

		// –ü–∞—Ä—Å–∏–º —Ç–∞–π–º–∞—É—Ç –∏–∑ —Å—Ç—Ä–æ–∫–∏
		if cfg.AppConfig.Dbrestore.Timeout != "" {
			logger.Debug("–ü–∞—Ä—Å–∏–Ω–≥ —Ç–∞–π–º–∞—É—Ç–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏", "timeoutString", cfg.AppConfig.Dbrestore.Timeout)
			if timeout, err := time.ParseDuration(cfg.AppConfig.Dbrestore.Timeout); err == nil {
				dbR.Timeout = timeout
				logger.Debug("–¢–∞–π–º–∞—É—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω", "timeout", dbR.Timeout)
			} else {
				logger.Debug("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–∞–π–º–∞—É—Ç–∞", "error", err, "timeoutString", cfg.AppConfig.Dbrestore.Timeout)
			}
		}

		// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
		if cfg.AppConfig.Users.Mssql != "" {
			dbR.User = cfg.AppConfig.Users.Mssql
			logger.Debug("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å MSSQL", "user", dbR.User)
		}
	} else {
		logger.Debug("AppConfig –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
	}

	// –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–∞—Ä–æ–ª–∏ –∏–∑ SecretConfig
	if cfg.SecretConfig != nil && cfg.SecretConfig.Passwords.Mssql != "" {
		dbR.Password = cfg.SecretConfig.Passwords.Mssql
		logger.Debug("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä–æ–ª—å MSSQL –∏–∑ SecretConfig")
	} else {
		logger.Debug("SecretConfig –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø–∞—Ä–æ–ª—å MSSQL –Ω–µ –∑–∞–¥–∞–Ω")
	}
	prodDbName := FindProductionDatabase(cfg.ProjectConfig, dbName)
	// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ DbConfig
	if cfg.DbConfig != nil && dbName != "" || prodDbName != "" {
		logger.Debug("–û–±—Ä–∞–±–æ—Ç–∫–∞ DbConfig", "dbName", dbName, "dbConfigCount", len(cfg.DbConfig))
		if dbInfo, exists := cfg.DbConfig[prodDbName]; exists {
			logger.Debug("–ù–∞–π–¥–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤ DbConfig", "dbServer", dbInfo.DbServer)

			dbR.SrcServer = dbInfo.DbServer
			dbR.SrcDB = prodDbName
			logger.Debug("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–µ—Ä–≤–µ—Ä-–∏—Å—Ç–æ—á–Ω–∏–∫", "srcServer", dbR.SrcServer, "srcDB", dbR.SrcDB)

			if dbInfo, exists := cfg.DbConfig[dbName]; exists {
				logger.Debug("–ù–∞–π–¥–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤ DbConfig", "dbServer", dbInfo.DbServer)
				dbR.DstServer = dbInfo.DbServer
				dbR.DstDB = dbName
				logger.Debug("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–µ—Ä–≤–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è", "dstServer", dbR.DstServer, "dstDB", dbR.DstDB)
			} else {
				logger.Debug("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DbConfig", "dbName", dbName)
				return nil, fmt.Errorf("–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö %s –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DbConfig", dbName)
			}
		} else {
			logger.Debug("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DbConfig", "dbName", prodDbName)
			return nil, fmt.Errorf("–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö %s –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DbConfig", prodDbName)
		}
	} else {
		if cfg.DbConfig == nil {
			logger.Debug("DbConfig –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
		} else {
			logger.Debug("–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–æ–µ")
		}
	}

	// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∞–π–º–∞—É—Ç–∞
	if dbR.Timeout == 0 {
		dbR.Timeout = 30 * time.Second
		logger.Debug("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–∞–π–º–∞—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é", "timeout", dbR.Timeout)
	}

	logger.Debug("DBRestore —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω",
		"server", dbR.Server,
		"user", dbR.User,
		// ToDo: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å!
		"password", dbR.Password,
		"port", dbR.Port,
		"database", dbR.Database,
		"timeout", dbR.Timeout,
		"autoTimeout", dbR.AutoTimeOut,
		"srcServer", dbR.SrcServer,
		"srcDB", dbR.SrcDB,
		"dstServer", dbR.DstServer,
		"dstDB", dbR.DstDB)

	return dbR, nil
}

// setupDBRestoreDefaults —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è DBRestore
func setupDBRestoreDefaults(dbR *DBRestore) {
	if dbR.User == "" {
		dbR.User = "gitops"
	}
	if dbR.Server == "" {
		dbR.Server = "MSK-SQL-SVC-01"
	}
	if dbR.Port == 0 {
		dbR.Port = 1433
	}
	if dbR.Database == "" {
		dbR.Database = "master"
	}
	if dbR.Description == "" {
		dbR.Description = "gitops db restore task"
	}
	if dbR.TimeToRestore == "" {
		dbR.TimeToRestore = time.Now().Format("2006-01-02T15:04:05")
	}
	if dbR.TimeToStatistic == "" {
		dbR.TimeToStatistic = time.Now().AddDate(0, 0, -120).Format("2006-01-02T15:04:05")
	}
	if dbR.Timeout == 0 {
		dbR.AutoTimeOut = true
	}
	if dbR.Password == "" {
		// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è MSSQL_PASSWORD
		if mssqlPassword := os.Getenv("MSSQL_PASSWORD"); mssqlPassword != "" {
			dbR.Password = mssqlPassword
		} else {
			//ToDo: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ yaml (sops)
			dbR.Password = "8kX8h!NNIbEbdu8o0"
		}
	}
}

// Init - —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LoadDBRestoreConfig
func (dbR *DBRestore) Init(yamlFile []byte) error {
	var configData map[string]DBRestore
	err := yaml.Unmarshal(yamlFile, &configData) // Need to import "gopkg.in/yaml.v2"
	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ config.yaml: %w", err)
	}

	restoreConfig, ok := configData["tempdbrestore"]
	if !ok {
		return fmt.Errorf("–≤ config.yaml –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–¥–µ–ª 'tempdbrestore'")
	}
	*dbR = restoreConfig

	// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
	setupDBRestoreDefaults(dbR)
	return nil
}

// Connect —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å MS SQL Server.
// –°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã DBRestore
// –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ–≥–æ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å –ø–æ–º–æ—â—å—é ping.
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–æ–º –æ–ø–µ—Ä–∞—Ü–∏–∏
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏:
//   - –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
//   - Ping –∫ —Å–µ—Ä–≤–µ—Ä—É –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –Ω–µ—É–¥–∞—á–Ω–æ
//
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ Db –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.
// –í–∞–∂–Ω–æ: –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é dbR.Db.Close() –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
//
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
//
//	ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
//	defer cancel()
//	err := dbRestore.Connect(ctx)
//	if err != nil {
//		log.Fatal("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:", err)
//	}
//	defer dbRestore.Db.Close()
func (dbR *DBRestore) Connect(ctx context.Context) error {
	connString := fmt.Sprintf("server=%s;user id=%s;password=%s;port=%d;database=%s;encrypt=disable",
		dbR.Server, dbR.User, dbR.Password, dbR.Port, dbR.Database)

	db, err := sql.Open("sqlserver", connString)
	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: %w", err)
	}
	dbR.Db = db

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
	if err := dbR.Db.PingContext(ctx); err != nil {
		return fmt.Errorf("ping –æ—à–∏–±–∫–∞: %w", err)
	}

	return nil
}

// Restore –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö—Ä–∞–Ω–∏–º—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É sp_DBRestorePSFromHistoryD –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
// –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–æ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏:
//   - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
//   - –•—Ä–∞–Ω–∏–º–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤–µ—Ä–Ω—É–ª–∞ –æ—à–∏–±–∫—É
//   - –û–ø–µ—Ä–∞—Ü–∏—è –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É
//
// –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:
// 1. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ö—Ä–∞–Ω–∏–º–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ sp_DBRestorePSFromHistoryD
// 2. –ü–µ—Ä–µ–¥–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: –æ–ø–∏—Å–∞–Ω–∏–µ, –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–µ—Ä–≤–µ—Ä—ã –∏ –±–∞–∑—ã
// 3. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
//
// –í–∞–∂–Ω–æ: –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
//   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç —á–µ—Ä–µ–∑ Init()
//   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Connect()
//   - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ GetRestoreStats() –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–∞–π–º–∞—É—Ç–∞
//
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
//
//	ctx, cancel := context.WithTimeout(context.Background(), dbRestore.Timeout)
//	defer cancel()
//	err := dbRestore.Restore(ctx)
//	if err != nil {
//		log.Fatal("–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:", err)
//	}
func (dbR *DBRestore) Restore(ctx context.Context) error {
	if dbR.Db == nil {
		return fmt.Errorf("–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
	}

	slog.Info("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")
	slog.Info("üïí –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", "time", dbR.TimeToRestore)

	query := `
	USE master;
	EXEC sp_DBRestorePSFromHistoryD
		@Description = @p1,
		@DayToRestore = @p2,
		@DomainUser = @p3,
		@SrcServer = @p4,
		@SrcDB = @p5,
		@DstServer = @p6,
		@DstDB = @p7;
	`
	_, err := dbR.Db.ExecContext(ctx, query,
		dbR.Description,   // -> @p1
		dbR.TimeToRestore, // -> @p2
		dbR.User,          // -> @p3
		dbR.SrcServer,     // -> @p4
		dbR.SrcDB,         // -> @p5
		dbR.DstServer,     // -> @p6
		dbR.DstDB,         // -> @p7
	)

	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: %w", err)
	}

	slog.Info("‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ.",
		"srcDB", dbR.SrcDB, "dstDB", dbR.DstDB)
	return nil
}

// GetRestoreStats –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö.
// –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∂—É—Ä–Ω–∞–ª –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ
// –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–æ–º –æ–ø–µ—Ä–∞—Ü–∏–∏
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - *RestoreStats: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å —Å—Ä–µ–¥–Ω–∏–º –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
//   - error: –æ—à–∏–±–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
//
// –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
// 1. –í—ã–ø–æ–ª–Ω—è–µ—Ç SQL –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ [DBA].[dbo].[BackupRequestJournal]
// 2. –§–∏–ª—å—Ç—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏ –ø–æ –¥–∞—Ç–µ (–Ω–∞—á–∏–Ω–∞—è —Å TimeToStatistic), –∏—Å—Ç–æ—á–Ω–∏–∫—É –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é
// 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
// 4. –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º AutoTimeOut –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Timeout –Ω–∞ 110% –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
//
// –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—É—Å—Ç–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–µ–∑ –æ—à–∏–±–∫–∏.
//
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∞–π–º–∞—É—Ç:
// –ü—Ä–∏ AutoTimeOut = true, –ø–æ–ª–µ Timeout –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ –∑–Ω–∞—á–µ–Ω–∏–µ
// –Ω–∞ 10% –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
//
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
//
//	stats, err := dbRestore.GetRestoreStats(ctx)
//	if err != nil {
//		log.Fatal("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", err)
//	}
//	if stats.AvgRestoreTimeSecond.Valid {
//		fmt.Printf("–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: %d —Å–µ–∫—É–Ω–¥\n", stats.AvgRestoreTimeSecond.Int64)
//	}
//
// GetRestoreStats –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
// –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–≥–æ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
// –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (—Å TimeToStatistic –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞).
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–æ–º –∑–∞–ø—Ä–æ—Å–∞
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - *RestoreStats: —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
//   - error: –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ nil –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
func (dbR *DBRestore) GetRestoreStats(ctx context.Context) (*RestoreStats, error) {
	if dbR.Db == nil {
		return nil, fmt.Errorf("–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
	}

	query := `
	SELECT
		AVG(DATEDIFF(SECOND, RequestDate, CompliteTime)),
		MAX(DATEDIFF(SECOND, RequestDate, CompliteTime))
	FROM [DBA].[dbo].[BackupRequestJournal]
	WHERE CompliteTime IS NOT NULL
		AND RequestDate IS NOT NULL
		AND RequestDate >= @p1
		AND SrcDB = @p2
		AND DstServer = @p3;
	`
	stats := &RestoreStats{}

	err := dbR.Db.QueryRowContext(ctx, query, dbR.TimeToStatistic, dbR.SrcDB, dbR.DstServer).Scan(
		&stats.AvgRestoreTimeSecond,
		&stats.MaxRestoreTimeSecond,
	)
	if err != nil {
		if err == sql.ErrNoRows {
			// –≠—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∞–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
			return stats, nil
		}
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: %w", err)
	}

	if dbR.AutoTimeOut && stats.MaxRestoreTimeSecond.Valid {
		// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –≤ 10% –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
		dbR.Timeout = time.Duration(float64(time.Duration(stats.MaxRestoreTimeSecond.Int64)*time.Second) * 1.7)
		slog.Info("üïí –¢–∞–π–º–∞—É—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", "timeout", dbR.Timeout)
	}

	slog.Info("‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.", "srcDB", dbR.SrcDB, "dstServer", dbR.DstServer)
	return stats, nil
}

// Close –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
// –î–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤.
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.
// –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–æ –∏–ª–∏ –Ω–µ –±—ã–ª–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –º–µ—Ç–æ–¥ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–∫–∏.
//
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
//
//	defer func() {
//		if err := dbRestore.Close(); err != nil {
//			log.Printf("–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: %v", err)
//		}
//	}()
//
// Close –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
// –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MS SQL Server.
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–∑—ã–≤–∞—Ç—å —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤ defer –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ Connect().
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - error: –æ—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–ª–∏ nil –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
func (dbR *DBRestore) Close() error {
	if dbR.Db != nil {
		return dbR.Db.Close()
	}
	return nil
}

// FindProductionDatabase –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç ProjectConfig –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ dbname,
// –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫ –∫–∞–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —É–∫–∞–∑–∞–Ω–Ω–∞—è –±–∞–∑–∞,
// –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è —ç—Ç–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - projectConfig: —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É ProjectConfig —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø—Ä–æ–µ–∫—Ç–∞
//   - dbName: –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - string: –∏–º—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞, –∏–Ω–∞—á–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
//
// –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:
//  1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ dbName —Å–∞–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –±–∞–∑–æ–π
//  2. –ò—â–µ—Ç dbName —Å—Ä–µ–¥–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –±–∞–∑ (related) –∫–∞–∂–¥–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –±–∞–∑—ã
//  3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç store-db –∫–∞–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é —Å–≤—è–∑–∞–Ω–Ω—É—é –±–∞–∑—É
//
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
//
//	prodName := FindProductionDatabase(cfg.ProjectConfig, "V8_DEV_DSBEKETOV_APK_TOIR3_1")
//	if prodName != "" {
//		fmt.Printf("–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –±–∞–∑–∞: %s\n", prodName)
//	} else {
//		fmt.Println("–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –±–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
//	}
//
// FindProductionDatabase –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏–º–µ–Ω–∏.
// –ò—â–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å—Ä–µ–¥–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –±–∞–∑ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –Ω–∏–º–∏ –±–∞–∑
// –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –±–∞–∑—ã, –∫ –∫–æ—Ç–æ—Ä–æ–π
// –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —É–∫–∞–∑–∞–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - projectConfig: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –±–∞–∑
//   - dbName: –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - string: –∏–º—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
func FindProductionDatabase(projectConfig *config.ProjectConfig, dbName string) string {
	if projectConfig == nil || dbName == "" {
		return ""
	}

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—É—é –±–∞–∑—É
	for prodName, prodInfo := range projectConfig.Prod {
		// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ dbName —Å–∞–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –±–∞–∑–æ–π
		if prodName == dbName {
			return prodName
		}

		// 2. –ò—â–µ–º —Å—Ä–µ–¥–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –±–∞–∑ (related)
		if prodInfo.Related != nil {
			for relatedDbName := range prodInfo.Related {
				if relatedDbName == dbName {
					return prodName
				}
			}
		}
	}
	return ""
}
