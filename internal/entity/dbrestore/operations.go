package dbrestore

import (
	"context"
	"database/sql"
	"fmt"
	"log/slog"
	"time"

	// blank import for sql server driver
	_ "github.com/denisenkom/go-mssqldb"
)

// Connect —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å MS SQL Server.
// –°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã DBRestore
// –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ–≥–æ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å –ø–æ–º–æ—â—å—é ping.
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–æ–º –æ–ø–µ—Ä–∞—Ü–∏–∏
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏:
//   - –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
//   - Ping –∫ —Å–µ—Ä–≤–µ—Ä—É –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –Ω–µ—É–¥–∞—á–Ω–æ
//
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ Db –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.
// –í–∞–∂–Ω–æ: –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é dbR.Db.Close() –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
//
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
//
//	ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
//	defer cancel()
//	err := dbRestore.Connect(ctx)
//	if err != nil {
//		log.Fatal("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:", err)
//	}
//	defer dbRestore.Db.Close()
func (dbR *DBRestore) Connect(ctx context.Context) error {
	connString := fmt.Sprintf("server=%s;user id=%s;password=%s;port=%d;database=%s;encrypt=disable",
		dbR.Server, dbR.User, dbR.Password, dbR.Port, dbR.Database)

	db, err := sql.Open("sqlserver", connString)
	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: %w", err)
	}
	dbR.Db = db

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
	if err := dbR.Db.PingContext(ctx); err != nil {
		return fmt.Errorf("ping –æ—à–∏–±–∫–∞: %w", err)
	}

	return nil
}

// Restore –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö—Ä–∞–Ω–∏–º—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É sp_DBRestorePSFromHistoryD –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
// –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–æ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏:
//   - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
//   - –•—Ä–∞–Ω–∏–º–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤–µ—Ä–Ω—É–ª–∞ –æ—à–∏–±–∫—É
//   - –û–ø–µ—Ä–∞—Ü–∏—è –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É
//
// –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:
// 1. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ö—Ä–∞–Ω–∏–º–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ sp_DBRestorePSFromHistoryD
// 2. –ü–µ—Ä–µ–¥–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: –æ–ø–∏—Å–∞–Ω–∏–µ, –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–µ—Ä–≤–µ—Ä—ã –∏ –±–∞–∑—ã
// 3. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
//
// –í–∞–∂–Ω–æ: –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
//   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç —á–µ—Ä–µ–∑ Init()
//   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Connect()
//   - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ GetRestoreStats() –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–∞–π–º–∞—É—Ç–∞
//
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
//
//	ctx, cancel := context.WithTimeout(context.Background(), dbRestore.Timeout)
//	defer cancel()
//	err := dbRestore.Restore(ctx)
//	if err != nil {
//		log.Fatal("–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:", err)
//	}
func (dbR *DBRestore) Restore(ctx context.Context) error {
	if dbR.Db == nil {
		return fmt.Errorf("–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
	}

	slog.Info("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")
	slog.Info("üïí –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", "time", dbR.TimeToRestore)

	query := `
	USE master;
	EXEC sp_DBRestorePSFromHistoryD
		@Description = @p1,
		@DayToRestore = @p2,
		@DomainUser = @p3,
		@SrcServer = @p4,
		@SrcDB = @p5,
		@DstServer = @p6,
		@DstDB = @p7;
	`
	_, err := dbR.Db.ExecContext(ctx, query,
		dbR.Description,   // -> @p1
		dbR.TimeToRestore, // -> @p2
		dbR.User,          // -> @p3
		dbR.SrcServer,     // -> @p4
		dbR.SrcDB,         // -> @p5
		dbR.DstServer,     // -> @p6
		dbR.DstDB,         // -> @p7
	)

	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: %w", err)
	}

	slog.Info("‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ.",
		"srcDB", dbR.SrcDB, "dstDB", dbR.DstDB)
	return nil
}

// GetRestoreStats –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö.
// –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∂—É—Ä–Ω–∞–ª –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ
// –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–æ–º –æ–ø–µ—Ä–∞—Ü–∏–∏
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - *RestoreStats: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å —Å—Ä–µ–¥–Ω–∏–º –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
//   - error: –æ—à–∏–±–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
//
// –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
// 1. –í—ã–ø–æ–ª–Ω—è–µ—Ç SQL –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ [DBA].[dbo].[BackupRequestJournal]
// 2. –§–∏–ª—å—Ç—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏ –ø–æ –¥–∞—Ç–µ (–Ω–∞—á–∏–Ω–∞—è —Å TimeToStatistic), –∏—Å—Ç–æ—á–Ω–∏–∫—É –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é
// 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
// 4. –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º AutoTimeOut –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Timeout –Ω–∞ 110% –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
//
// –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—É—Å—Ç–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–µ–∑ –æ—à–∏–±–∫–∏.
//
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∞–π–º–∞—É—Ç:
// –ü—Ä–∏ AutoTimeOut = true, –ø–æ–ª–µ Timeout –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ –∑–Ω–∞—á–µ–Ω–∏–µ
// –Ω–∞ 10% –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
//
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
//
//	stats, err := dbRestore.GetRestoreStats(ctx)
//	if err != nil {
//		log.Fatal("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", err)
//	}
//	if stats.AvgRestoreTimeSecond.Valid {
//		fmt.Printf("–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: %d —Å–µ–∫—É–Ω–¥\n", stats.AvgRestoreTimeSecond.Int64)
//	}
//
// GetRestoreStats –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
// –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–≥–æ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
// –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (—Å TimeToStatistic –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞).
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - ctx: –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–æ–º –∑–∞–ø—Ä–æ—Å–∞
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - *RestoreStats: —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
//   - error: –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ nil –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
func (dbR *DBRestore) GetRestoreStats(ctx context.Context) (*RestoreStats, error) {
	if dbR.Db == nil {
		return nil, fmt.Errorf("–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
	}

	query := `
	SELECT
		AVG(DATEDIFF(SECOND, RequestDate, CompliteTime)),
		MAX(DATEDIFF(SECOND, RequestDate, CompliteTime))
	FROM [DBA].[dbo].[BackupRequestJournal]
	WHERE CompliteTime IS NOT NULL
		AND RequestDate IS NOT NULL
		AND RequestDate >= @p1
		AND SrcDB = @p2
		AND DstServer = @p3;
	`
	stats := &RestoreStats{}

	err := dbR.Db.QueryRowContext(ctx, query, dbR.TimeToStatistic, dbR.SrcDB, dbR.DstServer).Scan(
		&stats.AvgRestoreTimeSecond,
		&stats.MaxRestoreTimeSecond,
	)
	if err != nil {
		if err == sql.ErrNoRows {
			// –≠—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∞–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
			return stats, nil
		}
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: %w", err)
	}

	if dbR.AutoTimeOut && stats.MaxRestoreTimeSecond.Valid {
		// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –≤ 10% –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
		dbR.Timeout = time.Duration(float64(time.Duration(stats.MaxRestoreTimeSecond.Int64)*time.Second) * 1.7)
		slog.Info("üïí –¢–∞–π–º–∞—É—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", "timeout", dbR.Timeout)
	}

	slog.Info("‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.", "srcDB", dbR.SrcDB, "dstServer", dbR.DstServer)
	return stats, nil
}

// Close –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
// –î–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤.
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.
// –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–æ –∏–ª–∏ –Ω–µ –±—ã–ª–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –º–µ—Ç–æ–¥ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–∫–∏.
//
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
//
//	defer func() {
//		if err := dbRestore.Close(); err != nil {
//			log.Printf("–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: %v", err)
//		}
//	}()
//
// Close –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
// –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MS SQL Server.
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–∑—ã–≤–∞—Ç—å —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤ defer –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ Connect().
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   - error: –æ—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–ª–∏ nil –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
func (dbR *DBRestore) Close() error {
	if dbR.Db != nil {
		return dbR.Db.Close()
	}
	return nil
}
