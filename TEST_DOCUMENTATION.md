# Документация по тестам функции main

## Обзор

В соответствии с инструкциями из файла `promts/create-test-01.md` были созданы тесты для функции `main`, которые загружают параметры из YAML файла и устанавливают их как переменные окружения.

## Созданные файлы

### 1. main-test.yaml
Файл конфигурации для тестирования, содержащий:
- `test-enable: true` - флаг включения тестирования
- `env-vars` - словарь переменных окружения для установки

### 2. Тесты в main_test.go

#### TestMain_WithYamlConfig
Основной тест, который:
- Создает временные YAML файлы с тестовыми конфигурациями
- Тестирует два сценария:
  - `test-enable: true` - переменные устанавливаются
  - `test-enable: false` - переменные не устанавливаются
- Проверяет корректность установки переменных окружения
- Проверяет загрузку конфигурации через `config.MustLoad()`

#### loadYamlConfigAndSetEnv
Вспомогательная функция, которая:
- Читает YAML файл
- Парсит структуру с полями `test-enable` и `env-vars`
- Устанавливает переменные окружения только если `test-enable: true`

### 3. yaml_integration_test.go

#### TestMain_WithRealYamlFile
Интеграционный тест с реальным YAML файлом и запуском main(), который:
- Использует реальный файл `main-test.yaml`
- Устанавливает все переменные окружения из файла (включая BR_* переменные)
- Проверяет корректность установки переменных согласно содержимому `main-test.yaml`
- **РЕАЛЬНО ЗАПУСКАЕТ функцию `main()`** в отдельной горутине
- Использует таймаут 60 секунд для длительных операций
- Перехватывает панику, если она возникает в `main()`
- **ВАЖНО:** Этот тест может завершить весь тестовый процесс, если `main()` вызовет `os.Exit()`. Это нормальное поведение для отладочного теста

## Структура YAML файла

```yaml
# Флаг включения тестирования
test-enable: true

# Переменные окружения
env-vars:
  INPUT_ACTOR: "test-user"
  INPUT_COMMAND: "git2store"
  INPUT_LOGLEVEL: "debug"
  # ... другие переменные
```

## Логика условного выполнения

Тесты реализуют логику условного выполнения на основе флага `test-enable`:
- Если `test-enable: true` - переменные окружения устанавливаются
- Если `test-enable: false` - переменные окружения не устанавливаются

## Запуск тестов

```bash
# Запуск основного теста
go test -v -run TestMain_WithYamlConfig ./cmd/benadis-runner

# Запуск интеграционного теста
go test -v -run TestMain_WithRealYamlFile ./cmd/benadis-runner

# Запуск всех новых тестов
go test -v -run "TestMain_With.*Yaml" ./cmd/benadis-runner
```

## Использование для отладки

Тест `TestMain_WithRealYamlFile` специально создан для удобной отладки приложения:

1. **Настройте параметры в `main-test.yaml`** - измените переменные окружения под ваши нужды
2. **Запустите тест** - `go test -v -run "TestMain_WithRealYamlFile" ./cmd/benadis-runner`
3. **Наблюдайте за выполнением** - тест покажет все логи и действия приложения
4. **Анализируйте результат** - тест выведет информацию о выполнении или ошибках

**Преимущества для отладки:**
- Не нужно настраивать переменные окружения вручную
- Все параметры в одном YAML файле
- Реальное выполнение всей логики приложения
- Подробные логи выполнения
- Возможность быстро изменить параметры и перезапустить

## Особенности реализации

1. **Изоляция тестов**: Каждый тест сохраняет и восстанавливает переменные окружения
2. **Обработка ошибок**: Тесты корректно обрабатывают ошибки сетевых запросов в тестовой среде
3. **Гибкость**: Поддержка как встроенных YAML конфигураций, так и внешних файлов
4. **Совместимость**: Использование существующих вспомогательных функций из main_test.go

## Соответствие требованиям

✅ Тест устанавливает аргументы командной строки как переменные окружения  
✅ Тест загружает параметры из main-test.yaml  
✅ Тест выполняет функцию main только если test-enable в YAML файле равен true  
✅ Реализована логика условного запуска на основе test-enable