# Процесс разработки и публикации внешнего расширения 1С

Данный документ описывает процесс разработки, версионирования и автоматической дистрибуции внешних расширений для баз данных 1С.

## 1. Диаграмма активности (Activity Diagram)

Диаграмма демонстрирует поток работ от момента разработки функционала расширения до его применения в целевых проектах.

```mermaid
graph TD
    %% Участники и Начало
    Start((Начало)) --> DevAct[Разработка в EDT]
    
    subgraph "Разработка Расширения"
        DevAct -->|Ветка tXXXXXX| GitPush[Push в репозиторий]
        GitPush --> CreatePR[Создание PR в main]
        CreatePR --> MergeMain[Слияние в main]
        MergeMain --> CreateRelease["Создание релиза<br/>(Версия = Дата)"]
    end

    CreateRelease --> CI_Trigger{Запуск CI/CD}

    subgraph "CI/CD Процессы"
        CI_Trigger -->|Параллельно| ConvertXML[Конвертация в XML]
        ConvertXML --> PushStorage[Помещение в Хранилище]
        
        CI_Trigger -->|Параллельно| IdentifySubs[Определение подписчиков]
        IdentifySubs --> PushTargetRepo["Push в целевой репозиторий<br/>Ветка: Org_Repo_Dir"]
        PushTargetRepo --> CreateTargetPR["Создание PR в main<br/>целевого проекта"]
    end

    subgraph "Целевой Проект"
        CreateTargetPR --> RM_Review["Release Manager:<br/>Проверка PR"]
        RM_Review --> RM_Merge[Слияние в main]
        RM_Merge --> UpdateDevs["Разработчики обновляют<br/>свои ветки"]
        RM_Merge --> BuildProject[Сборка конфигурации]
    end
    
    subgraph "Альтернативная схема"
        BuildProject -.->|Исключение из сборки| ProjectFile[Файл проекта]
        ProjectFile -.->|Внешний источник| PushStorage
    end

    UpdateDevs --> End((Конец))
    BuildProject --> End
```

### Подробное описание диаграммы активности

1.  **Разработка**: Разработчик ведет работу в EDT, используя минимальную конфигурацию. Вся работа ведется в ветке `tXXXXXX` (номер задачи).
2.  **Слияние и Релиз**: После завершения разработки создается запрос на слияние (Merge Request) в ветку `main`. После слияния создается релиз, версия которого соответствует дате.
3.  **Автоматизация (CI/CD)**: Создание релиза триггерит два параллельных процесса:
    *   **Архивация**: Расширение конвертируется в XML и помещается в артефактное хранилище.
    *   **Дистрибуция**: Система определяет репозитории, подписанные на это расширение. В каждом целевом репозитории создается (или обновляется) специальная ветка вида `<Организация>_<Репозиторий>_<Каталог>`.
4.  **Интеграция**: В целевом репозитории автоматически создается запрос на слияние ветки расширения в `main`.
5.  **Принятие изменений**: Release Manager принимает запрос. После этого код расширения попадает в основную ветку целевого проекта.
6.  **Обновление**: Разработчики целевого проекта обновляют свои локальные ветки, получая актуальную версию расширения.

---

## 2. Диаграмма последовательности (Sequence Diagram)

Диаграмма отображает взаимодействие между участниками процесса (Разработчик, Git-системы, CI/CD, Release Manager) во времени.

```mermaid
sequenceDiagram
    autonumber
    actor DevExt as Разработчик (Ext)
    participant GitExt as Git (Расширение)
    participant CI as CI/CD Runner
    participant Storage as Хранилище
    participant GitTarget as Git (Целевой Проект)
    actor RM as Release Manager
    actor DevTarget as Разработчик (Target)

    Note over DevExt, GitExt: Разработка в ветке tXXXXXX

    DevExt->>GitExt: Push изменений
    DevExt->>GitExt: Создание PR в main
    GitExt-->>DevExt: Слияние PR (Merge)
    
    Note over GitExt: Создание тега релиза (дата)

    rect rgb(240, 248, 255)
        Note right of GitExt: Автоматический запуск процессов
        GitExt->>CI: Триггер Pipeline

        par Конвертация и Хранение
            CI->>CI: Конвертация расширения в XML
            CI->>Storage: Загрузка артефакта (версия XML)
        and Публикация в проекты
            Note right of CI: Формирование ветки:<br/>Org_Repo_Dir
            CI->>GitTarget: Push в ветку расширения
            CI->>GitTarget: Создание PR (Ветка расширения -> main)
        end
    end

    Note over RM, GitTarget: Работа с целевым проектом

    RM->>GitTarget: Проверка PR
    RM->>GitTarget: Принятие (Merge) PR в main
    
    par Обновление команды
        DevTarget->>GitTarget: Pull main (получение обновления)
    and Сборка проекта
        GitTarget->>CI: Сборка целевой конфигурации
        Note right of CI: Альтернатива: использование<br/>link из Хранилища (исключение из сборки)
    end
```

### Подробное описание диаграммы последовательности

1.  **Инициация**: Процесс начинается с действий **Разработчика расширения**, который отправляет код в репозиторий расширения и инициирует слияние в `main`.
2.  **Релиз**: Событие создания релиза в **Git (Расширение)** запускает **CI/CD Runner**.
3.  **Ветвление процессов**: CI/CD выполняет действия параллельно:
    *   Сохраняет сконвертированную версию в **Хранилище**.
    *   Взаимодействует с **Git (Целевой Проект)**, создавая там специальную ветку и Pull Request. Это ключевой момент "подписки" — расширение пушится напрямую в структуру папок целевого проекта.
4.  **Контроль**: **Release Manager** выступает в роли гейткипера для целевого проекта. Он должен явно принять изменения, пришедшие из репозитория расширения.
5.  **Завершение**: После слияния в целевом проекте, **Разработчики проекта** получают обновление через стандартный `git pull`, а система сборки может использовать обновленные файлы или ссылки на хранилище (в зависимости от выбранной стратегии в файле проекта).