# Анализ ошибки в интеграционном тесте TestMain_WithRealYamlFile

## Описание проблемы

При запуске интеграционного теста `TestMain_WithRealYamlFile` возникает ошибка при попытке сборки конфигурации из исходных файлов. Ошибка выглядит следующим образом:

```json
{"time":"2025-10-13T12:29:26.774475566+03:00","level":"ERROR","source":{"function":"github.com/Kargones/apk-ci/internal/util/runner.(*Runner).RunCommand","file":"runner.go","line":130},"msg":"Runner","App info":{"version":"5.9.26.4:ee0f57f-debug"},"Ошибка при запуске":"exit status 1","Исполняемый файл":"/opt/1cv8/x86_64/8.3.27.1606/1cv8","WorkDir":"/tmp/4del","Параметры":"[@ /tmp/4del/908588963.par /c  Загрузка из файлов основной конфигурации]","Ошибка при запуске":"\n﻿Файл не обнаружен '/tmp/4del/s1290398063/src/cfg'\r\n"}
```

## Анализ проблемы

### 1. Процесс выполнения теста

1. Тест клонирует репозиторий `test/TOIR3` из Gitea
2. Успешно переключается на ветку `main`
3. Создает временную базу данных 1С
4. Переключается на ветку `xml`
5. Пытается загрузить конфигурацию из файлов по пути `/tmp/4del/s1290398063/src/cfg`
6. Файл не найден, так как путь не существует

### 2. Структура репозитория

При анализе клонированного репозитория было обнаружено:

**Ветка `main`:**
- Структура: `/tmp/4del/s3803018079/TOIR3/src/`
- Содержит файлы конфигурации напрямую в каталоге `src`
- Нет каталога `cfg`

**Ветка `xml`:**
- Структура: `/tmp/4del/s3803018079/src/cfg/`
- Содержит каталог `cfg` с файлами конфигурации
- Это правильная структура для загрузки конфигурации

### 3. Обнаруженные проблемы

#### Проблема 1: Несоответствие ожидаемого сообщения об успешном создании базы

В коде [`designer.go`](internal/entity/one/designer/designer.go:450) проверяется наличие сообщения `"Создание информационной базы успешно завершено"` в выводе команды `ibcmd`, но фактическое сообщение является `"[INFO] Infobase created."`.

```go
if !strings.Contains(string(r.ConsoleOut), constants.SearchMsgBaseCreateOk) {
    logger.Error("Неопознанная ошибка создания временной базы данных",
        slog.String("output", string(r.ConsoleOut)))
    return odb, fmt.Errorf("неопознанная ошибка создания временной базы данных: %s", string(r.ConsoleOut))
}
```

#### Проблема 2: Неправильный путь к файлам конфигурации

Код пытается загрузить конфигурацию из пути `src/cfg` относительно корня репозитория, но в зависимости от ветки структура различается:

- Ветка `main`: файлы в `TOIR3/src/`
- Ветка `xml`: файлы в `src/cfg/`

## Предлагаемые решения

### Решение 1: Исправить проверку создания базы данных

Обновить константу [`SearchMsgBaseCreateOk`](internal/constants/constants.go:188) или добавить дополнительную проверку для английского сообщения:

```go
// В constants.go добавить:
const SearchMsgBaseCreateOkEn = "Infobase created"

// В designer.go изменить проверку:
if !strings.Contains(string(r.ConsoleOut), constants.SearchMsgBaseCreateOk) &&
   !strings.Contains(string(r.ConsoleOut), "Infobase created") {
    // обработка ошибки
}
```

### Решение 2: Исправить логику определения пути к файлам конфигурации

Изменить код в [`convert.go`](internal/entity/one/convert/convert.go:302) для корректного определения пути к файлам конфигурации в зависимости от ветки:

```go
// Определить путь к исходникам в зависимости от структуры проекта
sourcePath := path.Join(cfg.RepPath, cp.Source.RelPath)
if _, err := os.Stat(sourcePath); os.IsNotExist(err) {
    // Пробовать альтернативный путь для основной конфигурации в ветке main
    altPath := path.Join(cfg.RepPath, cfg.ProjectName, cp.Source.RelPath)
    if _, err := os.Stat(altPath); err == nil {
        sourcePath = altPath
    }
}
```

### Решение 3: Унифицировать структуру репозитория

Рекомендуется привести структуру репозитория к единому формату во всех ветках, чтобы избежать подобных проблем в будущем.

### Решение 4: Добавить логирование для диагностики

Добавить дополнительное логирование для отслеживания процесса определения путей и диагностики проблем:

```go
l.Debug("Проверка пути к файлам конфигурации",
    slog.String("expected_path", sourcePath),
    slog.String("exists", fmt.Sprintf("%v", exists(sourcePath))),
    slog.String("branch", cfg.Branch))
```

## Заключение

Основная проблема заключается в несоответствии структуры репозитория в разных ветках и неправильной проверке успешного создания базы данных. Рекомендуется внедрить предложенные решения для повышения надежности процесса сборки конфигурации из исходных файлов.