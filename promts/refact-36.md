# Функциональные требования: ActionMenuBuild

## 1. Общие требования

### 1.1. Назначение функции
Функция ActionMenuBuild должна быть добавлена в модуль app для автоматического управления файлами GitHub Actions на основе конфигурации проекта.

### 1.2. Ограничения реализации
- 1.2.1. Использовать исключительно Gitea API для работы с репозиторием
- 1.2.2. Клонирование репозитория локально запрещено
- 1.2.3. Все шаблоны должны храниться в константах модуля constants с использованием raw string literals

## 2. Проверка изменений project.yaml

### 2.1. Определение ветки по умолчанию
- 2.1.1. Получить информацию о ветке по умолчанию через Gitea API
- 2.1.2. Использовать полученную информацию для последующих операций

### 2.2. Анализ последнего коммита
- 2.2.1. Получить информацию о последнем коммите в ветку по умолчанию
- 2.2.2. Проверить, был ли изменен файл project.yaml в данном коммите
- 2.2.3. Если файл не был изменен, вывести в лог сообщение "Файл project.yaml не изменился" и продолжить выполнение

## 3. Анализ конфигурации проекта

### 3.1. Загрузка конфигурации
- 3.1.1. Проанализировать содержимое Config.ProjectConfig
- 3.1.2. Валидировать данные конфигурации
- 3.1.3. При обнаружении некорректных данных возвращать описательные ошибки

### 3.2. Извлечение данных для шаблонов
- 3.2.1. Извлечь список тестовых баз из Config.ProjectConfig.Prod.<Имя прод базы>.related
- 3.2.2. Извлечь список продуктивных баз из Config.ProjectConfig.Prod.<Имя прод базы>
- 3.2.3. Подготовить данные в формате, необходимом для генерации шаблонов

## 4. Управление существующими файлами Actions

### 4.1. Получение списка текущих файлов
- 4.1.1. Получить список файлов из каталога .gitea/workflows через Gitea API
- 4.1.2. Добавить имена файлов в массив CurrentActions типа []string
- 4.1.3. Исключить из списка файл с именем из константы ActionMenuBuildName

### 4.2. Константа ActionMenuBuildName
- 4.2.1. Разместить константу ActionMenuBuildName в модуле constants
- 4.2.2. Расположить рядом с другими константами действий

## 5. Генерация содержимого файлов

### 5.1. Хранение шаблонов
- 5.1.1. Хранить все шаблоны в константах модуля constants
- 5.1.2. Использовать raw string literals для избежания проблем с экранированием
- 5.1.3. Обеспечить централизованное управление шаблонами

### 5.2. Парсинг имен файлов
- 5.2.1. Использовать регулярное выражение для извлечения имени файла из первой строки шаблона после символа '#'
- 5.2.2. Извлекать все символы, включая цифры и точки
- 5.2.3. Обеспечить надежность и производительность парсинга

### 5.3. Генерация содержимого
- 5.3.1. Использовать text/template из стандартной библиотеки Go
- 5.3.2. Подставлять данные из Config.ProjectConfig в соответствующие места шаблонов
- 5.3.3. Генерировать содержимое для каждого типа файла согласно шаблонам

## 6. Шаблоны файлов

### 6.1. Шаблон "1. Обновление тестовых баз.yaml"
- 6.1.1. Содержать workflow_dispatch триггер с параметрами:
  - restore_DB (boolean, default: false)
  - service_mode_enable (boolean, default: true)
  - load_cfg (boolean, default: true)
  - DbName (choice, options из Config.ProjectConfig.Prod.<Имя прод базы>.related)
  - update_conf (boolean, default: true)
- 6.1.2. Включать шаги: восстановление БД, включение сервисного режима, загрузка конфигурации, применение конфигурации, отключение сервисного режима
- 6.1.3. Использовать runner 'edt' и apk-ci action

### 6.2. Шаблон "2. Обновление прод баз.yaml"
- 6.2.1. Содержать workflow_dispatch триггер с параметрами:
  - service_mode_enable (boolean, default: true)
  - load_cfg (boolean, default: true)
  - DbName (choice, options из Config.ProjectConfig.Prod в формате "<dbName> (<key>)")
  - update_conf (boolean, default: true)
- 6.2.2. Включать шаги: включение сервисного режима, загрузка конфигурации, применение конфигурации, отключение сервисного режима
- 6.2.3. Использовать runner 'edt' и apk-ci action

### 6.3. Шаблон "авто. Конвертация и перенос в хранилище.yaml"
- 6.3.1. Содержать статический шаблон без изменений
- 6.3.2. Триггер: release с типом published
- 6.3.3. Шаги: конвертация и перенос в хранилище

## 7. Создание и обновление файлов

### 7.1. Создание новых файлов
- 7.1.1. Создать файлы в каталоге .gitea/workflows через Gitea API
- 7.1.2. Использовать имена файлов, извлеченные из первой строки шаблонов
- 7.1.3. Записать сгенерированное содержимое в соответствующие файлы

### 7.2. Удаление устаревших файлов
- 7.2.1. Сравнить массив CurrentActions с именами файлов из новых шаблонов
- 7.2.2. Удалить файлы, имена которых не совпадают с именами из шаблонов
- 7.2.3. Обеспечить безопасность и предсказуемость операции удаления

## 8. Коммит изменений

### 8.1. Формирование сообщения коммита
- 8.1.1. Создать сообщение в формате:
```
Обновление файлов actions на основании файла проекта:
<Содержимое файла project.yaml без строк с комментариями и пустых строк>
```
- 8.1.2. Исключить из содержимого project.yaml строки, начинающиеся с '#' и пустые строки

### 8.2. Выполнение коммита
- 8.2.1. Зафиксировать все изменения в репозитории через Gitea API
- 8.2.2. Использовать сформированное сообщение коммита

## 9. Обработка ошибок

### 9.1. Стратегия обработки ошибок
- 9.1.1. Возвращать wrapped errors с контекстом для всех операций
- 9.1.2. Логировать детали ошибок для облегчения отладки
- 9.1.3. Следовать идиомам Go при обработке ошибок

### 9.2. Типы ошибок
- 9.2.1. Ошибки валидации конфигурации
- 9.2.2. Ошибки работы с Gitea API
- 9.2.3. Ошибки парсинга шаблонов
- 9.2.4. Ошибки генерации содержимого

## 10. Архитектурные требования

### 10.1. Структура функции
- 10.1.1. Разбить функцию ActionMenuBuild на несколько приватных функций по ответственности
- 10.1.2. Обеспечить читаемость и тестируемость кода
- 10.1.3. Следовать принципам единственной ответственности

### 10.2. Зависимости
- 10.2.1. Использовать минимальный набор внешних зависимостей
- 10.2.2. Предпочитать стандартную библиотеку Go
- 10.2.3. Использовать существующие модули проекта для работы с Gitea API

